<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3TZHCPSK23"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3TZHCPSK23');
    </script>
    <meta name="theme-color" content="#F97316">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ListNest">
    <meta name="description" content="ListNest - הקן המשפחתי לרשימות קניות חכמות עם שיתוף בזמן אמת">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <title>ListNest - רשימת קניות משפחתית חכמה</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        * { font-family: 'Heebo', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .dark .glass { background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-bg { background: linear-gradient(135deg, #F97316 0%, #FB923C 50%, #FBBF24 100%); }
        .dark .gradient-bg { background: linear-gradient(135deg, #7C2D12 0%, #9A3412 50%, #B45309 100%); }
        .btn-gradient { background: linear-gradient(135deg, #F97316 0%, #FB923C 100%); }
        .btn-gradient:hover { background: linear-gradient(135deg, #EA580C 0%, #F97316 100%); transform: translateY(-2px); box-shadow: 0 10px 40px rgba(249, 115, 22, 0.4); }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px) scale(1.02); }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .float { animation: float 3s ease-in-out infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .shimmer { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); background-size: 200% 100%; animation: shimmer 2s infinite; }
        .progress-animate { background: linear-gradient(90deg, #F97316, #FB923C, #FBBF24, #FB923C, #F97316); background-size: 200% 100%; animation: shimmer 2s linear infinite; }
        .text-gradient { background: linear-gradient(135deg, #F97316 0%, #FBBF24 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        input:focus { outline: none; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.3); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.5); }

        /* Swipe gesture styles - Enhanced */
        .swipe-container { position: relative; overflow: hidden; touch-action: pan-y pinch-zoom; border-radius: 16px; }
        .swipe-background { position: absolute; top: 0; bottom: 0; width: 100%; display: flex; align-items: center; padding: 0 24px; border-radius: 16px; }
        .swipe-bg-right { right: 0; justify-content: flex-start; background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .swipe-bg-left { left: 0; justify-content: flex-end; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .swipe-content { position: relative; z-index: 2; background: inherit; transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
        .swipe-content.swiping { transition: none; }
        .swipe-indicator { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .swipe-icon { color: white; font-size: 1.25rem; font-weight: 700; opacity: 0; transform: scale(0.5) translateY(10px); transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
        .swipe-icon.visible { opacity: 1; transform: scale(1) translateY(0); }
        .swipe-icon-emoji { font-size: 1.75rem; }

        /* Modern Product Card */
        .product-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dark .product-card {
            background: rgba(31, 41, 55, 0.95);
            border-color: rgba(255, 255, 255, 0.08);
        }
        .product-card:active { transform: scale(0.98); }
        .product-card.purchased {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.15) 100%);
            border-color: rgba(16, 185, 129, 0.3);
        }
        .dark .product-card.purchased {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.2) 100%);
        }

        /* Micro animations - All under 200ms */
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeSlideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-8px); }
        }
        @keyframes expandIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes checkBounce {
            0% { transform: scale(0); }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        @keyframes checkPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        @keyframes successGlow {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5); }
            100% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes slideOutLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes ripple {
            to { transform: scale(2); opacity: 0; }
        }
        .fade-slide-in { animation: fadeSlideIn 0.15s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .expand-in { animation: expandIn 0.15s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .check-animate { animation: checkBounce 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .check-pop { animation: checkPop 0.15s ease; }
        .success-glow { animation: successGlow 0.4s ease forwards; }
        .slide-out-right { animation: slideOutRight 0.2s ease forwards; }
        .slide-out-left { animation: slideOutLeft 0.2s ease forwards; }

        /* Sticky Add Bar */
        .sticky-add-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            z-index: 40;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
        }
        .dark .sticky-add-bar {
            background: rgba(17, 24, 39, 0.95);
            border-color: rgba(255, 255, 255, 0.08);
        }

        /* Inline edit input */
        .inline-edit-input {
            background: transparent;
            border: none;
            outline: none;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            width: 100%;
            padding: 0;
        }
        .inline-edit-input:focus {
            background: rgba(99, 102, 241, 0.1);
            border-radius: 6px;
            padding: 2px 6px;
            margin: -2px -6px;
        }

        /* Quantity stepper */
        .qty-stepper {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.04);
            border-radius: 12px;
            overflow: hidden;
        }
        .dark .qty-stepper { background: rgba(255, 255, 255, 0.08); }
        .qty-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.25rem;
            transition: all 0.1s ease;
        }
        .qty-btn:active { transform: scale(0.9); }
        .qty-value {
            min-width: 40px;
            text-align: center;
            font-weight: 700;
            font-size: 0.95rem;
        }

        /* Bottom spacing for sticky bar */
        .main-content-with-sticky { padding-bottom: 90px; }

        /* Confetti */
        @keyframes particleFly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx, 50px), var(--ty, -50px)) scale(0); opacity: 0; }
        }
        .confetti-particle { position: absolute; pointer-events: none; animation: particleFly 0.5s ease-out forwards; }

        /* Voice recognition styles */
        @keyframes voicePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); }
        }
        .voice-listening { animation: voicePulse 1.5s ease-in-out infinite; }
        @keyframes soundWave {
            0% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
            100% { transform: scaleY(0.3); }
        }
        .sound-wave { display: inline-block; width: 3px; height: 20px; background: currentColor; margin: 0 1px; border-radius: 3px; animation: soundWave 0.5s ease-in-out infinite; }
        .sound-wave:nth-child(2) { animation-delay: 0.1s; }
        .sound-wave:nth-child(3) { animation-delay: 0.2s; }
        .sound-wave:nth-child(4) { animation-delay: 0.3s; }
        .sound-wave:nth-child(5) { animation-delay: 0.4s; }

        /* Accessibility styles */
        .high-contrast { filter: contrast(1.4); }
        .high-contrast * { border-color: #000 !important; }
        .low-contrast { filter: contrast(0.8); }
        .highlight-links a, .highlight-links button { outline: 3px solid #0066cc !important; outline-offset: 2px; }
        .cursor-large-black, .cursor-large-black * { cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='M4 0l16 12.279-6.78 1.138 4.256 8.676-3.902 1.907-4.256-8.676-5.318 4.676z'/%3E%3C/svg%3E"), auto !important; }
        .cursor-large-white, .cursor-large-white * { cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' stroke='%23000' stroke-width='1' d='M4 0l16 12.279-6.78 1.138 4.256 8.676-3.902 1.907-4.256-8.676-5.318 4.676z'/%3E%3C/svg%3E"), auto !important; }

        /* WCAG 2.4.7 Focus Visible - Enhanced focus indicators */
        *:focus { outline: 3px solid #6366f1 !important; outline-offset: 2px !important; }
        *:focus:not(:focus-visible) { outline: none !important; }
        *:focus-visible { outline: 3px solid #6366f1 !important; outline-offset: 2px !important; box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.3) !important; }
        button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible { outline: 3px solid #6366f1 !important; outline-offset: 2px !important; }
        .dark *:focus-visible { outline-color: #818cf8 !important; box-shadow: 0 0 0 6px rgba(129, 140, 248, 0.3) !important; }

        /* Skip link for 2.4.1 Bypass Blocks */
        .skip-link { position: absolute; top: -100px; left: 50%; transform: translateX(-50%); background: #6366f1; color: white; padding: 12px 24px; border-radius: 0 0 8px 8px; z-index: 99999; font-weight: bold; text-decoration: none; transition: top 0.3s; }
        .skip-link:focus { top: 0; }

        /* Screen reader only content */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

        /* 2.5.5 Target Size - Minimum 44x44px touch targets */
        .touch-target { min-width: 44px; min-height: 44px; }

        /* Accessibility button */
        .accessibility-btn {
            position: fixed;
            bottom: 100px;
            left: 16px;
            width: 50px;
            height: 50px;
            background: #0066cc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
            z-index: 9999;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .accessibility-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0, 102, 204, 0.5); }
        .accessibility-btn svg { width: 30px; height: 30px; fill: white; }

        /* Onboarding styles */
        .onboarding-highlight {
            position: relative;
            z-index: 10001;
            box-shadow: 0 0 0 4px #6366f1, 0 0 20px rgba(99, 102, 241, 0.5);
            border-radius: 12px;
        }
    </style>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDocs, where, serverTimestamp, arrayUnion, arrayRemove, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            sendPasswordResetEmail
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD3pwFMmo4mMjxgzUz5oPynt0D68Yy3Iz0",
            authDomain: "shooping-list-d846b.firebaseapp.com",
            projectId: "shooping-list-d846b",
            storageBucket: "shooping-list-d846b.firebasestorage.app",
            messagingSenderId: "1099114666122",
            appId: "1:1099114666122:web:5c704bf2da52aa3ca63573"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.firestore = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDocs, where, serverTimestamp, arrayUnion, arrayRemove, getDoc, setDoc };
        window.firebaseAuth = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            sendPasswordResetEmail
        };
    </script>
</head>
<body>
    <!-- WCAG 2.4.1 Skip Link -->
    <a href="#main-content" class="skip-link">דלג לתוכן הראשי</a>

    <!-- WCAG 4.1.3 Status Messages - Live Region for announcements -->
    <div id="aria-live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>
    <div id="aria-live-assertive" aria-live="assertive" aria-atomic="true" class="sr-only"></div>

    <div id="root"></div>
    <script>
        // Global error handler for debugging
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            document.getElementById('root').innerHTML = '<div style="padding:20px;direction:rtl;font-family:Heebo,sans-serif;"><h2 style="color:red;">שגיאה:</h2><pre style="background:#f5f5f5;padding:10px;overflow:auto;font-size:12px;">' + msg + '\nLine: ' + lineNo + '</pre><button onclick="location.reload()" style="padding:10px 20px;margin-top:10px;">נסה שוב</button></div>';
            return false;
        };
    </script>
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;

        // Auth Context
        const AuthContext = createContext(null);

        function AuthProvider({ children }) {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = window.firebaseAuth.onAuthStateChanged(window.auth, (user) => {
                    setUser(user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const value = { user, loading };
            return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
        }

        function useAuth() {
            return useContext(AuthContext);
        }

        // Multi-language Support
        const TRANSLATIONS = {
            he: {
                // App name & general
                appName: 'ListNest',
                loading: 'טוען...',
                save: 'שמור',
                cancel: 'ביטול',
                delete: 'מחק',
                edit: 'ערוך',
                close: 'סגור',
                back: 'חזור',
                yes: 'כן',
                no: 'לא',
                search: 'חיפוש',
                add: 'הוסף',
                remove: 'הסר',
                // Auth
                welcome: 'ברוך הבא',
                login: 'התחברות',
                register: 'הרשמה',
                logout: 'התנתק',
                email: 'אימייל',
                password: 'סיסמה',
                confirmPassword: 'אימות סיסמה',
                fullName: 'שם מלא',
                forgotPassword: 'שכחתי סיסמה',
                resetPassword: 'איפוס סיסמה',
                sendResetLink: 'שלח קישור לאיפוס',
                noAccount: 'אין לך חשבון?',
                haveAccount: 'יש לך חשבון?',
                registerNow: 'הירשם עכשיו',
                loginNow: 'התחבר עכשיו',
                orContinueWith: 'או המשך עם',
                // Family
                family: 'משפחה',
                createFamily: 'צור משפחה חדשה',
                joinFamily: 'הצטרף למשפחה קיימת',
                familyName: 'שם המשפחה',
                familyCode: 'קוד משפחה',
                inviteCode: 'קוד הזמנה',
                shareCode: 'שתף את הקוד עם בני משפחה להצטרפות',
                familyMembers: 'חברי המשפחה',
                leaveFamily: 'עזוב משפחה',
                deleteFamily: 'מחק משפחה',
                removeMember: 'הסר חבר',
                shareWithFamily: 'שתף עם המשפחה',
                shareOptions: 'אפשרויות שיתוף',
                copyLink: 'העתק קישור',
                scanQR: 'סרקו את הקוד או שתפו בכל דרך שנוחה לכם',
                // Roles
                selectRole: 'התפקיד שלך במשפחה',
                father: 'אבא',
                mother: 'אמא',
                child: 'ילד/ה',
                admin: 'מנהל',
                limited: 'מוגבל',
                childPermissions: 'ילדים יכולים להוסיף ולסמן מוצרים, אך לא לערוך את המשפחה',
                // Shopping
                shoppingList: 'רשימת קניות',
                addProduct: 'הוסף מוצר',
                searchProduct: 'חיפוש מוצר',
                noItems: 'הרשימה ריקה',
                addItemsHint: 'הוסף מוצרים בשורת החיפוש למטה',
                markAsPurchased: 'סמן כנקנה',
                purchased: 'נקנה',
                notPurchased: 'לא נקנה',
                quantity: 'כמות',
                unit: 'יחידה',
                note: 'הערה',
                addNote: 'הוסף הערה',
                postpone: 'דחה לסוף',
                // Categories
                categories: 'קטגוריות',
                backToCategories: 'חזרה לקטגוריות',
                allProducts: 'כל המוצרים',
                // Lists
                lists: 'רשימות',
                newList: 'רשימה חדשה',
                savedLists: 'רשימות שמורות',
                saveList: 'שמור רשימה',
                loadList: 'טען לעגלה',
                noSavedLists: 'אין רשימות שמורות',
                // Shopping mode
                shoppingMode: 'מצב קניות',
                shoppingModeActive: 'מצב קניות פעיל - המסך לא יכבה',
                enableShoppingMode: 'הפעל מצב קניות',
                // Finish shopping
                finishShopping: 'סיום קנייה',
                totalAmount: 'סכום כולל',
                uploadReceipt: 'העלה קבלה',
                // History
                history: 'היסטוריה',
                shoppingHistory: 'היסטוריית קניות',
                // Chat
                familyChat: 'צ\'אט משפחתי',
                newMessages: 'הודעות חדשות',
                typeMessage: 'כתוב הודעה...',
                send: 'שלח',
                // Scanning
                scanRecipe: 'סריקת מתכון',
                scanProduct: 'סרוק מוצר',
                takePhoto: 'צלם',
                scanning: 'סורק...',
                identifiedIngredients: 'מרכיבים שזוהו',
                addToCart: 'הוסף לעגלה',
                // Voice
                voiceInput: 'הקלטה קולית',
                startRecording: 'התחל הקלטה קולית להוספת מוצרים',
                stopRecording: 'הפסק הקלטה',
                listening: 'מאזין...',
                // Settings
                settings: 'הגדרות',
                darkMode: 'מצב כהה',
                lightMode: 'מצב בהיר',
                language: 'שפה',
                // Help
                help: 'עזרה',
                helpTitle: 'עזרה ומשוב',
                howToUse: 'איך להשתמש באפליקציה',
                howToUseDesc1: 'בחר קטגוריה ולחץ על מוצר להוספה לרשימה',
                howToUseDesc2: 'החלק שמאלה על מוצר לסימון "נקנה"',
                howToUseDesc3: 'החלק ימינה לדחייה לסוף הרשימה',
                howToUseDesc4: 'השתמש בחיפוש למציאת מוצרים מהירה',
                familySharing: 'שיתוף עם המשפחה',
                familySharingDesc1: 'צור משפחה ושתף את הקוד עם בני המשפחה',
                familySharingDesc2: 'כל שינוי מתעדכן בזמן אמת לכל המשפחה',
                familySharingDesc3: 'השתמש בצ\'אט המשפחתי לתקשורת',
                smartScanning: 'סריקה חכמה',
                smartScanningDesc1: 'סרוק מתכון והוסף מרכיבים אוטומטית',
                smartScanningDesc2: 'סרוק מוצר להשוואת מחירים',
                sendFeedback: 'שלח משוב',
                showTutorial: 'הצג הדרכה מחדש',
                // Feedback
                feedback: 'משוב',
                feedbackType: 'סוג המשוב',
                bugReport: 'דיווח על בעיה',
                featureRequest: 'בקשת פיצ\'ר',
                generalFeedback: 'משוב כללי',
                feedbackMessage: 'ההודעה שלך',
                sending: 'שולח...',
                // Accessibility
                accessibility: 'נגישות',
                accessibilitySettings: 'הגדרות נגישות',
                fontSize: 'גודל טקסט',
                normal: 'רגיל',
                large: 'גדול',
                extraLarge: 'גדול מאוד',
                contrast: 'ניגודיות',
                highContrast: 'ניגודיות גבוהה',
                highlightLinks: 'הדגש קישורים',
                cursorSize: 'גודל סמן',
                skipToContent: 'דלג לתוכן הראשי',
                accessibilityStatement: 'הצהרת נגישות',
                // Onboarding
                welcomeTo: 'ברוכים הבאים ל',
                onboardingDesc: 'האפליקציה החכמה לניהול רשימת קניות משפחתית',
                getStarted: 'בואו נתחיל!',
                next: 'הבא',
                skip: 'דלג',
                done: 'סיום',
                addingProducts: 'הוספת מוצרים',
                addingProductsDesc: 'בחרו קטגוריה ולחצו על מוצר להוספה, או חפשו מוצר בשורת החיפוש',
                managingList: 'ניהול הרשימה',
                managingListDesc: 'החליקו שמאלה לסימון כנקנה, ימינה לדחייה. לחצו על כפתור הדחייה לחלופה מקלדת.',
                familySharingTitle: 'שיתוף משפחתי',
                familySharingOnboardDesc: 'שתפו את קוד המשפחה או השתמשו ב-QR/WhatsApp. בחרו תפקיד: הורה (מנהל) או ילד (מוגבל).',
                readyToShop: 'מוכנים לקניות!',
                readyToShopDesc: 'עכשיו אתם מוכנים להתחיל. השתמשו בכל הפיצ\'רים והפכו את הקניות לחוויה משפחתית!',
                // Notifications
                productAdded: 'מוצר נוסף לרשימה',
                addedBy: 'הוסיף/ה',
                // Errors
                error: 'שגיאה',
                tryAgain: 'נסה שוב',
                invalidEmail: 'אימייל לא תקין',
                passwordTooShort: 'הסיסמה חייבת להכיל לפחות 6 תווים',
                passwordsNoMatch: 'הסיסמאות לא תואמות',
                codeNotFound: 'קוד לא נמצא',
                alreadyMember: 'כבר חבר במשפחה זו',
                selectRoleError: 'נא לבחור תפקיד במשפחה',
                enterFamilyName: 'נא להזין שם למשפחה',
                enterCode: 'נא להזין קוד בן 6 תווים',
                // Additional UI strings
                sent: 'נשלח!',
                resetLinkSent: 'קישור לאיפוס סיסמה נשלח ל-',
                checkSpam: 'בדוק גם בתיקיית הספאם',
                backToLogin: 'חזור להתחברות',
                enterEmailForReset: 'הזן את כתובת האימייל שלך ונשלח לך קישור לאיפוס',
                displayName: 'שם תצוגה',
                displayNamePlaceholder: 'השם שיוצג באפליקציה',
                minChars: 'לפחות 6 תווים',
                reenterPassword: 'הזן שוב את הסיסמה',
                enterDisplayName: 'נא להזין שם תצוגה',
                smartShoppingList: 'רשימת הקניות החכמה שלך',
                // Main app UI
                recipes: 'מתכונים',
                whatsapp: 'WhatsApp',
                importList: 'ייבוא רשימה',
                exportList: 'ייצוא רשימה',
                deleteAll: 'מחק הכל',
                whatForgot: 'מה שכחתי?',
                calendar: 'לוח שנה',
                shoppingProgress: 'התקדמות קנייה',
                itemsPurchased: 'פריטים נקנו',
                markPurchased: 'סמן מוצרים שקנית',
                allPurchased: 'כל המוצרים נקנו!',
                purchases: 'קניות',
                deleteAllTitle: 'מחיקת כל הרשימה',
                deleteAllConfirm: 'האם אתה בטוח שברצונך למחוק את כל המוצרים?',
                deleteAllWarning: 'פעולה זו תמחק {count} מוצרים ולא ניתן לבטלה!',
                deleteProduct: 'מחיקת מוצר',
                deleteProductConfirm: 'האם אתה בטוח שברצונך למחוק מוצר זה?',
                addProductPlaceholder: 'הוסף מוצר...',
                // Categories
                fruitsVeg: 'פירות וירקות',
                dairyProducts: 'מוצרי חלב',
                dairyDesserts: 'מעדני חלב',
                meatFish: 'בשר ודגים',
                deli: 'מעדניית נקניקים',
                breadBakery: 'לחם ומאפים',
                spreads: 'ממרחים',
                bakingProducts: 'מוצרי אפיה',
                cereals: 'דגנים וקורנפלקס',
                cannedDry: 'שימורים ומזון יבש',
                spices: 'תבלינים ובישול',
                coffeeTea: 'קפה ותה',
                drinks: 'משקאות קלים',
                wineAlcohol: 'יין ואלכוהול',
                snacks: 'חטיפים וממתקים',
                frozen: 'קפואים',
                dietProtein: 'דיאטה וחלבון',
                hygiene: 'היגיינה ורחצה',
                cleaning: 'ניקיון',
                candlesOil: 'נרות ושמן',
                babyKids: 'תינוקות וילדים',
                pets: 'חיות מחמד',
                readySalads: 'סלטים מוכנים',
                // More UI strings
                searchAddProduct: 'הוסף מוצר...',
                emptyList: 'הרשימה ריקה',
                addProductsBelow: 'הוסף מוצרים בשורת החיפוש למטה',
                familyNameExample: 'לדוגמה: משפחת כהן',
                listNameExample: 'לדוגמה: קניות לשבת',
                noteExample: 'לדוגמה: מותג אסם, מהמדף העליון...',
                importExample: 'חלב\nביצים x2\n3 לחם\nגבינה, חמאה',
                productSearchExample: 'לדוגמה: חלב תנובה, קוטג׳, במבה...',
                tagExample: 'לדוגמה: טרי, ללא גלוטן, אורגני...',
                typeMessage: 'הקלד הודעה...',
                recipeNameExample: 'שם המתכון (למשל: עוגת שוקולד)',
                ingredientsExample: 'רשימת מרכיבים (כל מרכיב בשורה חדשה)',
                feedbackPlaceholder: 'ספר לנו מה קרה או מה תרצה לראות...',
                priceComparison: 'השוואת מחירים',
                familySettings: 'הגדרות משפחה',
                createNewFamily: 'צור משפחה חדשה',
                joinExistingFamily: 'הצטרף למשפחה קיימת',
                familyChat: 'צ\'אט משפחתי',
                savedLists: 'רשימות שמורות',
                noSavedLists: 'אין רשימות שמורות',
                loadToCart: 'טען לעגלה',
                bought: 'נקנה',
                later: 'אח״כ',
                addToList: 'הוסף לרשימה',
                removeFromList: 'הסר מהרשימה',
                selectCategory: 'בחר קטגוריה',
                allCategories: 'כל הקטגוריות',
                scanRecipe: 'סריקת מתכון',
                scanProduct: 'סרוק מוצר',
                voiceInput: 'הקלטה קולית',
                importFromWhatsapp: 'ייבוא מווטסאפ',
                regularItems: 'מוצרים קבועים',
                forgottenItems: 'מוצרים שנשכחו',
                shoppingStreak: 'רצף קניות',
                darkMode: 'מצב כהה',
                lightMode: 'מצב בהיר',
                language: 'שפה',
                accessibilitySettings: 'הגדרות נגישות',
                helpAndFeedback: 'עזרה ומשוב',
                showTutorial: 'הצג הדרכה',
                logoutButton: 'התנתקות',
                total: 'סה"כ',
                items: 'פריטים',
                share: 'שתף',
                copy: 'העתק',
                copied: 'הועתק!',
                send: 'שלח',
                confirm: 'אישור',
                selectAll: 'בחר הכל',
                clearAll: 'נקה הכל',
                noProductsFound: 'לא נמצאו מוצרים התואמים',
                tryAnotherSearch: 'נסה חיפוש אחר או בחר קטגוריה',
                noRecipesSaved: 'אין מתכונים שמורים',
                addFirstRecipe: 'הוסף מתכון ראשון',
                noHistoryYet: 'אין היסטוריה עדיין',
                completeFirstShopping: 'סיימו קנייה ראשונה לראות סטטיסטיקה'
            },
            en: {
                // App name & general
                appName: 'Smart Family Shopping List',
                loading: 'Loading...',
                save: 'Save',
                cancel: 'Cancel',
                delete: 'Delete',
                edit: 'Edit',
                close: 'Close',
                back: 'Back',
                yes: 'Yes',
                no: 'No',
                search: 'Search',
                add: 'Add',
                remove: 'Remove',
                // Auth
                welcome: 'Welcome',
                login: 'Login',
                register: 'Register',
                logout: 'Logout',
                email: 'Email',
                password: 'Password',
                confirmPassword: 'Confirm Password',
                fullName: 'Full Name',
                forgotPassword: 'Forgot Password?',
                resetPassword: 'Reset Password',
                sendResetLink: 'Send Reset Link',
                noAccount: "Don't have an account?",
                haveAccount: 'Already have an account?',
                registerNow: 'Register Now',
                loginNow: 'Login Now',
                orContinueWith: 'Or continue with',
                // Family
                family: 'Family',
                createFamily: 'Create New Family',
                joinFamily: 'Join Existing Family',
                familyName: 'Family Name',
                familyCode: 'Family Code',
                inviteCode: 'Invite Code',
                shareCode: 'Share this code with family members to join',
                familyMembers: 'Family Members',
                leaveFamily: 'Leave Family',
                deleteFamily: 'Delete Family',
                removeMember: 'Remove Member',
                shareWithFamily: 'Share with Family',
                shareOptions: 'Share Options',
                copyLink: 'Copy Link',
                scanQR: 'Scan the code or share via any method you prefer',
                // Roles
                selectRole: 'Your role in the family',
                father: 'Father',
                mother: 'Mother',
                child: 'Child',
                admin: 'Admin',
                limited: 'Limited',
                childPermissions: 'Children can add and mark products, but cannot edit family settings',
                // Shopping
                shoppingList: 'Shopping List',
                addProduct: 'Add Product',
                searchProduct: 'Search Product',
                noItems: 'List is empty',
                addItemsHint: 'Add items using the search bar below',
                markAsPurchased: 'Mark as Purchased',
                purchased: 'Purchased',
                notPurchased: 'Not Purchased',
                quantity: 'Quantity',
                unit: 'Unit',
                note: 'Note',
                addNote: 'Add Note',
                postpone: 'Move to End',
                // Categories
                categories: 'Categories',
                backToCategories: 'Back to Categories',
                allProducts: 'All Products',
                // Lists
                lists: 'Lists',
                newList: 'New List',
                savedLists: 'Saved Lists',
                saveList: 'Save List',
                loadList: 'Load to Cart',
                noSavedLists: 'No saved lists',
                // Shopping mode
                shoppingMode: 'Shopping Mode',
                shoppingModeActive: 'Shopping mode active - screen stays on',
                enableShoppingMode: 'Enable Shopping Mode',
                // Finish shopping
                finishShopping: 'Finish Shopping',
                totalAmount: 'Total Amount',
                uploadReceipt: 'Upload Receipt',
                // History
                history: 'History',
                shoppingHistory: 'Shopping History',
                // Chat
                familyChat: 'Family Chat',
                newMessages: 'New Messages',
                typeMessage: 'Type a message...',
                send: 'Send',
                // Scanning
                scanRecipe: 'Scan Recipe',
                scanProduct: 'Scan Product',
                takePhoto: 'Take Photo',
                scanning: 'Scanning...',
                identifiedIngredients: 'Identified Ingredients',
                addToCart: 'Add to Cart',
                // Voice
                voiceInput: 'Voice Input',
                startRecording: 'Start voice recording to add products',
                stopRecording: 'Stop Recording',
                listening: 'Listening...',
                // Settings
                settings: 'Settings',
                darkMode: 'Dark Mode',
                lightMode: 'Light Mode',
                language: 'Language',
                // Help
                help: 'Help',
                helpTitle: 'Help & Feedback',
                howToUse: 'How to use the app',
                howToUseDesc1: 'Select a category and tap a product to add to list',
                howToUseDesc2: 'Swipe left on a product to mark as "purchased"',
                howToUseDesc3: 'Swipe right to move to end of list',
                howToUseDesc4: 'Use search to quickly find products',
                familySharing: 'Family Sharing',
                familySharingDesc1: 'Create a family and share the code with members',
                familySharingDesc2: 'All changes sync in real-time for all family',
                familySharingDesc3: 'Use family chat for communication',
                smartScanning: 'Smart Scanning',
                smartScanningDesc1: 'Scan a recipe to auto-add ingredients',
                smartScanningDesc2: 'Scan a product for price comparison',
                sendFeedback: 'Send Feedback',
                showTutorial: 'Show Tutorial Again',
                // Feedback
                feedback: 'Feedback',
                feedbackType: 'Feedback Type',
                bugReport: 'Bug Report',
                featureRequest: 'Feature Request',
                generalFeedback: 'General Feedback',
                feedbackMessage: 'Your Message',
                sending: 'Sending...',
                // Accessibility
                accessibility: 'Accessibility',
                accessibilitySettings: 'Accessibility Settings',
                fontSize: 'Font Size',
                normal: 'Normal',
                large: 'Large',
                extraLarge: 'Extra Large',
                contrast: 'Contrast',
                highContrast: 'High Contrast',
                highlightLinks: 'Highlight Links',
                cursorSize: 'Cursor Size',
                skipToContent: 'Skip to main content',
                accessibilityStatement: 'Accessibility Statement',
                // Onboarding
                welcomeTo: 'Welcome to',
                onboardingDesc: 'The smart app for managing family shopping lists',
                getStarted: "Let's get started!",
                next: 'Next',
                skip: 'Skip',
                done: 'Done',
                addingProducts: 'Adding Products',
                addingProductsDesc: 'Choose a category and tap a product to add, or search in the search bar',
                managingList: 'Managing the List',
                managingListDesc: 'Swipe left to mark purchased, right to postpone. Use the postpone button for keyboard alternative.',
                familySharingTitle: 'Family Sharing',
                familySharingOnboardDesc: 'Share family code or use QR/WhatsApp. Choose role: parent (admin) or child (limited).',
                readyToShop: 'Ready to Shop!',
                readyToShopDesc: "You're all set! Use all features and make shopping a family experience!",
                // Notifications
                productAdded: 'Product added to list',
                addedBy: 'Added by',
                // Errors
                error: 'Error',
                tryAgain: 'Try Again',
                invalidEmail: 'Invalid email',
                passwordTooShort: 'Password must be at least 6 characters',
                passwordsNoMatch: 'Passwords do not match',
                codeNotFound: 'Code not found',
                alreadyMember: 'Already a member of this family',
                selectRoleError: 'Please select a family role',
                enterFamilyName: 'Please enter a family name',
                enterCode: 'Please enter a 6-character code',
                // Additional UI strings
                sent: 'Sent!',
                resetLinkSent: 'Password reset link sent to',
                checkSpam: 'Check your spam folder too',
                backToLogin: 'Back to login',
                enterEmailForReset: 'Enter your email and we will send you a reset link',
                displayName: 'Display Name',
                displayNamePlaceholder: 'Name shown in app',
                minChars: 'At least 6 characters',
                reenterPassword: 'Re-enter password',
                enterDisplayName: 'Please enter a display name',
                smartShoppingList: 'Your smart shopping list',
                // Main app UI
                recipes: 'Recipes',
                whatsapp: 'WhatsApp',
                importList: 'Import List',
                exportList: 'Export List',
                deleteAll: 'Delete All',
                whatForgot: 'What did I forget?',
                calendar: 'Calendar',
                shoppingProgress: 'Shopping Progress',
                itemsPurchased: 'items purchased',
                markPurchased: 'Mark items as purchased',
                allPurchased: 'All items purchased!',
                purchases: 'purchases',
                deleteAllTitle: 'Delete All Items',
                deleteAllConfirm: 'Are you sure you want to delete all items?',
                deleteAllWarning: 'This will delete {count} items and cannot be undone!',
                deleteProduct: 'Delete Product',
                deleteProductConfirm: 'Are you sure you want to delete this product?',
                addProductPlaceholder: 'Add product...',
                // Categories
                fruitsVeg: 'Fruits & Vegetables',
                dairyProducts: 'Dairy',
                dairyDesserts: 'Dairy Desserts',
                meatFish: 'Meat & Fish',
                deli: 'Deli Sausages',
                breadBakery: 'Bread & Bakery',
                spreads: 'Spreads',
                bakingProducts: 'Baking Products',
                cereals: 'Cereals',
                cannedDry: 'Canned & Dry Foods',
                spices: 'Spices & Cooking',
                coffeeTea: 'Coffee & Tea',
                drinks: 'Soft Drinks',
                wineAlcohol: 'Wine & Alcohol',
                snacks: 'Snacks & Candy',
                frozen: 'Frozen',
                dietProtein: 'Diet & Protein',
                hygiene: 'Hygiene & Bath',
                cleaning: 'Cleaning',
                candlesOil: 'Candles & Oil',
                babyKids: 'Baby & Kids',
                pets: 'Pets',
                readySalads: 'Ready Salads',
                // More UI strings
                searchAddProduct: 'Add product...',
                emptyList: 'List is empty',
                addProductsBelow: 'Add products using the search bar below',
                familyNameExample: 'e.g., The Smith Family',
                listNameExample: 'e.g., Weekend Shopping',
                noteExample: 'e.g., Specific brand, top shelf...',
                importExample: 'Milk\nEggs x2\n3 Bread\nCheese, Butter',
                productSearchExample: 'e.g., milk, cottage cheese, chips...',
                tagExample: 'e.g., Fresh, Gluten-free, Organic...',
                typeMessage: 'Type a message...',
                recipeNameExample: 'Recipe name (e.g., Chocolate Cake)',
                ingredientsExample: 'Ingredient list (each on a new line)',
                feedbackPlaceholder: 'Tell us what happened or what you\'d like to see...',
                priceComparison: 'Price Comparison',
                familySettings: 'Family Settings',
                createNewFamily: 'Create New Family',
                joinExistingFamily: 'Join Existing Family',
                familyChat: 'Family Chat',
                savedLists: 'Saved Lists',
                noSavedLists: 'No saved lists',
                loadToCart: 'Load to Cart',
                bought: 'Bought',
                later: 'Later',
                addToList: 'Add to List',
                removeFromList: 'Remove from List',
                selectCategory: 'Select Category',
                allCategories: 'All Categories',
                scanRecipe: 'Scan Recipe',
                scanProduct: 'Scan Product',
                voiceInput: 'Voice Input',
                importFromWhatsapp: 'Import from WhatsApp',
                regularItems: 'Regular Items',
                forgottenItems: 'Forgotten Items',
                shoppingStreak: 'Shopping Streak',
                darkMode: 'Dark Mode',
                lightMode: 'Light Mode',
                language: 'Language',
                accessibilitySettings: 'Accessibility Settings',
                helpAndFeedback: 'Help & Feedback',
                showTutorial: 'Show Tutorial',
                logoutButton: 'Logout',
                total: 'Total',
                items: 'items',
                share: 'Share',
                copy: 'Copy',
                copied: 'Copied!',
                send: 'Send',
                confirm: 'Confirm',
                selectAll: 'Select All',
                clearAll: 'Clear All',
                noProductsFound: 'No products found matching',
                tryAnotherSearch: 'Try another search or select a category',
                noRecipesSaved: 'No recipes saved',
                addFirstRecipe: 'Add first recipe',
                noHistoryYet: 'No history yet',
                completeFirstShopping: 'Complete your first shopping to see statistics'
            },
            ru: {
                // App name & general
                appName: 'Умный семейный список покупок',
                loading: 'Загрузка...',
                save: 'Сохранить',
                cancel: 'Отмена',
                delete: 'Удалить',
                edit: 'Изменить',
                close: 'Закрыть',
                back: 'Назад',
                yes: 'Да',
                no: 'Нет',
                search: 'Поиск',
                add: 'Добавить',
                remove: 'Удалить',
                // Auth
                welcome: 'Добро пожаловать',
                login: 'Вход',
                register: 'Регистрация',
                logout: 'Выйти',
                email: 'Электронная почта',
                password: 'Пароль',
                confirmPassword: 'Подтверждение пароля',
                fullName: 'Полное имя',
                forgotPassword: 'Забыли пароль?',
                resetPassword: 'Сброс пароля',
                sendResetLink: 'Отправить ссылку для сброса',
                noAccount: 'Нет аккаунта?',
                haveAccount: 'Уже есть аккаунт?',
                registerNow: 'Зарегистрироваться',
                loginNow: 'Войти',
                orContinueWith: 'Или продолжить с',
                // Family
                family: 'Семья',
                createFamily: 'Создать новую семью',
                joinFamily: 'Присоединиться к семье',
                familyName: 'Название семьи',
                familyCode: 'Код семьи',
                inviteCode: 'Код приглашения',
                shareCode: 'Поделитесь этим кодом с членами семьи',
                familyMembers: 'Члены семьи',
                leaveFamily: 'Покинуть семью',
                deleteFamily: 'Удалить семью',
                removeMember: 'Удалить участника',
                shareWithFamily: 'Поделиться с семьёй',
                shareOptions: 'Варианты отправки',
                copyLink: 'Копировать ссылку',
                scanQR: 'Отсканируйте код или поделитесь удобным способом',
                // Roles
                selectRole: 'Ваша роль в семье',
                father: 'Папа',
                mother: 'Мама',
                child: 'Ребёнок',
                admin: 'Администратор',
                limited: 'Ограничено',
                childPermissions: 'Дети могут добавлять и отмечать товары, но не могут редактировать настройки семьи',
                // Shopping
                shoppingList: 'Список покупок',
                addProduct: 'Добавить товар',
                searchProduct: 'Поиск товара',
                noItems: 'Список пуст',
                addItemsHint: 'Добавьте товары через строку поиска ниже',
                markAsPurchased: 'Отметить как купленное',
                purchased: 'Куплено',
                notPurchased: 'Не куплено',
                quantity: 'Количество',
                unit: 'Единица',
                note: 'Заметка',
                addNote: 'Добавить заметку',
                postpone: 'В конец списка',
                // Categories
                categories: 'Категории',
                backToCategories: 'К категориям',
                allProducts: 'Все товары',
                // Lists
                lists: 'Списки',
                newList: 'Новый список',
                savedLists: 'Сохранённые списки',
                saveList: 'Сохранить список',
                loadList: 'Загрузить в корзину',
                noSavedLists: 'Нет сохранённых списков',
                // Shopping mode
                shoppingMode: 'Режим покупок',
                shoppingModeActive: 'Режим покупок активен - экран не выключится',
                enableShoppingMode: 'Включить режим покупок',
                // Finish shopping
                finishShopping: 'Завершить покупки',
                totalAmount: 'Общая сумма',
                uploadReceipt: 'Загрузить чек',
                // History
                history: 'История',
                shoppingHistory: 'История покупок',
                // Chat
                familyChat: 'Семейный чат',
                newMessages: 'Новые сообщения',
                typeMessage: 'Введите сообщение...',
                send: 'Отправить',
                // Scanning
                scanRecipe: 'Сканировать рецепт',
                scanProduct: 'Сканировать товар',
                takePhoto: 'Сделать фото',
                scanning: 'Сканирование...',
                identifiedIngredients: 'Распознанные ингредиенты',
                addToCart: 'В корзину',
                // Voice
                voiceInput: 'Голосовой ввод',
                startRecording: 'Начать запись для добавления товаров',
                stopRecording: 'Остановить запись',
                listening: 'Слушаю...',
                // Settings
                settings: 'Настройки',
                darkMode: 'Тёмный режим',
                lightMode: 'Светлый режим',
                language: 'Язык',
                // Help
                help: 'Помощь',
                helpTitle: 'Помощь и отзывы',
                howToUse: 'Как пользоваться приложением',
                howToUseDesc1: 'Выберите категорию и нажмите на товар для добавления',
                howToUseDesc2: 'Проведите влево по товару для отметки "куплено"',
                howToUseDesc3: 'Проведите вправо для перемещения в конец списка',
                howToUseDesc4: 'Используйте поиск для быстрого поиска товаров',
                familySharing: 'Семейный доступ',
                familySharingDesc1: 'Создайте семью и поделитесь кодом с членами семьи',
                familySharingDesc2: 'Все изменения синхронизируются в реальном времени',
                familySharingDesc3: 'Используйте семейный чат для общения',
                smartScanning: 'Умное сканирование',
                smartScanningDesc1: 'Сканируйте рецепт для автоматического добавления ингредиентов',
                smartScanningDesc2: 'Сканируйте товар для сравнения цен',
                sendFeedback: 'Отправить отзыв',
                showTutorial: 'Показать обучение снова',
                // Feedback
                feedback: 'Отзыв',
                feedbackType: 'Тип отзыва',
                bugReport: 'Сообщить об ошибке',
                featureRequest: 'Предложить функцию',
                generalFeedback: 'Общий отзыв',
                feedbackMessage: 'Ваше сообщение',
                sending: 'Отправка...',
                // Accessibility
                accessibility: 'Доступность',
                accessibilitySettings: 'Настройки доступности',
                fontSize: 'Размер шрифта',
                normal: 'Обычный',
                large: 'Большой',
                extraLarge: 'Очень большой',
                contrast: 'Контраст',
                highContrast: 'Высокий контраст',
                highlightLinks: 'Выделять ссылки',
                cursorSize: 'Размер курсора',
                skipToContent: 'Перейти к содержимому',
                accessibilityStatement: 'Заявление о доступности',
                // Onboarding
                welcomeTo: 'Добро пожаловать в',
                onboardingDesc: 'Умное приложение для управления семейным списком покупок',
                getStarted: 'Начнём!',
                next: 'Далее',
                skip: 'Пропустить',
                done: 'Готово',
                addingProducts: 'Добавление товаров',
                addingProductsDesc: 'Выберите категорию и нажмите на товар, или найдите в поиске',
                managingList: 'Управление списком',
                managingListDesc: 'Проведите влево для отметки, вправо для перемещения. Используйте кнопку для клавиатурной альтернативы.',
                familySharingTitle: 'Семейный доступ',
                familySharingOnboardDesc: 'Поделитесь кодом семьи или используйте QR/WhatsApp. Выберите роль: родитель (админ) или ребёнок (ограничен).',
                readyToShop: 'Готовы к покупкам!',
                readyToShopDesc: 'Всё готово! Используйте все функции и сделайте покупки семейным делом!',
                // Notifications
                productAdded: 'Товар добавлен в список',
                addedBy: 'Добавил(а)',
                // Errors
                error: 'Ошибка',
                tryAgain: 'Попробовать снова',
                invalidEmail: 'Неверный email',
                passwordTooShort: 'Пароль должен содержать минимум 6 символов',
                passwordsNoMatch: 'Пароли не совпадают',
                codeNotFound: 'Код не найден',
                alreadyMember: 'Уже являетесь членом этой семьи',
                selectRoleError: 'Пожалуйста, выберите роль в семье',
                enterFamilyName: 'Пожалуйста, введите название семьи',
                enterCode: 'Пожалуйста, введите 6-значный код',
                // Additional UI strings
                sent: 'Отправлено!',
                resetLinkSent: 'Ссылка для сброса пароля отправлена на',
                checkSpam: 'Проверьте также папку спам',
                backToLogin: 'Вернуться к входу',
                enterEmailForReset: 'Введите email и мы отправим вам ссылку для сброса',
                displayName: 'Отображаемое имя',
                displayNamePlaceholder: 'Имя в приложении',
                minChars: 'Минимум 6 символов',
                reenterPassword: 'Повторите пароль',
                enterDisplayName: 'Пожалуйста, введите отображаемое имя',
                smartShoppingList: 'Ваш умный список покупок',
                // Main app UI
                recipes: 'Рецепты',
                whatsapp: 'WhatsApp',
                importList: 'Импорт списка',
                exportList: 'Экспорт списка',
                deleteAll: 'Удалить все',
                whatForgot: 'Что забыл?',
                calendar: 'Календарь',
                shoppingProgress: 'Прогресс покупок',
                itemsPurchased: 'куплено',
                markPurchased: 'Отметьте купленные товары',
                allPurchased: 'Все товары куплены!',
                purchases: 'покупки',
                deleteAllTitle: 'Удалить все товары',
                deleteAllConfirm: 'Вы уверены, что хотите удалить все товары?',
                deleteAllWarning: 'Это удалит {count} товаров без возможности восстановления!',
                deleteProduct: 'Удалить товар',
                deleteProductConfirm: 'Вы уверены, что хотите удалить этот товар?',
                addProductPlaceholder: 'Добавить товар...',
                // More UI strings
                searchAddProduct: 'Добавить товар...',
                emptyList: 'Список пуст',
                addProductsBelow: 'Добавьте товары через поиск ниже',
                familyNameExample: 'например: Семья Ивановых',
                listNameExample: 'например: Покупки на выходные',
                noteExample: 'например: Определенный бренд, верхняя полка...',
                priceComparison: 'Сравнение цен',
                familySettings: 'Настройки семьи',
                createNewFamily: 'Создать новую семью',
                joinExistingFamily: 'Присоединиться к семье',
                familyChat: 'Семейный чат',
                savedLists: 'Сохраненные списки',
                noSavedLists: 'Нет сохраненных списков',
                loadToCart: 'Загрузить в корзину',
                bought: 'Куплено',
                later: 'Позже',
                addToList: 'Добавить в список',
                removeFromList: 'Удалить из списка',
                selectCategory: 'Выберите категорию',
                allCategories: 'Все категории',
                scanRecipe: 'Сканировать рецепт',
                scanProduct: 'Сканировать товар',
                voiceInput: 'Голосовой ввод',
                importFromWhatsapp: 'Импорт из WhatsApp',
                regularItems: 'Постоянные товары',
                forgottenItems: 'Забытые товары',
                shoppingStreak: 'Серия покупок',
                darkMode: 'Темный режим',
                lightMode: 'Светлый режим',
                language: 'Язык',
                accessibilitySettings: 'Настройки доступности',
                helpAndFeedback: 'Помощь и отзывы',
                showTutorial: 'Показать обучение',
                logoutButton: 'Выйти',
                total: 'Всего',
                items: 'товаров',
                share: 'Поделиться',
                copy: 'Копировать',
                copied: 'Скопировано!',
                send: 'Отправить',
                confirm: 'Подтвердить',
                selectAll: 'Выбрать все',
                clearAll: 'Очистить все',
                readySalads: 'Готовые салаты',
                deli: 'Колбасный отдел',
                noProductsFound: 'Не найдено товаров по запросу',
                tryAnotherSearch: 'Попробуйте другой поиск или выберите категорию',
                noRecipesSaved: 'Нет сохраненных рецептов',
                addFirstRecipe: 'Добавить первый рецепт',
                noHistoryYet: 'Истории пока нет',
                completeFirstShopping: 'Завершите первую покупку, чтобы увидеть статистику'
            },
            ar: {
                // App name & general
                appName: 'قائمة التسوق العائلية الذكية',
                loading: 'جاري التحميل...',
                save: 'حفظ',
                cancel: 'إلغاء',
                delete: 'حذف',
                edit: 'تعديل',
                close: 'إغلاق',
                back: 'رجوع',
                yes: 'نعم',
                no: 'لا',
                search: 'بحث',
                add: 'إضافة',
                remove: 'إزالة',
                // Auth
                welcome: 'مرحباً',
                login: 'تسجيل الدخول',
                register: 'تسجيل',
                logout: 'تسجيل الخروج',
                email: 'البريد الإلكتروني',
                password: 'كلمة المرور',
                confirmPassword: 'تأكيد كلمة المرور',
                fullName: 'الاسم الكامل',
                forgotPassword: 'نسيت كلمة المرور؟',
                resetPassword: 'إعادة تعيين كلمة المرور',
                sendResetLink: 'إرسال رابط إعادة التعيين',
                noAccount: 'ليس لديك حساب؟',
                haveAccount: 'لديك حساب بالفعل؟',
                registerNow: 'سجل الآن',
                loginNow: 'سجل دخول الآن',
                orContinueWith: 'أو تابع مع',
                // Family
                family: 'العائلة',
                createFamily: 'إنشاء عائلة جديدة',
                joinFamily: 'الانضمام لعائلة موجودة',
                familyName: 'اسم العائلة',
                familyCode: 'رمز العائلة',
                inviteCode: 'رمز الدعوة',
                shareCode: 'شارك هذا الرمز مع أفراد العائلة للانضمام',
                familyMembers: 'أفراد العائلة',
                leaveFamily: 'مغادرة العائلة',
                deleteFamily: 'حذف العائلة',
                removeMember: 'إزالة عضو',
                shareWithFamily: 'مشاركة مع العائلة',
                shareOptions: 'خيارات المشاركة',
                copyLink: 'نسخ الرابط',
                scanQR: 'امسح الرمز أو شارك بأي طريقة تفضلها',
                // Roles
                selectRole: 'دورك في العائلة',
                father: 'أب',
                mother: 'أم',
                child: 'طفل',
                admin: 'مدير',
                limited: 'محدود',
                childPermissions: 'يمكن للأطفال إضافة المنتجات وتحديدها، لكن لا يمكنهم تعديل إعدادات العائلة',
                // Shopping
                shoppingList: 'قائمة التسوق',
                addProduct: 'إضافة منتج',
                searchProduct: 'بحث عن منتج',
                noItems: 'القائمة فارغة',
                addItemsHint: 'أضف منتجات من شريط البحث أدناه',
                markAsPurchased: 'تحديد كمشترى',
                purchased: 'تم الشراء',
                notPurchased: 'لم يتم الشراء',
                quantity: 'الكمية',
                unit: 'الوحدة',
                note: 'ملاحظة',
                addNote: 'إضافة ملاحظة',
                postpone: 'نقل للنهاية',
                // Categories
                categories: 'الفئات',
                backToCategories: 'العودة للفئات',
                allProducts: 'جميع المنتجات',
                // Lists
                lists: 'القوائم',
                newList: 'قائمة جديدة',
                savedLists: 'القوائم المحفوظة',
                saveList: 'حفظ القائمة',
                loadList: 'تحميل للسلة',
                noSavedLists: 'لا توجد قوائم محفوظة',
                // Shopping mode
                shoppingMode: 'وضع التسوق',
                shoppingModeActive: 'وضع التسوق نشط - الشاشة لن تنطفئ',
                enableShoppingMode: 'تفعيل وضع التسوق',
                // Finish shopping
                finishShopping: 'إنهاء التسوق',
                totalAmount: 'المبلغ الإجمالي',
                uploadReceipt: 'رفع الفاتورة',
                // History
                history: 'السجل',
                shoppingHistory: 'سجل التسوق',
                // Chat
                familyChat: 'دردشة العائلة',
                newMessages: 'رسائل جديدة',
                typeMessage: 'اكتب رسالة...',
                send: 'إرسال',
                // Scanning
                scanRecipe: 'مسح الوصفة',
                scanProduct: 'مسح المنتج',
                takePhoto: 'التقط صورة',
                scanning: 'جاري المسح...',
                identifiedIngredients: 'المكونات المحددة',
                addToCart: 'إضافة للسلة',
                // Voice
                voiceInput: 'الإدخال الصوتي',
                startRecording: 'ابدأ التسجيل الصوتي لإضافة منتجات',
                stopRecording: 'إيقاف التسجيل',
                listening: 'جاري الاستماع...',
                // Settings
                settings: 'الإعدادات',
                darkMode: 'الوضع الداكن',
                lightMode: 'الوضع الفاتح',
                language: 'اللغة',
                // Help
                help: 'مساعدة',
                helpTitle: 'المساعدة والملاحظات',
                howToUse: 'كيفية استخدام التطبيق',
                howToUseDesc1: 'اختر فئة واضغط على منتج لإضافته للقائمة',
                howToUseDesc2: 'اسحب لليسار على منتج لتحديده كـ "مشترى"',
                howToUseDesc3: 'اسحب لليمين لنقله لنهاية القائمة',
                howToUseDesc4: 'استخدم البحث للعثور على المنتجات بسرعة',
                familySharing: 'المشاركة العائلية',
                familySharingDesc1: 'أنشئ عائلة وشارك الرمز مع الأفراد',
                familySharingDesc2: 'جميع التغييرات تتزامن في الوقت الفعلي',
                familySharingDesc3: 'استخدم دردشة العائلة للتواصل',
                smartScanning: 'المسح الذكي',
                smartScanningDesc1: 'امسح وصفة لإضافة المكونات تلقائياً',
                smartScanningDesc2: 'امسح منتج لمقارنة الأسعار',
                sendFeedback: 'إرسال ملاحظات',
                showTutorial: 'عرض الشرح مجدداً',
                // Feedback
                feedback: 'ملاحظات',
                feedbackType: 'نوع الملاحظة',
                bugReport: 'الإبلاغ عن مشكلة',
                featureRequest: 'طلب ميزة',
                generalFeedback: 'ملاحظات عامة',
                feedbackMessage: 'رسالتك',
                sending: 'جاري الإرسال...',
                // Accessibility
                accessibility: 'إمكانية الوصول',
                accessibilitySettings: 'إعدادات إمكانية الوصول',
                fontSize: 'حجم الخط',
                normal: 'عادي',
                large: 'كبير',
                extraLarge: 'كبير جداً',
                contrast: 'التباين',
                highContrast: 'تباين عالي',
                highlightLinks: 'تمييز الروابط',
                cursorSize: 'حجم المؤشر',
                skipToContent: 'تخطي إلى المحتوى الرئيسي',
                accessibilityStatement: 'بيان إمكانية الوصول',
                // Onboarding
                welcomeTo: 'مرحباً بك في',
                onboardingDesc: 'التطبيق الذكي لإدارة قائمة تسوق العائلة',
                getStarted: 'هيا نبدأ!',
                next: 'التالي',
                skip: 'تخطي',
                done: 'تم',
                addingProducts: 'إضافة المنتجات',
                addingProductsDesc: 'اختر فئة واضغط على منتج، أو ابحث في شريط البحث',
                managingList: 'إدارة القائمة',
                managingListDesc: 'اسحب لليسار للتحديد، لليمين للتأجيل. استخدم زر التأجيل كبديل للوحة المفاتيح.',
                familySharingTitle: 'المشاركة العائلية',
                familySharingOnboardDesc: 'شارك رمز العائلة أو استخدم QR/WhatsApp. اختر دورك: والد (مدير) أو طفل (محدود).',
                readyToShop: 'جاهز للتسوق!',
                readyToShopDesc: 'أنت جاهز الآن! استخدم جميع الميزات واجعل التسوق تجربة عائلية!',
                // Notifications
                productAdded: 'تمت إضافة منتج للقائمة',
                addedBy: 'أضافه',
                // Errors
                error: 'خطأ',
                tryAgain: 'حاول مرة أخرى',
                invalidEmail: 'بريد إلكتروني غير صالح',
                passwordTooShort: 'كلمة المرور يجب أن تحتوي على 6 أحرف على الأقل',
                passwordsNoMatch: 'كلمات المرور غير متطابقة',
                codeNotFound: 'الرمز غير موجود',
                alreadyMember: 'أنت عضو بالفعل في هذه العائلة',
                selectRoleError: 'يرجى اختيار دور في العائلة',
                enterFamilyName: 'يرجى إدخال اسم العائلة',
                enterCode: 'يرجى إدخال رمز من 6 أحرف',
                // Additional UI strings
                sent: 'تم الإرسال!',
                resetLinkSent: 'تم إرسال رابط إعادة تعيين كلمة المرور إلى',
                checkSpam: 'تحقق من مجلد البريد العشوائي أيضًا',
                backToLogin: 'العودة لتسجيل الدخول',
                enterEmailForReset: 'أدخل بريدك الإلكتروني وسنرسل لك رابط إعادة التعيين',
                displayName: 'اسم العرض',
                displayNamePlaceholder: 'الاسم المعروض في التطبيق',
                minChars: '6 أحرف على الأقل',
                reenterPassword: 'أعد إدخال كلمة المرور',
                enterDisplayName: 'يرجى إدخال اسم العرض',
                smartShoppingList: 'قائمة التسوق الذكية الخاصة بك',
                // Main app UI
                recipes: 'وصفات',
                whatsapp: 'واتساب',
                importList: 'استيراد قائمة',
                exportList: 'تصدير قائمة',
                deleteAll: 'حذف الكل',
                whatForgot: 'ماذا نسيت؟',
                calendar: 'التقويم',
                shoppingProgress: 'تقدم التسوق',
                itemsPurchased: 'منتجات تم شراؤها',
                markPurchased: 'حدد المنتجات المشتراة',
                allPurchased: 'تم شراء جميع المنتجات!',
                purchases: 'مشتريات',
                deleteAllTitle: 'حذف جميع المنتجات',
                deleteAllConfirm: 'هل أنت متأكد أنك تريد حذف جميع المنتجات؟',
                deleteAllWarning: 'سيتم حذف {count} منتج ولا يمكن التراجع!',
                deleteProduct: 'حذف المنتج',
                deleteProductConfirm: 'هل أنت متأكد أنك تريد حذف هذا المنتج؟',
                addProductPlaceholder: 'أضف منتج...',
                // Categories
                fruitsVeg: 'فواكه وخضروات',
                dairyProducts: 'منتجات الألبان',
                dairyDesserts: 'حلويات الألبان',
                meatFish: 'لحوم وأسماك',
                deli: 'قسم النقانق',
                breadBakery: 'خبز ومخبوزات',
                spreads: 'معجنات ومربى',
                bakingProducts: 'مواد الخبز',
                cereals: 'حبوب الإفطار',
                cannedDry: 'معلبات وأطعمة جافة',
                spices: 'بهارات وطبخ',
                coffeeTea: 'قهوة وشاي',
                drinks: 'مشروبات غازية',
                wineAlcohol: 'نبيذ وكحول',
                snacks: 'وجبات خفيفة وحلوى',
                frozen: 'مجمدات',
                dietProtein: 'دايت وبروتين',
                hygiene: 'نظافة شخصية',
                cleaning: 'تنظيف',
                candlesOil: 'شموع وزيت',
                babyKids: 'أطفال ورضع',
                pets: 'حيوانات أليفة',
                readySalads: 'سلطات جاهزة',
                // More UI strings
                searchAddProduct: 'أضف منتج...',
                emptyList: 'القائمة فارغة',
                addProductsBelow: 'أضف منتجات من شريط البحث أدناه',
                familyNameExample: 'مثال: عائلة محمد',
                listNameExample: 'مثال: تسوق نهاية الأسبوع',
                noteExample: 'مثال: علامة تجارية معينة، من الرف العلوي...',
                importExample: 'حليب\nبيض x2\n3 خبز\nجبنة، زبدة',
                productSearchExample: 'مثال: حليب، جبنة، رقائق...',
                tagExample: 'مثال: طازج، خالي من الغلوتين، عضوي...',
                typeMessage: 'اكتب رسالة...',
                recipeNameExample: 'اسم الوصفة (مثال: كعكة الشوكولاتة)',
                ingredientsExample: 'قائمة المكونات (كل مكون في سطر جديد)',
                feedbackPlaceholder: 'أخبرنا ما حدث أو ما تريد رؤيته...',
                priceComparison: 'مقارنة الأسعار',
                familySettings: 'إعدادات العائلة',
                createNewFamily: 'إنشاء عائلة جديدة',
                joinExistingFamily: 'الانضمام لعائلة موجودة',
                familyChat: 'دردشة العائلة',
                savedLists: 'قوائم محفوظة',
                noSavedLists: 'لا توجد قوائم محفوظة',
                loadToCart: 'تحميل للسلة',
                bought: 'تم الشراء',
                later: 'لاحقاً',
                addToList: 'أضف للقائمة',
                removeFromList: 'إزالة من القائمة',
                selectCategory: 'اختر فئة',
                allCategories: 'جميع الفئات',
                scanRecipe: 'مسح وصفة',
                scanProduct: 'مسح منتج',
                voiceInput: 'إدخال صوتي',
                importFromWhatsapp: 'استيراد من واتساب',
                regularItems: 'منتجات دائمة',
                forgottenItems: 'منتجات منسية',
                shoppingStreak: 'سلسلة التسوق',
                darkMode: 'الوضع الداكن',
                lightMode: 'الوضع الفاتح',
                language: 'اللغة',
                accessibilitySettings: 'إعدادات إمكانية الوصول',
                helpAndFeedback: 'المساعدة والملاحظات',
                showTutorial: 'عرض الإرشادات',
                logoutButton: 'تسجيل الخروج',
                total: 'المجموع',
                items: 'منتجات',
                share: 'مشاركة',
                copy: 'نسخ',
                copied: 'تم النسخ!',
                send: 'إرسال',
                confirm: 'تأكيد',
                selectAll: 'تحديد الكل',
                clearAll: 'مسح الكل',
                noProductsFound: 'لم يتم العثور على منتجات تطابق',
                tryAnotherSearch: 'جرب بحثاً آخر أو اختر فئة',
                noRecipesSaved: 'لا توجد وصفات محفوظة',
                addFirstRecipe: 'أضف أول وصفة',
                noHistoryYet: 'لا يوجد سجل بعد',
                completeFirstShopping: 'أكمل أول تسوق لرؤية الإحصائيات'
            }
        };

        // Language Context
        const LanguageContext = createContext(null);

        function LanguageProvider({ children }) {
            const [language, setLanguage] = useState(() => {
                return localStorage.getItem('appLanguage') || 'he';
            });

            const changeLanguage = (lang) => {
                setLanguage(lang);
                localStorage.setItem('appLanguage', lang);
                // Update document direction
                document.documentElement.dir = (lang === 'he' || lang === 'ar') ? 'rtl' : 'ltr';
                document.documentElement.lang = lang;
            };

            // Set direction whenever language changes
            useEffect(() => {
                document.documentElement.dir = (language === 'he' || language === 'ar') ? 'rtl' : 'ltr';
                document.documentElement.lang = language;
            }, [language]);

            const t = (key) => TRANSLATIONS[language]?.[key] || TRANSLATIONS['he'][key] || key;

            return (
                <LanguageContext.Provider value={{ language, changeLanguage, t }}>
                    {children}
                </LanguageContext.Provider>
            );
        }

        function useLanguage() {
            return useContext(LanguageContext);
        }

        // Family Context
        const FamilyContext = createContext(null);

        function FamilyProvider({ children }) {
            const { user } = useAuth();
            const [family, setFamily] = useState(null);
            const [lists, setLists] = useState([]);
            const [currentList, setCurrentList] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activities, setActivities] = useState([]);

            // Generate random 6-character code
            const generateCode = () => {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 6; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return code;
            };

            // Find user's family
            useEffect(() => {
                if (!user) {
                    setFamily(null);
                    setLists([]);
                    setCurrentList(null);
                    setLoading(false);
                    return;
                }

                setLoading(true);

                // Query families where user is a member
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'families')
                );

                const unsubscribe = window.firestore.onSnapshot(q, async (snapshot) => {
                    let userFamily = null;
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const isMember = data.members?.some(m => m.userId === user.uid);
                        if (isMember) {
                            userFamily = { id: doc.id, ...data };
                        }
                    });

                    setFamily(userFamily);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            // Load lists when family changes
            useEffect(() => {
                if (!family) {
                    setLists([]);
                    setCurrentList(null);
                    return;
                }

                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'lists'),
                    window.firestore.where('familyId', '==', family.id)
                );

                const unsubscribe = window.firestore.onSnapshot(q, (snapshot) => {
                    const listsData = [];
                    snapshot.forEach((doc) => {
                        listsData.push({ id: doc.id, ...doc.data() });
                    });
                    listsData.sort((a, b) => (b.isDefault ? 1 : 0) - (a.isDefault ? 1 : 0));
                    setLists(listsData);

                    // Set current list to default or first
                    if (!currentList || !listsData.find(l => l.id === currentList.id)) {
                        const defaultList = listsData.find(l => l.isDefault) || listsData[0];
                        setCurrentList(defaultList);
                    }
                });

                return () => unsubscribe();
            }, [family]);

            // Load activities
            useEffect(() => {
                if (!family) {
                    setActivities([]);
                    return;
                }

                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'activity'),
                    window.firestore.where('familyId', '==', family.id)
                );

                const unsubscribe = window.firestore.onSnapshot(q, (snapshot) => {
                    const activitiesData = [];
                    snapshot.forEach((doc) => {
                        activitiesData.push({ id: doc.id, ...doc.data() });
                    });
                    activitiesData.sort((a, b) => {
                        const dateA = a.timestamp?.toDate?.() || new Date(0);
                        const dateB = b.timestamp?.toDate?.() || new Date(0);
                        return dateB - dateA;
                    });
                    setActivities(activitiesData.slice(0, 50));
                });

                return () => unsubscribe();
            }, [family]);

            // Create a new family
            const createFamily = async (familyName, userRole = 'parent_father') => {
                if (!user) return null;

                const code = generateCode();
                const roleLabel = userRole === 'parent_father' ? 'אבא' : userRole === 'parent_mother' ? 'אמא' : 'הורה';
                const newFamily = {
                    name: familyName,
                    code: code,
                    adminId: user.uid,
                    members: [{
                        userId: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email,
                        joinedAt: new Date(),
                        role: 'admin',
                        familyRole: userRole,
                        familyRoleLabel: roleLabel,
                        isParent: true
                    }],
                    createdAt: new Date()
                };

                const familyRef = await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'families'),
                    newFamily
                );

                // Create default list
                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'lists'),
                    {
                        familyId: familyRef.id,
                        name: 'רשימת קניות',
                        icon: '🛒',
                        createdBy: user.uid,
                        createdAt: new Date(),
                        isDefault: true
                    }
                );

                // Log activity
                await logActivity('member_joined', { memberName: user.displayName || user.email }, familyRef.id);

                return { id: familyRef.id, ...newFamily };
            };

            // Join existing family
            const joinFamily = async (code, userRole = 'child') => {
                if (!user) return { success: false, error: 'לא מחובר' };

                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'families'),
                    window.firestore.where('code', '==', code.toUpperCase())
                );

                const snapshot = await window.firestore.getDocs(q);

                if (snapshot.empty) {
                    return { success: false, error: 'קוד לא נמצא' };
                }

                const familyDoc = snapshot.docs[0];
                const familyData = familyDoc.data();

                // Check if already a member
                if (familyData.members?.some(m => m.userId === user.uid)) {
                    return { success: false, error: 'כבר חבר במשפחה זו' };
                }

                const isParent = userRole.startsWith('parent');
                const roleLabel = userRole === 'parent_father' ? 'אבא' : userRole === 'parent_mother' ? 'אמא' : 'ילד/ה';

                // Add user to family
                const newMember = {
                    userId: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email,
                    joinedAt: new Date(),
                    role: isParent ? 'admin' : 'member',
                    familyRole: userRole,
                    familyRoleLabel: roleLabel,
                    isParent: isParent
                };

                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'families', familyDoc.id),
                    { members: window.firestore.arrayUnion(newMember) }
                );

                // Log activity
                await logActivity('member_joined', { memberName: user.displayName || user.email }, familyDoc.id);

                return { success: true };
            };

            // Leave family
            const leaveFamily = async () => {
                if (!family || !user) return;

                const memberToRemove = family.members.find(m => m.userId === user.uid);
                if (!memberToRemove) return;

                // If admin and only member, delete family
                if (family.adminId === user.uid && family.members.length === 1) {
                    // Delete all lists
                    const listsSnapshot = await window.firestore.getDocs(
                        window.firestore.query(
                            window.firestore.collection(window.db, 'lists'),
                            window.firestore.where('familyId', '==', family.id)
                        )
                    );
                    for (const doc of listsSnapshot.docs) {
                        await window.firestore.deleteDoc(doc.ref);
                    }
                    // Delete family
                    await window.firestore.deleteDoc(
                        window.firestore.doc(window.db, 'families', family.id)
                    );
                } else {
                    // Remove member
                    await window.firestore.updateDoc(
                        window.firestore.doc(window.db, 'families', family.id),
                        { members: window.firestore.arrayRemove(memberToRemove) }
                    );
                }
            };

            // Remove member (admin only)
            const removeMember = async (memberUserId) => {
                if (!family || family.adminId !== user.uid) return;
                if (memberUserId === user.uid) return; // Can't remove self

                const memberToRemove = family.members.find(m => m.userId === memberUserId);
                if (!memberToRemove) return;

                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'families', family.id),
                    { members: window.firestore.arrayRemove(memberToRemove) }
                );
            };

            // Create new list
            const createList = async (name, icon = '📝') => {
                if (!family) return;

                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'lists'),
                    {
                        familyId: family.id,
                        name: name,
                        icon: icon,
                        createdBy: user.uid,
                        createdAt: new Date(),
                        isDefault: false
                    }
                );

                await logActivity('list_created', { listName: name });
            };

            // Delete list
            const deleteList = async (listId) => {
                if (!family) return;
                const list = lists.find(l => l.id === listId);
                if (!list || list.isDefault) return; // Can't delete default list

                await window.firestore.deleteDoc(
                    window.firestore.doc(window.db, 'lists', listId)
                );
            };

            // Log activity
            const logActivity = async (type, details = {}, overrideFamilyId = null) => {
                if (!user) return;
                const fid = overrideFamilyId || family?.id;
                if (!fid) return;

                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'activity'),
                    {
                        familyId: fid,
                        listId: currentList?.id || null,
                        type: type,
                        userId: user.uid,
                        userName: user.displayName || user.email,
                        timestamp: new Date(),
                        ...details
                    }
                );
            };

            const value = {
                family,
                lists,
                currentList,
                setCurrentList,
                activities,
                loading,
                createFamily,
                joinFamily,
                leaveFamily,
                removeMember,
                createList,
                deleteList,
                logActivity,
                isAdmin: family?.adminId === user?.uid
            };

            return <FamilyContext.Provider value={value}>{children}</FamilyContext.Provider>;
        }

        function useFamily() {
            return useContext(FamilyContext);
        }

        // No Family Screen
        function NoFamilyScreen() {
            const [mode, setMode] = useState('choose'); // choose, create, join
            const [familyName, setFamilyName] = useState('');
            const [joinCode, setJoinCode] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [createdCode, setCreatedCode] = useState('');
            const [selectedRole, setSelectedRole] = useState(''); // parent_father, parent_mother, child
            const { createFamily, joinFamily } = useFamily();
            const { user } = useAuth();
            const { t, language } = useLanguage();
            const [darkMode, setDarkMode] = useState(false);

            useEffect(() => {
                const savedDark = localStorage.getItem('darkMode') === 'true';
                if (savedDark) {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }
            }, []);

            const handleCreate = async (e) => {
                e.preventDefault();
                if (!familyName.trim()) {
                    setError('נא להזין שם למשפחה');
                    return;
                }
                if (!selectedRole) {
                    setError('נא לבחור תפקיד במשפחה');
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    const newFamily = await createFamily(familyName.trim(), selectedRole);
                    setCreatedCode(newFamily.code);
                    setMode('created');
                } catch (err) {
                    setError('שגיאה ביצירת משפחה');
                } finally {
                    setLoading(false);
                }
            };

            const handleJoin = async (e) => {
                e.preventDefault();
                if (!joinCode.trim() || joinCode.trim().length !== 6) {
                    setError('נא להזין קוד בן 6 תווים');
                    return;
                }
                if (!selectedRole) {
                    setError('נא לבחור תפקיד במשפחה');
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    const result = await joinFamily(joinCode.trim(), selectedRole);
                    if (!result.success) {
                        setError(result.error);
                    }
                } catch (err) {
                    setError('שגיאה בהצטרפות');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                await window.firebaseAuth.signOut(window.auth);
            };

            const toggleDarkMode = () => {
                const newMode = !darkMode;
                setDarkMode(newMode);
                localStorage.setItem('darkMode', String(newMode));
                document.documentElement.classList.toggle('dark');
            };

            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div className="glass rounded-3xl shadow-2xl p-8 max-w-md w-full relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

                        <button onClick={toggleDarkMode} className="absolute top-6 left-6 p-2.5 rounded-xl bg-white/50 dark:bg-gray-700/50 text-2xl hover:scale-110 transition-all">
                            {darkMode ? '☀️' : '🌙'}
                        </button>

                        <button onClick={handleLogout} className="absolute top-6 right-6 p-2.5 rounded-xl bg-red-100 dark:bg-red-900/50 text-sm text-red-600 dark:text-red-400 hover:scale-105 transition-all">
                            התנתק
                        </button>

                        <div className="text-center mb-8 pt-8">
                            <div className="text-7xl mb-4 float">👨‍👩‍👧‍👦</div>
                            <h1 className="text-2xl font-bold text-gradient mb-2">{t('welcome')}, {user?.displayName || 'משתמש'}!</h1>
                            <p className="text-gray-500 dark:text-gray-400 text-sm">{t('createNewFamily')} / {t('joinExistingFamily')}</p>
                        </div>

                        {mode === 'choose' && (
                            <div className="space-y-4">
                                <button onClick={() => setMode('create')} className="w-full btn-gradient text-white py-4 rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-3">
                                    <span className="text-2xl">🏠</span>
                                    {t('createNewFamily')}
                                </button>
                                <button onClick={() => setMode('join')} className="w-full glass border-2 border-indigo-300 dark:border-indigo-600 py-4 rounded-xl font-semibold hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all flex items-center justify-center gap-3 text-gray-700 dark:text-gray-200">
                                    <span className="text-2xl">🔗</span>
                                    {t('joinExistingFamily')}
                                </button>
                            </div>
                        )}

                        {mode === 'create' && (
                            <form onSubmit={handleCreate} className="space-y-4">
                                <h2 className="text-xl font-bold text-center text-gray-800 dark:text-white mb-4">{t('createFamily')}</h2>

                                {error && (
                                    <div className="bg-red-100 dark:bg-red-900/30 border-2 border-red-300 dark:border-red-700 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg text-sm">
                                        {error}
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('familyName')}</label>
                                    <input
                                        type="text"
                                        value={familyName}
                                        onChange={e => setFamilyName(e.target.value)}
                                        placeholder={t('familyNameExample')}
                                        className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 dark:text-white focus:border-indigo-500"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('selectRole')}</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button
                                            type="button"
                                            onClick={() => setSelectedRole('parent_father')}
                                            className={`p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 ${
                                                selectedRole === 'parent_father'
                                                    ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30'
                                                    : 'border-gray-200 dark:border-gray-600 hover:border-indigo-300'
                                            }`}
                                        >
                                            <span className="text-3xl">👨</span>
                                            <span className="font-medium text-gray-800 dark:text-white">{t('father')}</span>
                                            <span className="text-xs text-green-600">{t('admin')}</span>
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setSelectedRole('parent_mother')}
                                            className={`p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 ${
                                                selectedRole === 'parent_mother'
                                                    ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30'
                                                    : 'border-gray-200 dark:border-gray-600 hover:border-indigo-300'
                                            }`}
                                        >
                                            <span className="text-3xl">👩</span>
                                            <span className="font-medium text-gray-800 dark:text-white">{t('mother')}</span>
                                            <span className="text-xs text-green-600">{t('admin')}</span>
                                        </button>
                                    </div>
                                </div>

                                <button type="submit" disabled={loading || !selectedRole} className="w-full btn-gradient text-white py-3 rounded-xl font-semibold disabled:opacity-50">
                                    {loading ? t('loading') : t('createFamily')}
                                </button>

                                <button type="button" onClick={() => { setMode('choose'); setError(''); setSelectedRole(''); }} className="w-full text-indigo-600 dark:text-indigo-400 text-sm hover:underline">
                                    חזור
                                </button>
                            </form>
                        )}

                        {mode === 'join' && (
                            <form onSubmit={handleJoin} className="space-y-4">
                                <h2 className="text-xl font-bold text-center text-gray-800 dark:text-white mb-4">{t('joinFamily')}</h2>

                                {error && (
                                    <div className="bg-red-100 dark:bg-red-900/30 border-2 border-red-300 dark:border-red-700 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg text-sm">
                                        {error}
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('familyCode')}</label>
                                    <input
                                        type="text"
                                        value={joinCode}
                                        onChange={e => setJoinCode(e.target.value.toUpperCase())}
                                        placeholder="ABC123"
                                        maxLength={6}
                                        className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 dark:text-white focus:border-indigo-500 text-center text-2xl tracking-widest font-mono"
                                        dir="ltr"
                                        required
                                    />
                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-1 text-center">{t('shareCode')}</p>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('selectRole')}</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        <button
                                            type="button"
                                            onClick={() => setSelectedRole('parent_father')}
                                            className={`p-3 rounded-xl border-2 transition-all flex flex-col items-center gap-1 ${
                                                selectedRole === 'parent_father'
                                                    ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30'
                                                    : 'border-gray-200 dark:border-gray-600 hover:border-indigo-300'
                                            }`}
                                        >
                                            <span className="text-2xl">👨</span>
                                            <span className="text-sm font-medium text-gray-800 dark:text-white">{t('father')}</span>
                                            <span className="text-xs text-green-600">{t('admin')}</span>
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setSelectedRole('parent_mother')}
                                            className={`p-3 rounded-xl border-2 transition-all flex flex-col items-center gap-1 ${
                                                selectedRole === 'parent_mother'
                                                    ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30'
                                                    : 'border-gray-200 dark:border-gray-600 hover:border-indigo-300'
                                            }`}
                                        >
                                            <span className="text-2xl">👩</span>
                                            <span className="text-sm font-medium text-gray-800 dark:text-white">{t('mother')}</span>
                                            <span className="text-xs text-green-600">{t('admin')}</span>
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setSelectedRole('child')}
                                            className={`p-3 rounded-xl border-2 transition-all flex flex-col items-center gap-1 ${
                                                selectedRole === 'child'
                                                    ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30'
                                                    : 'border-gray-200 dark:border-gray-600 hover:border-indigo-300'
                                            }`}
                                        >
                                            <span className="text-2xl">👦</span>
                                            <span className="text-sm font-medium text-gray-800 dark:text-white">{t('child')}</span>
                                            <span className="text-xs text-amber-600">{t('limited')}</span>
                                        </button>
                                    </div>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">{t('childPermissions')}</p>
                                </div>

                                <button type="submit" disabled={loading || !selectedRole} className="w-full btn-gradient text-white py-3 rounded-xl font-semibold disabled:opacity-50">
                                    {loading ? t('loading') : t('joinFamily')}
                                </button>

                                <button type="button" onClick={() => { setMode('choose'); setError(''); }} className="w-full text-indigo-600 dark:text-indigo-400 text-sm hover:underline">
                                    {t('back')}
                                </button>
                            </form>
                        )}

                        {mode === 'created' && (
                            <div className="text-center space-y-4">
                                <div className="text-6xl mb-4">🎉</div>
                                <h2 className="text-xl font-bold text-gradient">המשפחה נוצרה!</h2>
                                <p className="text-gray-600 dark:text-gray-400">שתף את הקוד הזה עם בני המשפחה:</p>
                                <div className="bg-indigo-100 dark:bg-indigo-900/50 px-6 py-4 rounded-xl">
                                    <div className="text-3xl font-mono font-bold text-indigo-600 dark:text-indigo-400 tracking-widest">{createdCode}</div>
                                </div>
                                <button
                                    onClick={() => navigator.clipboard.writeText(createdCode)}
                                    className="text-indigo-600 dark:text-indigo-400 text-sm hover:underline flex items-center justify-center gap-2 mx-auto"
                                >
                                    📋 העתק קוד
                                </button>
                                <p className="text-xs text-gray-500 dark:text-gray-400">הדף יתרענן אוטומטית...</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Family Settings Modal
        function FamilySettingsModal({ onClose }) {
            const { family, leaveFamily, removeMember, isAdmin } = useFamily();
            const { user } = useAuth();
            const [showLeaveConfirm, setShowLeaveConfirm] = useState(false);
            const [copied, setCopied] = useState(false);
            const [showShareOptions, setShowShareOptions] = useState(false);
            const [qrCodeUrl, setQrCodeUrl] = useState('');

            const inviteLink = `https://yossigidi.github.io/shooping-list/?join=${family?.code}`;

            const copyCode = () => {
                navigator.clipboard.writeText(family.code);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const copyLink = () => {
                navigator.clipboard.writeText(inviteLink);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const generateQRCode = () => {
                try {
                    const qr = qrcode(0, 'M');
                    qr.addData(inviteLink);
                    qr.make();
                    setQrCodeUrl(qr.createDataURL(6, 0));
                    setShowShareOptions(true);
                } catch (e) {
                    console.error('QR generation error:', e);
                }
            };

            const shareViaWhatsApp = () => {
                const text = encodeURIComponent(`הצטרף/י למשפחת "${family.name}" באפליקציית רשימת הקניות שלנו!\n\nקוד הצטרפות: ${family.code}\n\nאו לחץ על הקישור:\n${inviteLink}`);
                window.open(`https://wa.me/?text=${text}`, '_blank');
            };

            const shareViaEmail = () => {
                const subject = encodeURIComponent(`הזמנה להצטרף למשפחת ${family.name}`);
                const body = encodeURIComponent(`שלום!\n\nאני מזמין אותך להצטרף למשפחת "${family.name}" באפליקציית רשימת הקניות המשותפת שלנו.\n\nקוד הצטרפות: ${family.code}\n\nאו לחץ על הקישור הבא:\n${inviteLink}\n\nנתראה ברשימה!`);
                window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
            };

            const handleLeave = async () => {
                await leaveFamily();
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="glass rounded-3xl p-8 max-w-md w-full shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold flex items-center gap-3">
                                <span className="text-3xl">👨‍👩‍👧‍👦</span>
                                <span className="text-gradient">{family.name}</span>
                            </h2>
                            <button onClick={onClose} className="w-10 h-10 flex items-center justify-center glass rounded-full text-gray-500 hover:text-red-500 text-2xl hover:scale-110 hover:rotate-90 transition-all">×</button>
                        </div>

                        {/* Share Code */}
                        <div className="glass rounded-xl p-4 mb-4">
                            <h3 className="font-bold text-gray-700 dark:text-gray-300 mb-2">קוד הזמנה</h3>
                            <div className="flex items-center gap-3">
                                <div className="flex-1 bg-indigo-100 dark:bg-indigo-900/50 px-4 py-3 rounded-lg text-center">
                                    <span className="text-2xl font-mono font-bold text-indigo-600 dark:text-indigo-400 tracking-widest">{family.code}</span>
                                </div>
                                <button onClick={copyCode} className="btn-gradient text-white px-4 py-3 rounded-lg hover:scale-105 transition-all">
                                    {copied ? '✓' : '📋'}
                                </button>
                            </div>
                        </div>

                        {/* Share Options Button */}
                        <button
                            onClick={generateQRCode}
                            className="w-full mb-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 rounded-xl font-semibold hover:from-green-600 hover:to-emerald-600 transition-all flex items-center justify-center gap-2"
                        >
                            <span>📤</span> שתף עם המשפחה
                        </button>

                        {/* Share Options Modal */}
                        {showShareOptions && (
                            <div className="glass rounded-xl p-4 mb-4 border-2 border-green-200 dark:border-green-800">
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="font-bold text-gray-700 dark:text-gray-300">אפשרויות שיתוף</h4>
                                    <button onClick={() => setShowShareOptions(false)} className="text-gray-400 hover:text-gray-600">✕</button>
                                </div>

                                {/* QR Code */}
                                {qrCodeUrl && (
                                    <div className="flex justify-center mb-4">
                                        <div className="bg-white p-3 rounded-xl">
                                            <img src={qrCodeUrl} alt="QR Code" className="w-40 h-40" />
                                        </div>
                                    </div>
                                )}

                                {/* Share Buttons */}
                                <div className="grid grid-cols-3 gap-2 mb-3">
                                    <button
                                        onClick={shareViaWhatsApp}
                                        className="flex flex-col items-center gap-1 p-3 bg-green-100 dark:bg-green-900/30 rounded-xl hover:bg-green-200 dark:hover:bg-green-900/50 transition-all"
                                    >
                                        <span className="text-2xl">💬</span>
                                        <span className="text-xs font-medium text-green-700 dark:text-green-400">WhatsApp</span>
                                    </button>
                                    <button
                                        onClick={shareViaEmail}
                                        className="flex flex-col items-center gap-1 p-3 bg-blue-100 dark:bg-blue-900/30 rounded-xl hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-all"
                                    >
                                        <span className="text-2xl">📧</span>
                                        <span className="text-xs font-medium text-blue-700 dark:text-blue-400">אימייל</span>
                                    </button>
                                    <button
                                        onClick={copyLink}
                                        className="flex flex-col items-center gap-1 p-3 bg-purple-100 dark:bg-purple-900/30 rounded-xl hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-all"
                                    >
                                        <span className="text-2xl">🔗</span>
                                        <span className="text-xs font-medium text-purple-700 dark:text-purple-400">העתק קישור</span>
                                    </button>
                                </div>

                                <p className="text-xs text-gray-500 dark:text-gray-400 text-center">סרקו את הקוד או שתפו בכל דרך שנוחה לכם</p>
                            </div>
                        )}

                        {/* Members List */}
                        <div className="mb-6">
                            <h3 className="font-bold text-gray-700 dark:text-gray-300 mb-3">חברי המשפחה ({family.members?.length})</h3>
                            <div className="space-y-2">
                                {family.members?.map((member, idx) => (
                                    <div key={idx} className="glass rounded-lg p-3 flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xl">
                                                {member.familyRole === 'parent_father' ? '👨' : member.familyRole === 'parent_mother' ? '👩' : member.familyRole === 'child' ? '👦' : member.displayName?.charAt(0)?.toUpperCase() || '?'}
                                            </div>
                                            <div>
                                                <div className="font-medium dark:text-white">{member.displayName}</div>
                                                <div className="text-xs text-gray-500 dark:text-gray-400">
                                                    {member.familyRoleLabel || (member.role === 'admin' ? '👑 מנהל' : 'חבר')}
                                                    {(member.isParent || member.role === 'admin') && <span className="mr-1 text-green-600">• מנהל</span>}
                                                </div>
                                            </div>
                                        </div>
                                        {isAdmin && member.userId !== user.uid && (
                                            <button
                                                onClick={() => removeMember(member.userId)}
                                                className="text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 p-2 rounded-lg transition-colors"
                                                title="הסר חבר"
                                            >
                                                🗑
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Leave Family */}
                        {!showLeaveConfirm ? (
                            <button
                                onClick={() => setShowLeaveConfirm(true)}
                                className="w-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 py-3 rounded-xl font-semibold hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors"
                            >
                                {isAdmin && family.members?.length === 1 ? '🗑 מחק משפחה' : '🚪 עזוב משפחה'}
                            </button>
                        ) : (
                            <div className="glass rounded-xl p-4 border-2 border-red-300 dark:border-red-700">
                                <p className="text-center text-red-600 dark:text-red-400 mb-4 font-medium">
                                    {isAdmin && family.members?.length === 1
                                        ? 'המשפחה תימחק לצמיתות. להמשיך?'
                                        : 'בטוח שברצונך לעזוב?'}
                                </p>
                                <div className="flex gap-2">
                                    <button onClick={handleLeave} className="flex-1 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600">
                                        כן, {isAdmin && family.members?.length === 1 ? 'מחק' : 'עזוב'}
                                    </button>
                                    <button onClick={() => setShowLeaveConfirm(false)} className="flex-1 glass py-2 rounded-lg font-semibold">
                                        ביטול
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Create List Modal
        function CreateListModal({ onClose }) {
            const { createList } = useFamily();
            const [name, setName] = useState('');
            const [icon, setIcon] = useState('📝');
            const [loading, setLoading] = useState(false);

            const icons = ['📝', '🛒', '🎉', '🏠', '💊', '🐾', '👶', '🍽️', '🧹', '✈️'];

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim()) return;
                setLoading(true);
                await createList(name.trim(), icon);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="glass rounded-3xl p-8 max-w-sm w-full shadow-2xl">
                        <div className="text-5xl text-center mb-4">📋</div>
                        <h2 className="text-xl font-bold text-center text-gradient mb-6">רשימה חדשה</h2>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">שם הרשימה</label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={e => setName(e.target.value)}
                                    placeholder="לדוגמה: קניות לשבת"
                                    className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 dark:text-white focus:border-indigo-500"
                                    autoFocus
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">אייקון</label>
                                <div className="flex flex-wrap gap-2">
                                    {icons.map(i => (
                                        <button
                                            key={i}
                                            type="button"
                                            onClick={() => setIcon(i)}
                                            className={`text-2xl p-2 rounded-lg transition-all ${icon === i ? 'bg-indigo-100 dark:bg-indigo-900/50 scale-110' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`}
                                        >
                                            {i}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="flex gap-3 pt-2">
                                <button type="submit" disabled={loading} className="flex-1 btn-gradient text-white py-3 rounded-xl font-semibold disabled:opacity-50">
                                    {loading ? 'יוצר...' : 'צור רשימה'}
                                </button>
                                <button type="button" onClick={onClose} className="px-6 py-3 glass border-2 border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700">
                                    ביטול
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Item Note Modal
        function ItemNoteModal({ item, onClose, onSave }) {
            const { language } = useLanguage();
            const [note, setNote] = useState(item.note || '');
            const [loading, setLoading] = useState(false);

            const handleSave = async () => {
                setLoading(true);
                await onSave(note);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="glass rounded-3xl p-8 max-w-sm w-full shadow-2xl">
                        <div className="text-5xl text-center mb-4">📝</div>
                        <h2 className="text-xl font-bold text-center text-gradient mb-2">הערה למוצר</h2>
                        <p className="text-center text-gray-500 dark:text-gray-400 mb-4">{getProductTranslation(item.name, language)}</p>

                        <textarea
                            value={note}
                            onChange={e => setNote(e.target.value)}
                            placeholder="לדוגמה: מותג אסם, מהמדף העליון..."
                            className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 dark:text-white focus:border-indigo-500 resize-none h-24 mb-4"
                            autoFocus
                        />

                        <div className="flex gap-3">
                            <button onClick={handleSave} disabled={loading} className="flex-1 btn-gradient text-white py-3 rounded-xl font-semibold disabled:opacity-50">
                                {loading ? 'שומר...' : 'שמור'}
                            </button>
                            <button onClick={onClose} className="px-6 py-3 glass border-2 border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700">
                                ביטול
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Error message helper
        function getErrorMessage(errorCode) {
            const messages = {
                'auth/email-already-in-use': 'כתובת האימייל כבר בשימוש',
                'auth/invalid-email': 'כתובת אימייל לא תקינה',
                'auth/operation-not-allowed': 'פעולה לא מורשית',
                'auth/weak-password': 'הסיסמה חלשה מדי (לפחות 6 תווים)',
                'auth/user-disabled': 'המשתמש הושבת',
                'auth/user-not-found': 'משתמש לא נמצא',
                'auth/wrong-password': 'סיסמה שגויה',
                'auth/too-many-requests': 'יותר מדי ניסיונות, נסה שוב מאוחר יותר',
                'auth/invalid-credential': 'פרטי התחברות שגויים',
                'auth/missing-password': 'נא להזין סיסמה'
            };
            return messages[errorCode] || 'אירעה שגיאה, נסה שוב';
        }

        // Sign Up Form
        function SignUpForm({ onSwitchToLogin }) {
            const { t, language } = useLanguage();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [displayName, setDisplayName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const isRTL = language === 'he' || language === 'ar';

            const handleSignUp = async (e) => {
                e.preventDefault();
                setError('');

                if (!displayName.trim()) {
                    return setError(t('enterDisplayName'));
                }
                if (password !== confirmPassword) {
                    return setError(t('passwordsNoMatch'));
                }
                if (password.length < 6) {
                    return setError(t('passwordTooShort'));
                }

                try {
                    setLoading(true);
                    const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(
                        window.auth, email, password
                    );
                    await window.firebaseAuth.updateProfile(userCredential.user, {
                        displayName: displayName.trim()
                    });
                } catch (err) {
                    setError(getErrorMessage(err.code));
                } finally {
                    setLoading(false);
                }
            };

            return (
                <form onSubmit={handleSignUp} className="space-y-4" dir={isRTL ? 'rtl' : 'ltr'}>
                    <h2 className="text-2xl font-bold text-gray-800 dark:text-white text-center mb-6">{t('register')}</h2>

                    {error && (
                        <div className="bg-red-100 dark:bg-red-900/30 border-2 border-red-300 dark:border-red-700 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg text-sm">
                            {error}
                        </div>
                    )}

                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('displayName')}</label>
                        <input
                            type="text"
                            value={displayName}
                            onChange={e => setDisplayName(e.target.value)}
                            placeholder={t('displayNamePlaceholder')}
                            className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:border-indigo-500 dark:focus:border-indigo-400 transition-colors"
                            required
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('email')}</label>
                        <input
                            type="email"
                            value={email}
                            onChange={e => setEmail(e.target.value)}
                            placeholder="example@email.com"
                            className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:border-indigo-500 dark:focus:border-indigo-400 transition-colors"
                            dir="ltr"
                            required
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('password')}</label>
                        <input
                            type="password"
                            value={password}
                            onChange={e => setPassword(e.target.value)}
                            placeholder={t('minChars')}
                            className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:border-indigo-500 dark:focus:border-indigo-400 transition-colors"
                            dir="ltr"
                            required
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('confirmPassword')}</label>
                        <input
                            type="password"
                            value={confirmPassword}
                            onChange={e => setConfirmPassword(e.target.value)}
                            placeholder={t('reenterPassword')}
                            className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:border-indigo-500 dark:focus:border-indigo-400 transition-colors"
                            dir="ltr"
                            required
                        />
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loading ? t('loading') : t('register')}
                    </button>

                    <p className="text-center text-gray-600 dark:text-gray-400 text-sm">
                        {t('haveAccount')}{' '}
                        <button type="button" onClick={onSwitchToLogin} className="text-indigo-600 dark:text-indigo-400 font-semibold hover:underline">
                            {t('login')}
                        </button>
                    </p>
                </form>
            );
        }

        // Login Form
        function LoginForm({ onSwitchToSignUp, onSwitchToReset }) {
            const { t, language } = useLanguage();
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const isRTL = language === 'he' || language === 'ar';

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');

                try {
                    setLoading(true);
                    await window.firebaseAuth.signInWithEmailAndPassword(window.auth, email, password);
                } catch (err) {
                    setError(getErrorMessage(err.code));
                } finally {
                    setLoading(false);
                }
            };

            return (
                <form onSubmit={handleLogin} className="space-y-4" dir={isRTL ? 'rtl' : 'ltr'}>
                    <h2 className="text-2xl font-bold text-gray-800 dark:text-white text-center mb-6">{t('login')}</h2>

                    {error && (
                        <div className="bg-red-100 dark:bg-red-900/30 border-2 border-red-300 dark:border-red-700 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg text-sm">
                            {error}
                        </div>
                    )}

                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('email')}</label>
                        <input
                            type="email"
                            value={email}
                            onChange={e => setEmail(e.target.value)}
                            placeholder="example@email.com"
                            className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:border-indigo-500 dark:focus:border-indigo-400 transition-colors"
                            dir="ltr"
                            required
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('password')}</label>
                        <input
                            type="password"
                            value={password}
                            onChange={e => setPassword(e.target.value)}
                            placeholder={t('password')}
                            className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:border-indigo-500 dark:focus:border-indigo-400 transition-colors"
                            dir="ltr"
                            required
                        />
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loading ? t('loading') : t('login')}
                    </button>

                    <button
                        type="button"
                        onClick={onSwitchToReset}
                        className="w-full text-indigo-600 dark:text-indigo-400 text-sm hover:underline"
                    >
                        {t('forgotPassword')}
                    </button>

                    <p className="text-center text-gray-600 dark:text-gray-400 text-sm">
                        {t('noAccount')}{' '}
                        <button type="button" onClick={onSwitchToSignUp} className="text-indigo-600 dark:text-indigo-400 font-semibold hover:underline">
                            {t('register')}
                        </button>
                    </p>
                </form>
            );
        }

        // Password Reset Form
        function PasswordResetForm({ onSwitchToLogin }) {
            const { t, language } = useLanguage();
            const [email, setEmail] = useState('');
            const [error, setError] = useState('');
            const [success, setSuccess] = useState(false);
            const [loading, setLoading] = useState(false);
            const isRTL = language === 'he' || language === 'ar';

            const handleReset = async (e) => {
                e.preventDefault();
                setError('');

                try {
                    setLoading(true);
                    await window.firebaseAuth.sendPasswordResetEmail(window.auth, email);
                    setSuccess(true);
                } catch (err) {
                    setError(getErrorMessage(err.code));
                } finally {
                    setLoading(false);
                }
            };

            if (success) {
                return (
                    <div className="text-center space-y-4" dir={isRTL ? 'rtl' : 'ltr'}>
                        <div className="text-6xl">📧</div>
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white">{t('sent')}</h2>
                        <p className="text-gray-600 dark:text-gray-400">
                            {t('resetLinkSent')}<br/>
                            <span className="font-semibold" dir="ltr">{email}</span>
                        </p>
                        <p className="text-sm text-gray-500 dark:text-gray-500">{t('checkSpam')}</p>
                        <button
                            onClick={onSwitchToLogin}
                            className="text-indigo-600 dark:text-indigo-400 font-semibold hover:underline"
                        >
                            {t('backToLogin')}
                        </button>
                    </div>
                );
            }

            return (
                <form onSubmit={handleReset} className="space-y-4" dir={isRTL ? 'rtl' : 'ltr'}>
                    <h2 className="text-2xl font-bold text-gray-800 dark:text-white text-center mb-2">{t('resetPassword')}</h2>
                    <p className="text-center text-gray-600 dark:text-gray-400 text-sm mb-6">
                        {t('enterEmailForReset')}
                    </p>

                    {error && (
                        <div className="bg-red-100 dark:bg-red-900/30 border-2 border-red-300 dark:border-red-700 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg text-sm">
                            {error}
                        </div>
                    )}

                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('email')}</label>
                        <input
                            type="email"
                            value={email}
                            onChange={e => setEmail(e.target.value)}
                            placeholder="example@email.com"
                            className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:border-indigo-500 dark:focus:border-indigo-400 transition-colors"
                            dir="ltr"
                            required
                        />
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loading ? t('sending') : t('sendResetLink')}
                    </button>

                    <button
                        type="button"
                        onClick={onSwitchToLogin}
                        className="w-full text-indigo-600 dark:text-indigo-400 text-sm hover:underline"
                    >
                        {t('backToLogin')}
                    </button>
                </form>
            );
        }

        // Auth Screen Container
        function AuthScreen() {
            const [mode, setMode] = useState('login');
            const [darkMode, setDarkMode] = useState(false);

            useEffect(() => {
                const savedDark = localStorage.getItem('darkMode') === 'true';
                if (savedDark) {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }
            }, []);

            const toggleDarkMode = () => {
                const newMode = !darkMode;
                setDarkMode(newMode);
                localStorage.setItem('darkMode', String(newMode));
                document.documentElement.classList.toggle('dark');
            };

            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div className="glass rounded-3xl shadow-2xl p-8 max-w-md w-full relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        <button
                            onClick={toggleDarkMode}
                            className="absolute top-6 left-6 p-2.5 rounded-xl bg-white/50 dark:bg-gray-700/50 text-2xl hover:scale-110 transition-all duration-300 shadow-lg"
                        >
                            {darkMode ? '☀️' : '🌙'}
                        </button>

                        <div className="text-center mb-8 pt-4">
                            <div className="text-7xl mb-4 float">🛒</div>
                            <h1 className="text-3xl font-bold text-gradient mb-2">ListNest</h1>
                            <p className="text-gray-500 dark:text-gray-400 text-sm">רשימת הקניות החכמה שלך</p>
                        </div>

                        {mode === 'login' && (
                            <LoginForm
                                onSwitchToSignUp={() => setMode('signup')}
                                onSwitchToReset={() => setMode('reset')}
                            />
                        )}
                        {mode === 'signup' && (
                            <SignUpForm onSwitchToLogin={() => setMode('login')} />
                        )}
                        {mode === 'reset' && (
                            <PasswordResetForm onSwitchToLogin={() => setMode('login')} />
                        )}
                    </div>
                </div>
            );
        }

        const CATEGORIES = {
            fruits: { name: 'פירות וירקות', icon: '🍎', unit: 'ק"ג', unitOptions: ['ק"ג', 'יח\'', 'גרם'] },
            dairy: { name: 'מוצרי חלב', icon: '🧀', unit: 'יח\'', unitOptions: ['יח\'', 'גרם', 'מ"ל', 'ליטר'] },
            desserts: { name: 'מעדני חלב', icon: '🍨', unit: 'יח\'', unitOptions: ['יח\'', 'גרם'] },
            meat: { name: 'בשר ודגים', icon: '🥩', unit: 'ק"ג', unitOptions: ['ק"ג', 'גרם', 'יח\''] },
            deli: { name: 'מעדניית נקניקים', icon: '🥓', unit: 'גרם', unitOptions: ['גרם', 'ק"ג', 'יח\''] },
            salads: { name: 'סלטים מוכנים', icon: '🥗', unit: 'יח\'', unitOptions: ['יח\'', 'גרם'] },
            bakery: { name: 'לחם ומאפים', icon: '🥐', unit: 'יח\'', unitOptions: ['יח\''] },
            spreads: { name: 'ממרחים', icon: '🍯', unit: 'יח\'', unitOptions: ['יח\'', 'גרם'] },
            baking: { name: 'מוצרי אפיה', icon: '🧁', unit: 'יח\'', unitOptions: ['יח\'', 'גרם', 'ק"ג'] },
            cereals: { name: 'דגנים וקורנפלקס', icon: '🌾', unit: 'יח\'', unitOptions: ['יח\'', 'גרם'] },
            canned: { name: 'שימורים ומזון יבש', icon: '🥫', unit: 'יח\'', unitOptions: ['יח\'', 'גרם'] },
            spices: { name: 'תבלינים ובישול', icon: '🌿', unit: 'גרם', unitOptions: ['גרם', 'יח\''] },
            coffee: { name: 'קפה ותה', icon: '☕', unit: 'יח\'', unitOptions: ['יח\'', 'גרם'] },
            drinks: { name: 'משקאות קלים', icon: '🧃', unit: 'יח\'', unitOptions: ['יח\'', 'ליטר', 'מ"ל'] },
            wine: { name: 'יין ואלכוהול', icon: '🍷', unit: 'יח\'', unitOptions: ['יח\'', 'מ"ל'] },
            snacks: { name: 'חטיפים וממתקים', icon: '🍫', unit: 'יח\'', unitOptions: ['יח\'', 'גרם'] },
            frozen: { name: 'קפואים', icon: '❄️', unit: 'יח\'', unitOptions: ['יח\'', 'ק"ג', 'גרם'] },
            health: { name: 'דיאטה וחלבון', icon: '🥗', unit: 'יח\'', unitOptions: ['יח\'', 'גרם'] },
            hygiene: { name: 'היגיינה ורחצה', icon: '🛁', unit: 'יח\'', unitOptions: ['יח\''] },
            cleaning: { name: 'ניקיון', icon: '✨', unit: 'יח\'', unitOptions: ['יח\'', 'ליטר'] },
            candles: { name: 'נרות', icon: '🕯️', unit: 'יח\'', unitOptions: ['יח\''] },
            baby: { name: 'תינוקות וילדים', icon: '🍼', unit: 'יח\'', unitOptions: ['יח\''] },
            pets: { name: 'חיות מחמד', icon: '🐕', unit: 'יח\'', unitOptions: ['יח\'', 'ק"ג'] }
        };

        // Israeli holidays for calendar reminders (2025-2026 dates)
        const ISRAELI_HOLIDAYS = [
            { name: 'פורים', icon: '🎭', date: '14.03.2025', dateObj: new Date('2025-03-14'), reminder: 'זמן לקנות משלוחי מנות ואוזני המן', type: 'jewish' },
            { name: 'פסח', icon: '🍷', date: '13-19.04.2025', dateObj: new Date('2025-04-13'), reminder: 'זמן לקנות מצות, יין, חרוסת ומצרכים לחג', type: 'jewish' },
            { name: 'יום הזיכרון', icon: '🕯️', date: '30.04.2025', dateObj: new Date('2025-04-30'), reminder: 'יום זיכרון לחללי צה"ל', type: 'national' },
            { name: 'יום העצמאות', icon: '🇮🇱', date: '01.05.2025', dateObj: new Date('2025-05-01'), reminder: 'זמן לקנות בשר, נקניקיות וציוד למנגל!', type: 'national' },
            { name: 'ל"ג בעומר', icon: '🔥', date: '16.05.2025', dateObj: new Date('2025-05-16'), reminder: 'זמן לקנות בשר ונקניקיות למדורה', type: 'jewish' },
            { name: 'יום ירושלים', icon: '🏛️', date: '02.06.2025', dateObj: new Date('2025-06-02'), reminder: 'יום ירושלים', type: 'national' },
            { name: 'שבועות', icon: '🧀', date: '02-03.06.2025', dateObj: new Date('2025-06-02'), reminder: 'זמן לקנות מוצרי חלב ועוגות גבינה', type: 'jewish' },
            { name: 'ראש השנה', icon: '🍎', date: '23-24.09.2025', dateObj: new Date('2025-09-23'), reminder: 'זמן לקנות דבש, תפוחים, רימונים ודגים', type: 'jewish' },
            { name: 'יום כיפור', icon: '🕯️', date: '02.10.2025', dateObj: new Date('2025-10-02'), reminder: 'זמן להכין אוכל לפני ואחרי הצום', type: 'jewish' },
            { name: 'סוכות', icon: '🌿', date: '07-13.10.2025', dateObj: new Date('2025-10-07'), reminder: 'זמן לקנות ארבעת המינים ואוכל לחג', type: 'jewish' },
            { name: 'שמחת תורה', icon: '📜', date: '15.10.2025', dateObj: new Date('2025-10-15'), reminder: 'זמן להכין כיבוד וממתקים', type: 'jewish' },
            { name: 'חנוכה', icon: '🕎', date: '15-22.12.2025', dateObj: new Date('2025-12-15'), reminder: 'זמן לקנות שמן, נרות, סופגניות ולביבות', type: 'jewish' },
            { name: 'סילבסטר', icon: '🥂', date: '31.12.2025', dateObj: new Date('2025-12-31'), reminder: 'מסיבת סוף שנה - זמן לקנות חטיפים ושתייה', type: 'civil' },
            { name: 'ראש השנה האזרחית', icon: '🎉', date: '01.01.2026', dateObj: new Date('2026-01-01'), reminder: 'שנה אזרחית חדשה!', type: 'civil' },
            { name: 'ט"ו בשבט', icon: '🌳', date: '04.02.2026', dateObj: new Date('2026-02-04'), reminder: 'זמן לקנות פירות יבשים ופירות הארץ', type: 'jewish' },
            { name: 'פורים', icon: '🎭', date: '03.03.2026', dateObj: new Date('2026-03-03'), reminder: 'זמן לקנות משלוחי מנות ואוזני המן', type: 'jewish' },
            { name: 'פסח', icon: '🍷', date: '02-08.04.2026', dateObj: new Date('2026-04-02'), reminder: 'זמן לקנות מצות, יין, חרוסת ומצרכים לחג', type: 'jewish' }
        ];

        const PRODUCTS = {
            dairy: ['חלב 3%', 'חלב 1%', 'חלב דל שומן', 'חלב סויה', 'חלב שקדים', 'חלב קוקוס', 'חלב שיבולת שועל', 'לבן', 'לבן עז', 'גבינה צהובה עמק', 'גבינה צהובה גלבוע', 'גבינה צהובה 9%', 'גבינה צהובה 22%', 'קוטג׳ 5%', 'קוטג׳ 3%', 'גבינה בולגרית', 'צפתית', 'גבינת שמנת', 'פרמזן', 'מוצרלה', 'ביצים', 'ביצים L', 'ביצים XL', 'ביצים אורגניות', 'ביצים חופשיות', 'חמאה', 'חמאה מלוחה', 'שמנת מתוקה', 'שמנת חמוצה', 'שמנת לקצפת', 'יוגורט', 'יוגורט יווני', 'יוגורט יווני 0%', 'יוגורט תנובה', 'יוגורט שטראוס', 'יוגורט אקטיביה', 'גבינה לבנה 5%', 'גבינה לבנה 9%', 'יוגורט אורגני', 'יוגורט לילדים', 'גבינת עזים', 'גבינת רוקפור', 'קשקבל', 'גאודה', 'אמנטל', 'ברי', 'קממבר', 'חלומי', 'פילדלפיה', 'לאבנה', 'ריקוטה', 'מסקרפונה', 'ממרח גבינה', 'גבינה מותכת', 'חמאה בצל', 'חמאה שום', 'מרגרינה', 'טופו', 'טופו מוקשה'],

            fruits: ['עגבניות', 'עגבניות שרי', 'עגבניות מגי', 'מלפפונים', 'מלפפון בייבי', 'בצל', 'בצל סגול', 'בצל ירוק', 'שום', 'שום קלוף', 'פלפל אדום', 'פלפל ירוק', 'פלפל צהוב', 'פלפל כתום', 'פלפל חריף', 'חסה', 'חסה אייסברג', 'חסה רומית', 'כרוב', 'כרוב סגול', 'כרוב סיני', 'גזר', 'גזר בייבי', 'סלק', 'סלק מבושל', 'תפו״א אדום', 'תפו״א לבן', 'בטטה', 'קישוא', 'קישוא ירוק', 'חציל', 'ברוקולי', 'כרובית', 'תרד', 'תרד בייבי', 'שמיר', 'טרגון', 'ראשאד', 'ריחן', 'נענע', 'רוקט', 'פטרוזיליה', 'כוסברה', 'סלרי', 'שומר', 'קולורבי', 'ארטישוק', 'אספרגוס', 'פטריות שמפיניון', 'פטריות פורטובלו', 'לימון', 'ליים', 'בננות', 'תפוחים ירוקים', 'תפוחים אדומים', 'תפוזים', 'אשכולית', 'אשכולית אדומה', 'פומלה', 'אבטיח', 'מלון', 'מלון גליה', 'ענבים ירוקים', 'ענבים שחורים', 'אגס', 'שזיפים', 'אפרסקים', 'נקטרינות', 'קלמנטינות', 'קיווי', 'רימונים', 'מנגו', 'אננס', 'אבוקדו', 'תותים', 'פטל', 'אוכמניות', 'דובדבנים', 'משמש', 'תאנים', 'פסיפלורה', 'פפאיה', 'קרמבולה', 'ליצ\'י', 'דרקון פרי', 'קוקוס'],

            bakery: ['לחם', 'לחם מלא', 'לחם שיפון', 'לחם כוסמין', 'לחם דגנים', 'לחם פרוס', 'לחם אחיד', 'לחם ללא גלוטן', 'חלה', 'חלה מלאה', 'חלה מתוקה', 'עוגיות', 'עוגיות שוקולד צ\'יפס', 'עוגיות חמאה', 'פיתות', 'פיתות מלאות', 'פיתות מיני', 'לחמניות', 'לחמניות המבורגר', 'לחמניות נקניקיה', 'בגט', 'צ\'בטה', 'פוקצ\'ה', 'רולדה', 'לחם שומשום', 'לחם פשוט', 'מצות', 'מצות מלאות', 'קרקרים', 'לחם קל', 'טורטייה', 'לאפה', 'נאן', 'קרואסון', 'קרואסון שוקולד', 'בריוש', 'סופגניות', 'דונאטס', 'מאפינס', 'עוגת שמרים', 'שטרודל', 'רוגלך', 'בורקס', 'בורקס גבינה', 'בורקס תפו״א', 'בורקס פטריות'],

            spreads: ['נוטלה', 'נוטלה 400 גרם', 'נוטלה 750 גרם', 'ממרח שוקולד', 'ממרח שוקולד השחר העולה', 'ממרח שוקולד עלית', 'ממרח אגוזים', 'ממרח לוטוס', 'חמאת בוטנים', 'חמאת בוטנים חלקה', 'חמאת בוטנים קראנצ\'י', 'חמאת בוטנים סקיפי', 'חמאת שקדים', 'חמאת קשיו', 'חמאת אגוזי לוז', 'טחינה', 'טחינה גולמית', 'טחינה אל ארז', 'טחינה הבאבא', 'חלווה', 'חלווה פרוסה', 'חלווה שוקולד', 'חלווה פיסטוק', 'ריבה', 'ריבה תות', 'ריבה משמש', 'ריבה דובדבן', 'ריבה תפוז', 'ריבה פטל', 'ריבה ללא סוכר', 'מרמלדה', 'דבש', 'דבש טהור', 'דבש פרחים', 'דבש אורגני', 'סילאן', 'סילאן טהור', 'ממרח שום', 'ממרח זיתים', 'ממרח עגבניות מיובשות', 'ממרח ארטישוק', 'פסטו', 'פסטו ירוק', 'פסטו אדום', 'ממרח טונה', 'ממרח חציל', 'חומוס ממרח'],

            baking: ['קמח', 'קמח לבן', 'קמח מלא', 'קמח תירס', 'קמח כוסמין', 'קמח שקדים', 'קמח קוקוס', 'קמח ללא גלוטן', 'קמח תופח', 'קמח לחלה', 'קמח ללחם', 'קמח לפיצה', 'קמח לפוקצ\'ה', 'קמח לבן מנופה', 'קורנפלור', 'עמילן', 'עמילן תירס', 'סוכר', 'סוכר לבן', 'סוכר חום', 'סוכר דמררה', 'סוכר וניל', 'סוכר אבקה', 'סוכרת', 'סטיביה', 'שמרים', 'שמרים יבשים', 'שמרים טריים', 'אבקת אפייה', 'סודה לשתייה', 'וניל', 'תמצית וניל', 'מקלות וניל', 'שוקולד צ\'יפס', 'שוקולד צ\'יפס מריר', 'שוקולד צ\'יפס לבן', 'שוקולד מריר לאפייה', 'שוקולד חלב לאפייה', 'שוקולד לבן לאפייה', 'קקאו', 'אבקת קקאו', 'קוקוס מגורד', 'קוקוס טחון', 'שקדים', 'שקדים טחונים', 'שקדים פרוסים', 'שקדים שלמים', 'אגוזי מלך', 'אגוזי מלך טחונים', 'פקאן', 'פקאן טחון', 'קשיו', 'פיסטוק', 'אגוזי לוז', 'צימוקים', 'חמוציות', 'תמרים', 'תמרים מג\'הול', 'פרג', 'שומשום', 'מרציפן', 'פונדנט', 'בצק סוכר', 'צבעי מאכל', 'סוכריות לקישוט', 'גליטר לאפייה', 'פירורי לחם', 'פירורי ביסקוויט', 'פודינג שוקולד', 'פודינג וניל'],

            meat: ['עוף שלם טרי', 'עוף שלם קפוא', 'חזה עוף טרי', 'חזה עוף קפוא', 'חזה עוף ללא עור טרי', 'חזה עוף ללא עור קפוא', 'חזה עוף פרוס טרי', 'כרעיים עוף טריות', 'כרעיים עוף קפואות', 'שוקיים עוף טריים', 'שוקיים עוף קפואים', 'כנפיים עוף טריות', 'כנפיים עוף קפואות', 'עוף טחון טרי', 'עוף טחון קפוא', 'כבד עוף טרי', 'כבד עוף קפוא', 'לבבות עוף', 'פרגית טרייה', 'פרגית קפואה', 'חזה הודו טרי', 'חזה הודו קפוא', 'הודו טחון טרי', 'הודו טחון קפוא', 'בשר טחון טרי', 'בשר טחון קפוא', 'בשר טחון רזה טרי', 'אנטריקוט טרי', 'אנטריקוט קפוא', 'סינטה טרייה', 'סינטה קפואה', 'פילה בקר טרי', 'פילה בקר קפוא', 'צלעות בקר טריות', 'צלעות בקר קפואות', 'שפונדרה טרייה', 'שפונדרה קפואה', 'אסאדו טרי', 'אסאדו קפוא', 'גולש טרי', 'גולש קפוא', 'בשר לשווארמה טרי', 'בשר לשווארמה קפוא', 'טלה טרי', 'טלה קפוא', 'כבש טרי', 'כבש קפוא', 'שניצל עוף טרי', 'שניצל עוף קפוא', 'שניצל הודו טרי', 'שניצל הודו קפוא', 'קבב טרי', 'קבב קפוא', 'המבורגר טרי', 'המבורגר קפוא', 'המבורגר ביתי', 'נקניקיות עוף', 'נקניקיות בקר', 'סלמון טרי', 'סלמון קפוא', 'סלמון מעושן', 'פילה סלמון טרי', 'פילה סלמון קפוא', 'פילה אמנון טרי', 'פילה אמנון קפוא', 'פילה בורי טרי', 'פילה בורי קפוא', 'פילה דניס טרי', 'פילה דניס קפוא', 'טונה טרייה', 'דג שלם טרי', 'דג שלם קפוא', 'נסיכי ים', 'שרימפס קפוא', 'קלמארי קפוא', 'מולים', 'סרדינים', 'דג מעושן', 'בשר מעובד'],

            desserts: ['מילקי', 'מילקי אוראו', 'דנונה', 'דנונה שוקולד', 'יופלה', 'דניאלה', 'מעדן וניל', 'מעדן שוקולד', 'מעדן קרמל', 'מעדן ביסקוויטים', 'מעדן לוטוס', 'שוקו יטבתה', 'שוקו תנובה', 'מעדן יוגורט', 'מעדן תות', 'מעדן בננה', 'מוס שוקולד', 'מוס וניל', 'פרי גד', 'דן בראון', 'טירמיסו', 'קרם ברולה', 'פנקוטה', 'אורז חלב', 'סהרון', 'גו', 'מונטה', 'קינדר מילק'],

            deli: ['סלמי מעושן', 'נקניק כתף', 'סלמי תה', 'נקניק סלמי קוניאק', 'נקניק מרטלדה', 'רוסטביף', 'כתף בקר מפולפל', 'פסטרמה איטלקית', 'פסטרמה גחלים', 'פסטרמה גריל', 'פסטרמה הודו', 'פסטרמה דבש', 'פסטרמה ברביקיו', 'פסטרמה צלויה על לבנים', 'פסטרמה פרגיות', 'פסטרמה כפרית'],

            salads: ['חומוס', 'טחינה', 'סלט חצילים', 'סלט מטבוחה', 'סלט טורקי', 'סלט כרוב', 'סלט גזר', 'סלט קולסלו', 'סלט ביצים', 'סלט טונה', 'סלט בולגרי', 'סלט ירקות', 'סלט קינואה', 'סלט פסטה', 'סלט עדשים', 'גואקמולה', 'סלסה', 'באבא גנוש', 'סלט חומוס', 'סלט פטריות', 'סלט סלק', 'סלט תפו״א', 'סלט פלפלים קלויים', 'ממרח אבוקדו', 'סלט אבוקדו'],

            canned: ['אורז', 'אורז בסמטי', 'אורז יסמין', 'אורז מלא', 'אורז סושי', 'אורז פרסי', 'פסטה', 'פסטה פנה', 'פסטה ספגטי', 'פסטה פרפלה', 'פסטה פוזילי', 'פסטה לזניה', 'פסטה מלאה', 'קוסקוס', 'קוסקוס מלא', 'קוסקוס פתיתים', 'קטניות', 'רוטב עגבניות', 'רוטב פסטה', 'רסק עגבניות', 'טונה', 'טונה במים', 'טונה בשמן', 'טונה ברוטב', 'תירס', 'תירס מתוק', 'גרגירי תירס', 'שמן זית', 'שמן זית כתית', 'שמן קנולה', 'שמן חמניות', 'שמן תירס', 'שמן שומשום', 'שמן אגוזים', 'חומץ בלסמי', 'חומץ יין', 'חומץ תפוחים', 'חומץ לבן', 'מיץ לימון', 'חומוס', 'חומוס טחון', 'זיתים', 'זיתים שחורים', 'זיתים ירוקים', 'זיתים קלמטה', 'מלפפון חמוץ', 'פלפל חריף', 'פפריקה קלויה', 'בוטנים', 'חיטה', 'בורגול', 'קינואה', 'פריקה', 'נודלס', 'אטריות', 'פול', 'גרגירי חומוס', 'עדשים', 'עדשים כתומות', 'עדשים ירוקות', 'שעועית לבנה', 'שעועית אדומה', 'שעועית שחורה', 'אפונה', 'סויה', 'מאש'],

            cereals: ['קורנפלקס קלאסי', 'קורנפלקס דבש', 'קורנפלקס שוקולד', 'קורנפלקס כריות', 'קורנפלקס פירות', 'טריקס', 'פתיתי תירס', 'גרנולה', 'גרנולה שוקולד', 'גרנולה פירות', 'גרנולה אגוזים', 'מוזלי', 'שיבולת שועל', 'פצפוצי אורז', 'קוואקר', 'דגנים מלאים', 'מיני וויטס', 'צ\'ריוס', 'נסטלה פיטנס', 'סנאק בר', 'חטיף דגנים', 'חטיף גרנולה', 'אול בראן', 'פרוטי לופס', 'קוקו פופס', 'ליון', 'סמאקס', 'צ\'רינגס', 'קראנץ\'', 'סיני קראנץ\'', 'כדורי שוקולד'],

            spices: ['מלח', 'מלח ים', 'מלח שולחן', 'מלח גס', 'פלפל שחור', 'פלפל גרוס', 'פפריקה', 'פפריקה מתוקה', 'פפריקה חריפה', 'פפריקה מעושנת', 'כורכום', 'כמון', 'קינמון', 'קינמון טחון', 'מקלות קינמון', 'אבקת שום', 'אבקת בצל', 'אורגנו', 'בזיליקום', 'זעתר', 'סומק', 'חוואייג׳', 'תבלין לעוף', 'תבלין לדגים', 'תבלין לבשר', 'תבלין גריל', 'קארי', 'גרם מסאלה', 'ציילי', 'קיאן', 'זנגביל', 'אגוז מוסקט', 'ציפורן', 'כוסברה טחונה', 'קרדמון', 'עלי דפנה', 'רוזמרין', 'טימין', 'פפריקה מנטה', 'הל', 'כוכב אניס', 'שומר', 'עירית', 'מרווה'],

            coffee: ['קפה נמס', 'קפה ג\'קובס', 'קפה טורקי', 'קפה שחור', 'קפה נספרסו', 'קפה נטול קפאין', 'קפסולות נספרסו', 'קפסולות דולצ\'ה', 'קפסולות לוואצה', 'קפסולות טאסימו', 'קפסולות לנדוור', 'קפה קלוי טחון', 'תה שחור', 'תה ירוק', 'תה ירוק יסמין', 'תה צמחים', 'תה נענע', 'תה לואיזה', 'תה ליפטון', 'תה ויסוצקי', 'תה פוקימון', 'תה קמומיל', 'תה מרווה', 'תה ג\'ינג\'ר', 'תה לימון', 'תה ארל גריי', 'תה אנגלי', 'חלב מרוכז', 'אייס קפה', 'קקאו שוקו', 'אבקת קקאו'],

            drinks: ['מים בטעמים', 'מי עדן', 'נביעות', 'קולה 1.5 ליטר', 'קולה 1 ליטר', 'קולה פחית', 'שישיית קולה', 'שישיית קולה פחיות', 'קולה זירו 1.5 ליטר', 'קולה זירו 1 ליטר', 'קולה זירו פחית', 'שישיית קולה זירו', 'קולה דיאט', 'קולה דיאט 1.5 ליטר', 'פפסי', 'פפסי 1.5 ליטר', 'פפסי פחית', 'שישיית פפסי', 'פפסי מקס', 'פפסי מקס 1.5 ליטר', 'ספרייט', 'ספרייט 1.5 ליטר', 'ספרייט פחית', 'שישיית ספרייט', 'ספרייט זירו', 'פאנטה', 'פאנטה 1.5 ליטר', 'פאנטה פחית', 'שישיית פאנטה', 'סודה', 'סודה פחית', 'טוניק', 'טוניק פחית', 'מיץ תפוזים', 'מיץ תפוזים סחוט', 'מיץ תפוזים 1 ליטר', 'מיץ תפוחים', 'מיץ ענבים', 'מיץ גזר', 'מיץ רימונים', 'מיץ פריגת', 'מיץ ספרינג', 'נקטר', 'תפוזינה', 'לימונדה', 'לימונענע', 'XL אנרגיה', 'XL פחית', 'רד בול', 'רד בול פחית', 'מונסטר', 'מונסטר פחית', 'משקה ספורט', 'משקה אנרגיה', 'משקה איזוטוני', 'מי קוקוס'],

            wine: ['יין אדום', 'יין לבן', 'יין רוזה', 'יין מבעבע', 'יין יבש', 'יין חצי יבש', 'יין מתוק', 'יין קידוש', 'יין לפסח', 'יין ברקן', 'יין יקב גולן', 'יין כרמל', 'יין טפרברג', 'יין גלנס', 'יין פסגות', 'יין רמת נגב', 'יין ארזה', 'יין יתיר', 'שמפניה', 'פרוסקו', 'קאווה', 'אסתי', 'בירה', 'בירה גולדסטאר', 'בירה מכבי', 'בירה קרלסברג', 'בירה הייניקן', 'בירה קורונה', 'בירה סטלה', 'בירה טובורג', 'בירה אלכסנדר', 'בירה בזלת', 'בירה מלכה', 'בירה ללא אלכוהול', 'סיידר', 'סיידר תפוחים', 'ערק', 'ערק אלית', 'וודקה', 'וודקה אבסולוט', 'וודקה סמירנוף', 'וודקה גריי גוס', 'וויסקי', 'וויסקי ג\'וני ווקר', 'וויסקי ג\'ק דניאלס', 'וויסקי ג\'יימסון', 'רום', 'רום בקרדי', 'ג\'ין', 'ג\'ין גורדונס', 'טקילה', 'קוניאק', 'בראנדי', 'ליקר', 'ליקר קפה', 'ליקר שוקולד', 'ליקר פירות', 'אמרטו', 'בייליס', 'קמפרי', 'אפרול', 'סנגריה'],

            snacks: ['במבה', 'במבה אדומים', 'במבה נוגט', 'ביסלי', 'ביסלי גריל', 'ביסלי בצל', 'ביסלי פיצה', 'דוריטוס', 'דוריטוס צ\'ילי', 'טורטייה צ\'יפס', 'תפוצ\'יפס', 'פרינגלס', 'פרינגלס חמוץ', 'פופקורן', 'פופקורן מיקרו', 'פופקורן קרמל', 'שוקולד', 'שוקולד פרה', 'שוקולד מילקה', 'שוקולד חלב', 'שוקולד מריר', 'שוקולד לבן', 'שוקולד עם אגוזים', 'קינדר', 'סניקרס', 'מארס', 'טוויקס', 'קיטקט', 'ביסקוויטים', 'עוגיות אוראו', 'עוגיות לוטוס', 'וופלים', 'וופל בלגי', 'קצפת', 'מרשמלו', 'סוכריות', 'סוכריות גומי', 'דובונים', 'מסטיק', 'מנטוס', 'טיק טק', 'עוגת שוקולד', 'עוגת גבינה', 'רולדה', 'קרמבו', 'פסק זמן', 'קליק', 'טעמי'],

            frozen: ['גלידה', 'גלידה וניל', 'גלידה שוקולד', 'גלידה תות', 'גלידה פיסטוק', 'גלידה קרמל', 'גלידת פרווה', 'ארטיק', 'מגנום', 'קורנטו', 'שלגון', 'פירות קפואים', 'תותים קפואים', 'פטל קפוא', 'אוכמניות קפואות', 'מנגו קפוא', 'ירקות קפואים', 'ירקות מוקפצים', 'אפונה קפואה', 'תירס קפוא', 'שעועית ירוקה קפואה', 'ברוקולי קפוא', 'תרד קפוא', 'שניצל קפוא', 'נאגטס קפואים', 'קציצות קפואות', 'המבורגר קפוא', 'פיצה קפואה', 'פיצה משפחתית', 'לזניה קפואה', 'בצק עלים', 'בצק פילו', 'בצק פיצה', 'בצק מאפים', 'בצק ג\'חנון', 'בצק מלווח', 'בצק סמבוסק', 'בצק בורקס', 'בלינצ\'ס', 'קרפ', 'וופל קפוא', 'עוף צלוי מוכן', 'ג\'חנון אפוי מוכן'],

            health: ['יוגורט יווני 0%', 'יוגורט חלבון', 'יוגורט פרוביוטי', 'קוטג\' 0%', 'קוטג\' 3%', 'גבינה לבנה 0%', 'חלב סויה', 'חלב שקדים', 'חלב קוקוס', 'חלב אורז', 'חלב שיבולת שועל', 'חלב דל לקטוז', 'משקה חלבון', 'שייק חלבון', 'אבקת חלבון', 'פרוטאין בר', 'חטיף חלבון', 'חטיף אנרגיה', 'לחם מלא', 'לחם ללא גלוטן', 'פיתה מלאה', 'קרקר דגנים', 'קרקר אורז', 'טונה במים', 'סלט טונה', 'חזה עוף מעושן', 'גרנולה בריאות', 'שיבולת שועל', 'זרעי צ\'יה', 'זרעי פשתן', 'קינואה', 'אגוזים טבעיים', 'שקדים טבעיים', 'פירות יבשים ללא סוכר', 'חמוציות', 'גוג\'י ברי', 'ספירולינה', 'ויטמינים', 'אומגה 3', 'פרוביוטיקה'],

            cleaning: ['נייר טואלט', 'נייר טואלט תלת שכבתי', 'מגבות נייר', 'מגבות נייר לידיים', 'ממחטות נייר', 'סבון כלים', 'סבון כלים פיירי', 'נוזל כלים', 'אבקת כביסה', 'אבקת כביסה אריאל', 'ג\'ל כביסה', 'ג\'ל כביסה מרוכז', 'קפסולות כביסה', 'מרכך כביסה', 'מבשם כביסה', 'אקונומיקה', 'אקונומיקה ג\'ל', 'מאיץ כביסה', 'מנקה רצפות', 'מנקה רצפות סנו', 'מנקה חלונות', 'מנקה אמבטיה', 'מנקה שירותים', 'מנקה כיריים', 'מנקה תנור', 'מנקה שומנים', 'אבקת ניקוי', 'סיף', 'מר מוסקל', 'ספוגים', 'ספוגי פלדה', 'מטליות רצפה', 'מטליות ניקוי', 'שקיות אשפה', 'שקיות אשפה גדולות', 'שקיות אשפה ריחניות', 'שקיות זיפלוק', 'שקיות כריכים', 'שקיות קפואים', 'נייר אפייה', 'נייר אלומיניום', 'ניילון נצמד', 'טבליות למדיח', 'מלח למדיח', 'נוזל מבריק למדיח', 'מנקה מדיח', 'מטהר אוויר', 'גרייני אשפה'],

            hygiene: ['סבון ידיים', 'סבון ידיים נוזלי', 'מגבונים לחים', 'ג\'ל אלכוהול', 'מברשת שיניים', 'מברשת שיניים חשמלית', 'ראשים למברשת', 'משחת שיניים', 'משחת שיניים סנסודיין', 'מי פה', 'חוט דנטלי', 'קיסמי שיניים', 'שמפו', 'שמפו הד אנד שולדרס', 'שמפו פנטן', 'שמפו לשיער יבש', 'שמפו לשיער שמן', 'שמפו נגד קשקשים', 'מרכך שיער', 'מסכה לשיער', 'סרום לשיער', 'ספריי לשיער', 'ג\'ל לשיער', 'קצף לשיער', 'שמפו לילדים', 'סבון גוף', 'ג\'ל רחצה', 'ג\'ל רחצה ניוואה', 'קרם גילוח', 'ג\'ל גילוח', 'סכיני גילוח', 'סכיני גילוח ג\'ילט', 'דאודורנט', 'דאודורנט רול און', 'דאודורנט ספריי', 'אנטיפרספירנט', 'קרם פנים', 'קרם לחות', 'קרם ידיים', 'קרם גוף', 'קרם רגליים', 'שמן גוף', 'לוסיון גוף', 'תחבושות', 'פלסטריה', 'צמר גפן', 'מקלוני אוזניים', 'טמפונים', 'מגני תחתון', 'תחבושות יום', 'תחבושות לילה', 'קרם הגנה', 'קרם שיזוף', 'אפטר סאן', 'מסיר איפור', 'מגבונים להסרת איפור'],

            candles: ['נרות שבת', 'נרות חנוכה', 'נרות חנוכה צבעוניים', 'נר נשמה 24 שעות', 'נר נשמה 48 שעות', 'נר נשמה 7 ימים', 'נר הבדלה', 'נרות יום הולדת', 'נרות ריחניים', 'נרות דקורטיביים', 'פתילות', 'גפרורים', 'מציתים'],

            baby: ['חיתולים מידה 1', 'חיתולים מידה 2', 'חיתולים מידה 3', 'חיתולים מידה 4', 'חיתולים מידה 5', 'חיתולים מידה 6', 'מכנסוני חיתול', 'חיתולי לילה', 'מגבונים לתינוקות', 'מגבונים רגישים', 'שמפו לתינוקות', 'סבון לתינוקות', 'אל סבון לתינוקות', 'קרם החתלה', 'קרם פוש', 'קרם דסיטין', 'משחת החתלה', 'שמן תינוקות', 'קרם פנים לתינוק', 'אבקת חלב סימילאק', 'אבקת חלב מטרנה', 'מחית פירות', 'מחית ירקות', 'דייסה לתינוקות', 'ביסלי לתינוקות', 'חטיף תינוקות', 'מיץ לתינוקות', 'מוצצים', 'בקבוק תינוק', 'פטמות', 'מברשת שיניים לתינוק', 'משחת שיניים לתינוק', 'שמפו ילדים', 'סבון ילדים'],

            pets: ['מזון לכלבים', 'מזון יבש לכלבים', 'מזון רטוב לכלבים', 'מזון לכלבים בוגרים', 'מזון לגורים', 'מזון לחתולים', 'מזון יבש לחתולים', 'מזון רטוב לחתולים', 'מזון לחתולים בוגרים', 'מזון לגורי חתולים', 'חול לחתולים', 'חול מתגבש', 'חול סיליקה', 'חטיפים לכלבים', 'חטיפים לחתולים', 'עצמות לכעיסה', 'דנטסטיקס', 'צעצועים לכלבים', 'צעצועים לחתולים', 'מיטה לכלב', 'מיטה לחתול', 'קערת אוכל', 'קערת מים', 'רצועה לכלב', 'קולר', 'מסרק לכלב', 'שמפו לכלבים', 'שקיות קקי', 'משטח אימון', 'מזון לדגים', 'מזון לציפורים', 'מזון לאוגרים']
        };

        // Product translations for multi-language support
        const PRODUCT_TRANSLATIONS = {
            // Dairy - מוצרי חלב
            'חלב 3%': { en: 'Milk 3%', ru: 'Молоко 3%', ar: 'حليب 3%' },
            'חלב 1%': { en: 'Milk 1%', ru: 'Молоко 1%', ar: 'حليب 1%' },
            'חלב דל שומן': { en: 'Low Fat Milk', ru: 'Обезжиренное молоко', ar: 'حليب قليل الدسم' },
            'חלב סויה': { en: 'Soy Milk', ru: 'Соевое молоко', ar: 'حليب الصويا' },
            'חלב שקדים': { en: 'Almond Milk', ru: 'Миндальное молоко', ar: 'حليب اللوز' },
            'חלב קוקוס': { en: 'Coconut Milk', ru: 'Кокосовое молоко', ar: 'حليب جوز الهند' },
            'חלב שיבולת שועל': { en: 'Oat Milk', ru: 'Овсяное молоко', ar: 'حليب الشوفان' },
            'לבן': { en: 'Laban', ru: 'Лабан', ar: 'لبن' },
            'לבן עז': { en: 'Goat Laban', ru: 'Козий лабан', ar: 'لبن ماعز' },
            'גבינה צהובה עמק': { en: 'Emek Yellow Cheese', ru: 'Жёлтый сыр Эмек', ar: 'جبنة صفراء عمق' },
            'גבינה צהובה גלבוע': { en: 'Gilboa Yellow Cheese', ru: 'Жёлтый сыр Гильбоа', ar: 'جبنة صفراء جلبوع' },
            'גבינה צהובה 9%': { en: 'Yellow Cheese 9%', ru: 'Жёлтый сыр 9%', ar: 'جبنة صفراء 9%' },
            'גבינה צהובה 22%': { en: 'Yellow Cheese 22%', ru: 'Жёлтый сыр 22%', ar: 'جبنة صفراء 22%' },
            'קוטג׳ 5%': { en: 'Cottage Cheese 5%', ru: 'Творог 5%', ar: 'جبنة قريش 5%' },
            'קוטג׳ 3%': { en: 'Cottage Cheese 3%', ru: 'Творог 3%', ar: 'جبنة قريش 3%' },
            'גבינה בולגרית': { en: 'Bulgarian Cheese', ru: 'Болгарский сыр', ar: 'جبنة بلغارية' },
            'צפתית': { en: 'Tzfatit Cheese', ru: 'Сыр Цфатит', ar: 'جبنة صفد' },
            'גבינת שמנת': { en: 'Cream Cheese', ru: 'Сливочный сыр', ar: 'جبنة كريمية' },
            'פרמזן': { en: 'Parmesan', ru: 'Пармезан', ar: 'بارميزان' },
            'מוצרלה': { en: 'Mozzarella', ru: 'Моцарелла', ar: 'موزاريلا' },
            'ביצים': { en: 'Eggs', ru: 'Яйца', ar: 'بيض' },
            'ביצים L': { en: 'Eggs L', ru: 'Яйца L', ar: 'بيض L' },
            'ביצים XL': { en: 'Eggs XL', ru: 'Яйца XL', ar: 'بيض XL' },
            'ביצים אורגניות': { en: 'Organic Eggs', ru: 'Органические яйца', ar: 'بيض عضوي' },
            'ביצים חופשיות': { en: 'Free Range Eggs', ru: 'Яйца свободного выгула', ar: 'بيض حر' },
            'חמאה': { en: 'Butter', ru: 'Масло', ar: 'زبدة' },
            'חמאה מלוחה': { en: 'Salted Butter', ru: 'Солёное масло', ar: 'زبدة مملحة' },
            'שמנת מתוקה': { en: 'Sweet Cream', ru: 'Сладкие сливки', ar: 'قشطة حلوة' },
            'שמנת חמוצה': { en: 'Sour Cream', ru: 'Сметана', ar: 'قشطة حامضة' },
            'שמנת לקצפת': { en: 'Whipping Cream', ru: 'Взбитые сливки', ar: 'كريمة للخفق' },
            'יוגורט': { en: 'Yogurt', ru: 'Йогурт', ar: 'زبادي' },
            'יוגורט יווני': { en: 'Greek Yogurt', ru: 'Греческий йогурт', ar: 'زبادي يوناني' },
            'יוגורט יווני 0%': { en: 'Greek Yogurt 0%', ru: 'Греческий йогурт 0%', ar: 'زبادي يوناني 0%' },
            'יוגורט תנובה': { en: 'Tnuva Yogurt', ru: 'Йогурт Тнува', ar: 'زبادي تنوفا' },
            'יוגורט שטראוס': { en: 'Strauss Yogurt', ru: 'Йогурт Штраус', ar: 'زبادي شتراوس' },
            'יוגורט אקטיביה': { en: 'Activia Yogurt', ru: 'Йогурт Активиа', ar: 'زبادي أكتيفيا' },
            'גבינה לבנה 5%': { en: 'White Cheese 5%', ru: 'Белый сыр 5%', ar: 'جبنة بيضاء 5%' },
            'גבינה לבנה 9%': { en: 'White Cheese 9%', ru: 'Белый сыр 9%', ar: 'جبنة بيضاء 9%' },
            'יוגורט אורגני': { en: 'Organic Yogurt', ru: 'Органический йогурт', ar: 'زبادي عضوي' },
            'יוגורט לילדים': { en: 'Kids Yogurt', ru: 'Детский йогурт', ar: 'زبادي للأطفال' },
            'גבינת עזים': { en: 'Goat Cheese', ru: 'Козий сыр', ar: 'جبنة ماعز' },
            'גבינת רוקפור': { en: 'Roquefort', ru: 'Рокфор', ar: 'روكفور' },
            'קשקבל': { en: 'Kashkaval', ru: 'Кашкавал', ar: 'قشقوان' },
            'גאודה': { en: 'Gouda', ru: 'Гауда', ar: 'جودا' },
            'אמנטל': { en: 'Emmental', ru: 'Эмменталь', ar: 'إيمنتال' },
            'ברי': { en: 'Brie', ru: 'Бри', ar: 'بري' },
            'קממבר': { en: 'Camembert', ru: 'Камамбер', ar: 'كاممبير' },
            'חלומי': { en: 'Halloumi', ru: 'Халлуми', ar: 'حلوم' },
            'פילדלפיה': { en: 'Philadelphia', ru: 'Филадельфия', ar: 'فيلادلفيا' },
            'לאבנה': { en: 'Labneh', ru: 'Лабне', ar: 'لبنة' },
            'ריקוטה': { en: 'Ricotta', ru: 'Рикотта', ar: 'ريكوتا' },
            'מסקרפונה': { en: 'Mascarpone', ru: 'Маскарпоне', ar: 'ماسكاربوني' },
            'ממרח גבינה': { en: 'Cheese Spread', ru: 'Сырная намазка', ar: 'جبنة قابلة للدهن' },
            'גבינה מותכת': { en: 'Processed Cheese', ru: 'Плавленый сыр', ar: 'جبنة مطبوخة' },
            'חמאה בצל': { en: 'Onion Butter', ru: 'Луковое масло', ar: 'زبدة بالبصل' },
            'חמאה שום': { en: 'Garlic Butter', ru: 'Чесночное масло', ar: 'زبدة بالثوم' },
            'מרגרינה': { en: 'Margarine', ru: 'Маргарин', ar: 'مارجرين' },
            'טופו': { en: 'Tofu', ru: 'Тофу', ar: 'توفو' },
            'טופו מוקשה': { en: 'Firm Tofu', ru: 'Твёрдый тофу', ar: 'توفو صلب' },
            // Fruits & Vegetables - פירות וירקות
            'עגבניות': { en: 'Tomatoes', ru: 'Помидоры', ar: 'طماطم' },
            'עגבניות שרי': { en: 'Cherry Tomatoes', ru: 'Черри помидоры', ar: 'طماطم كرزية' },
            'עגבניות מגי': { en: 'Maggi Tomatoes', ru: 'Помидоры Магги', ar: 'طماطم ماجي' },
            'מלפפונים': { en: 'Cucumbers', ru: 'Огурцы', ar: 'خيار' },
            'מלפפון בייבי': { en: 'Baby Cucumber', ru: 'Мини огурцы', ar: 'خيار صغير' },
            'בצל': { en: 'Onion', ru: 'Лук', ar: 'بصل' },
            'בצל סגול': { en: 'Red Onion', ru: 'Красный лук', ar: 'بصل أحمر' },
            'בצל ירוק': { en: 'Green Onion', ru: 'Зелёный лук', ar: 'بصل أخضر' },
            'שום': { en: 'Garlic', ru: 'Чеснок', ar: 'ثوم' },
            'שום קלוף': { en: 'Peeled Garlic', ru: 'Очищенный чеснок', ar: 'ثوم مقشر' },
            'פלפל אדום': { en: 'Red Pepper', ru: 'Красный перец', ar: 'فلفل أحمر' },
            'פלפל ירוק': { en: 'Green Pepper', ru: 'Зелёный перец', ar: 'فلفل أخضر' },
            'פלפל צהוב': { en: 'Yellow Pepper', ru: 'Жёлтый перец', ar: 'فلفل أصفر' },
            'פלפל כתום': { en: 'Orange Pepper', ru: 'Оранжевый перец', ar: 'فلفل برتقالي' },
            'פלפל חריף': { en: 'Hot Pepper', ru: 'Острый перец', ar: 'فلفل حار' },
            'חסה': { en: 'Lettuce', ru: 'Салат', ar: 'خس' },
            'חסה אייסברג': { en: 'Iceberg Lettuce', ru: 'Айсберг салат', ar: 'خس آيسبرج' },
            'חסה רומית': { en: 'Romaine Lettuce', ru: 'Ромэн салат', ar: 'خس روماني' },
            'כרוב': { en: 'Cabbage', ru: 'Капуста', ar: 'ملفوف' },
            'כרוב סגול': { en: 'Red Cabbage', ru: 'Красная капуста', ar: 'ملفوف أحمر' },
            'כרוב סיני': { en: 'Chinese Cabbage', ru: 'Китайская капуста', ar: 'ملفوف صيني' },
            'גזר': { en: 'Carrot', ru: 'Морковь', ar: 'جزر' },
            'גזר בייבי': { en: 'Baby Carrot', ru: 'Мини морковь', ar: 'جزر صغير' },
            'סלק': { en: 'Beet', ru: 'Свёкла', ar: 'شمندر' },
            'סלק מבושל': { en: 'Cooked Beet', ru: 'Варёная свёкла', ar: 'شمندر مطبوخ' },
            'תפו״א אדום': { en: 'Red Potato', ru: 'Красный картофель', ar: 'بطاطا حمراء' },
            'תפו״א לבן': { en: 'White Potato', ru: 'Белый картофель', ar: 'بطاطا بيضاء' },
            'בטטה': { en: 'Sweet Potato', ru: 'Батат', ar: 'بطاطا حلوة' },
            'קישוא': { en: 'Zucchini', ru: 'Кабачок', ar: 'كوسا' },
            'קישוא ירוק': { en: 'Green Zucchini', ru: 'Зелёный кабачок', ar: 'كوسا خضراء' },
            'חציל': { en: 'Eggplant', ru: 'Баклажан', ar: 'باذنجان' },
            'ברוקולי': { en: 'Broccoli', ru: 'Брокколи', ar: 'بروكلي' },
            'כרובית': { en: 'Cauliflower', ru: 'Цветная капуста', ar: 'قرنبيط' },
            'תרד': { en: 'Spinach', ru: 'Шпинат', ar: 'سبانخ' },
            'תרד בייבי': { en: 'Baby Spinach', ru: 'Мини шпинат', ar: 'سبانخ صغير' },
            'שמיר': { en: 'Dill', ru: 'Укроп', ar: 'شبت' },
            'טרגון': { en: 'Tarragon', ru: 'Эстрагон', ar: 'طرخون' },
            'ראשאד': { en: 'Arugula', ru: 'Руккола', ar: 'جرجير' },
            'ריחן': { en: 'Basil', ru: 'Базилик', ar: 'ريحان' },
            'נענע': { en: 'Mint', ru: 'Мята', ar: 'نعناع' },
            'רוקט': { en: 'Rocket', ru: 'Рукола', ar: 'روكا' },
            'פטרוזיליה': { en: 'Parsley', ru: 'Петрушка', ar: 'بقدونس' },
            'כוסברה': { en: 'Coriander', ru: 'Кориандр', ar: 'كزبرة' },
            'סלרי': { en: 'Celery', ru: 'Сельдерей', ar: 'كرفس' },
            'שומר': { en: 'Fennel', ru: 'Фенхель', ar: 'شمر' },
            'קולורבי': { en: 'Kohlrabi', ru: 'Кольраби', ar: 'كرنب ساقي' },
            'ארטישוק': { en: 'Artichoke', ru: 'Артишок', ar: 'خرشوف' },
            'אספרגוס': { en: 'Asparagus', ru: 'Спаржа', ar: 'هليون' },
            'פטריות שמפיניון': { en: 'Champignon Mushrooms', ru: 'Шампиньоны', ar: 'فطر شامبينيون' },
            'פטריות פורטובלו': { en: 'Portobello Mushrooms', ru: 'Портобелло грибы', ar: 'فطر بورتوبيلو' },
            'לימון': { en: 'Lemon', ru: 'Лимон', ar: 'ليمون' },
            'ליים': { en: 'Lime', ru: 'Лайм', ar: 'ليمون أخضر' },
            'בננות': { en: 'Bananas', ru: 'Бананы', ar: 'موز' },
            'תפוחים ירוקים': { en: 'Green Apples', ru: 'Зелёные яблоки', ar: 'تفاح أخضر' },
            'תפוחים אדומים': { en: 'Red Apples', ru: 'Красные яблоки', ar: 'تفاح أحمر' },
            'תפוזים': { en: 'Oranges', ru: 'Апельсины', ar: 'برتقال' },
            'אשכולית': { en: 'Grapefruit', ru: 'Грейпфрут', ar: 'جريب فروت' },
            'אשכולית אדומה': { en: 'Red Grapefruit', ru: 'Красный грейпфрут', ar: 'جريب فروت أحمر' },
            'פומלה': { en: 'Pomelo', ru: 'Помело', ar: 'بوملي' },
            'אבטיח': { en: 'Watermelon', ru: 'Арбуз', ar: 'بطيخ' },
            'מלון': { en: 'Melon', ru: 'Дыня', ar: 'شمام' },
            'מלון גליה': { en: 'Galia Melon', ru: 'Дыня Галия', ar: 'شمام جاليا' },
            'ענבים ירוקים': { en: 'Green Grapes', ru: 'Зелёный виноград', ar: 'عنب أخضر' },
            'ענבים שחורים': { en: 'Black Grapes', ru: 'Чёрный виноград', ar: 'عنب أسود' },
            'אגס': { en: 'Pear', ru: 'Груша', ar: 'كمثرى' },
            'שזיפים': { en: 'Plums', ru: 'Сливы', ar: 'برقوق' },
            'אפרסקים': { en: 'Peaches', ru: 'Персики', ar: 'خوخ' },
            'נקטרינות': { en: 'Nectarines', ru: 'Нектарины', ar: 'نكتارين' },
            'קלמנטינות': { en: 'Clementines', ru: 'Клементины', ar: 'كلمنتينا' },
            'קיווי': { en: 'Kiwi', ru: 'Киви', ar: 'كيوي' },
            'רימונים': { en: 'Pomegranates', ru: 'Гранаты', ar: 'رمان' },
            'מנגו': { en: 'Mango', ru: 'Манго', ar: 'مانجو' },
            'אננס': { en: 'Pineapple', ru: 'Ананас', ar: 'أناناس' },
            'אבוקדו': { en: 'Avocado', ru: 'Авокадо', ar: 'أفوكادو' },
            'תותים': { en: 'Strawberries', ru: 'Клубника', ar: 'فراولة' },
            'פטל': { en: 'Raspberries', ru: 'Малина', ar: 'توت العليق' },
            'אוכמניות': { en: 'Blueberries', ru: 'Черника', ar: 'توت أزرق' },
            'דובדבנים': { en: 'Cherries', ru: 'Черешня', ar: 'كرز' },
            'משמש': { en: 'Apricots', ru: 'Абрикосы', ar: 'مشمش' },
            'תאנים': { en: 'Figs', ru: 'Инжир', ar: 'تين' },
            'פסיפלורה': { en: 'Passion Fruit', ru: 'Маракуйя', ar: 'فاكهة العاطفة' },
            'פפאיה': { en: 'Papaya', ru: 'Папайя', ar: 'بابايا' },
            'קרמבולה': { en: 'Star Fruit', ru: 'Карамбола', ar: 'فاكهة النجمة' },
            'ליצ\'י': { en: 'Lychee', ru: 'Личи', ar: 'ليتشي' },
            'דרקון פרי': { en: 'Dragon Fruit', ru: 'Драконий фрукт', ar: 'فاكهة التنين' },
            'קוקוס': { en: 'Coconut', ru: 'Кокос', ar: 'جوز الهند' },
            // Bakery - לחם ומאפים
            'לחם': { en: 'Bread', ru: 'Хлеб', ar: 'خبز' },
            'לחם מלא': { en: 'Whole Wheat Bread', ru: 'Цельнозерновой хлеб', ar: 'خبز قمح كامل' },
            'לחם שיפון': { en: 'Rye Bread', ru: 'Ржаной хлеб', ar: 'خبز الجاودار' },
            'לחם כוסמין': { en: 'Spelt Bread', ru: 'Хлеб из спельты', ar: 'خبز الحنطة' },
            'לחם דגנים': { en: 'Multigrain Bread', ru: 'Мультизерновой хлеб', ar: 'خبز متعدد الحبوب' },
            'לחם פרוס': { en: 'Sliced Bread', ru: 'Нарезанный хлеб', ar: 'خبز مقطع' },
            'לחם אחיד': { en: 'White Bread', ru: 'Белый хлеб', ar: 'خبز أبيض' },
            'לחם ללא גלוטן': { en: 'Gluten Free Bread', ru: 'Безглютеновый хлеб', ar: 'خبز خالي من الغلوتين' },
            'חלה': { en: 'Challah', ru: 'Хала', ar: 'خبز الحلة' },
            'חלה מלאה': { en: 'Whole Wheat Challah', ru: 'Цельнозерновая хала', ar: 'حلة قمح كامل' },
            'חלה מתוקה': { en: 'Sweet Challah', ru: 'Сладкая хала', ar: 'حلة حلوة' },
            'עוגיות': { en: 'Cookies', ru: 'Печенье', ar: 'بسكويت' },
            'עוגיות שוקולד צ\'יפס': { en: 'Chocolate Chip Cookies', ru: 'Печенье с шоколадной крошкой', ar: 'بسكويت رقائق الشوكولاتة' },
            'עוגיות חמאה': { en: 'Butter Cookies', ru: 'Масляное печенье', ar: 'بسكويت الزبدة' },
            'פיתות': { en: 'Pita Bread', ru: 'Пита', ar: 'خبز بيتا' },
            'פיתות מלאות': { en: 'Whole Wheat Pita', ru: 'Цельнозерновая пита', ar: 'بيتا قمح كامل' },
            'פיתות מיני': { en: 'Mini Pita', ru: 'Мини пита', ar: 'بيتا صغيرة' },
            'לחמניות': { en: 'Rolls', ru: 'Булочки', ar: 'خبز صغير' },
            'לחמניות המבורגר': { en: 'Hamburger Buns', ru: 'Булочки для гамбургера', ar: 'خبز الهمبرغر' },
            'לחמניות נקניקיה': { en: 'Hot Dog Buns', ru: 'Булочки для хот-дога', ar: 'خبز النقانق' },
            'בגט': { en: 'Baguette', ru: 'Багет', ar: 'باجيت' },
            'צ\'בטה': { en: 'Ciabatta', ru: 'Чиабатта', ar: 'تشاباتا' },
            'פוקצ\'ה': { en: 'Focaccia', ru: 'Фокачча', ar: 'فوكاتشيا' },
            'רולדה': { en: 'Roll Cake', ru: 'Рулет', ar: 'رولاد' },
            'לחם שומשום': { en: 'Sesame Bread', ru: 'Кунжутный хлеб', ar: 'خبز السمسم' },
            'לחם פשוט': { en: 'Plain Bread', ru: 'Простой хлеб', ar: 'خبز عادي' },
            'מצות': { en: 'Matzah', ru: 'Маца', ar: 'ماتزا' },
            'מצות מלאות': { en: 'Whole Wheat Matzah', ru: 'Цельнозерновая маца', ar: 'ماتزا قمح كامل' },
            'קרקרים': { en: 'Crackers', ru: 'Крекеры', ar: 'مقرمشات' },
            'לחם קל': { en: 'Light Bread', ru: 'Лёгкий хлеб', ar: 'خبز خفيف' },
            'טורטייה': { en: 'Tortilla', ru: 'Тортилья', ar: 'تورتيلا' },
            'לאפה': { en: 'Laffa', ru: 'Лафа', ar: 'لفة' },
            'נאן': { en: 'Naan', ru: 'Наан', ar: 'نان' },
            'קרואסון': { en: 'Croissant', ru: 'Круассан', ar: 'كرواسون' },
            'קרואסון שוקולד': { en: 'Chocolate Croissant', ru: 'Круассан с шоколадом', ar: 'كرواسون شوكولاتة' },
            'בריוש': { en: 'Brioche', ru: 'Бриошь', ar: 'بريوش' },
            'סופגניות': { en: 'Donuts', ru: 'Пончики', ar: 'دونات' },
            'דונאטס': { en: 'Donuts', ru: 'Пончики', ar: 'دونات' },
            'מאפינס': { en: 'Muffins', ru: 'Маффины', ar: 'مافن' },
            'עוגת שמרים': { en: 'Yeast Cake', ru: 'Дрожжевой пирог', ar: 'كعكة خميرة' },
            'שטרודל': { en: 'Strudel', ru: 'Штрудель', ar: 'شترودل' },
            'רוגלך': { en: 'Rugelach', ru: 'Ругелах', ar: 'روجلاخ' },
            'בורקס': { en: 'Bourekas', ru: 'Борекас', ar: 'بوريك' },
            'בורקס גבינה': { en: 'Cheese Bourekas', ru: 'Борекас с сыром', ar: 'بوريك جبنة' },
            'בורקס תפו״א': { en: 'Potato Bourekas', ru: 'Борекас с картофелем', ar: 'بوريك بطاطا' },
            'בורקס פטריות': { en: 'Mushroom Bourekas', ru: 'Борекас с грибами', ar: 'بوريك فطر' },
            // Spreads - ממרחים
            'נוטלה': { en: 'Nutella', ru: 'Нутелла', ar: 'نوتيلا' },
            'נוטלה 400 גרם': { en: 'Nutella 400g', ru: 'Нутелла 400г', ar: 'نوتيلا 400 غرام' },
            'נוטלה 750 גרם': { en: 'Nutella 750g', ru: 'Нутелла 750г', ar: 'نوتيلا 750 غرام' },
            'ממרח שוקולד': { en: 'Chocolate Spread', ru: 'Шоколадная паста', ar: 'شوكولاتة قابلة للدهن' },
            'ממרח שוקולד השחר העולה': { en: 'Hashachar Haole Spread', ru: 'Паста Хашахар Хаоле', ar: 'شوكولاتة هشحر هعولي' },
            'ממרח שוקולד עלית': { en: 'Elite Chocolate Spread', ru: 'Шоколадная паста Элит', ar: 'شوكولاتة إيليت' },
            'ממרח אגוזים': { en: 'Nut Spread', ru: 'Ореховая паста', ar: 'معجون مكسرات' },
            'ממרח לוטוס': { en: 'Lotus Spread', ru: 'Паста Лотус', ar: 'معجون لوتس' },
            'חמאת בוטנים': { en: 'Peanut Butter', ru: 'Арахисовая паста', ar: 'زبدة الفول السوداني' },
            'חמאת בוטנים חלקה': { en: 'Smooth Peanut Butter', ru: 'Гладкая арахисовая паста', ar: 'زبدة فول سوداني ناعمة' },
            'חמאת בוטנים קראנצ\'י': { en: 'Crunchy Peanut Butter', ru: 'Хрустящая арахисовая паста', ar: 'زبدة فول سوداني مقرمشة' },
            'חמאת בוטנים סקיפי': { en: 'Skippy Peanut Butter', ru: 'Арахисовая паста Скиппи', ar: 'زبدة فول سوداني سكيبي' },
            'חמאת שקדים': { en: 'Almond Butter', ru: 'Миндальная паста', ar: 'زبدة اللوز' },
            'חמאת קשיו': { en: 'Cashew Butter', ru: 'Паста из кешью', ar: 'زبدة الكاجو' },
            'חמאת אגוזי לוז': { en: 'Hazelnut Butter', ru: 'Паста из фундука', ar: 'زبدة البندق' },
            'טחינה': { en: 'Tahini', ru: 'Тахини', ar: 'طحينة' },
            'טחינה גולמית': { en: 'Raw Tahini', ru: 'Сырая тахини', ar: 'طحينة خام' },
            'טחינה אל ארז': { en: 'Al Arz Tahini', ru: 'Тахини Аль Арз', ar: 'طحينة الأرز' },
            'טחינה הבאבא': { en: 'HaBaba Tahini', ru: 'Тахини ХаБаба', ar: 'طحينة الباب' },
            'חלווה': { en: 'Halva', ru: 'Халва', ar: 'حلاوة' },
            'חלווה פרוסה': { en: 'Sliced Halva', ru: 'Нарезанная халва', ar: 'حلاوة شرائح' },
            'חלווה שוקולד': { en: 'Chocolate Halva', ru: 'Шоколадная халва', ar: 'حلاوة شوكولاتة' },
            'חלווה פיסטוק': { en: 'Pistachio Halva', ru: 'Фисташковая халва', ar: 'حلاوة فستق' },
            'ריבה': { en: 'Jam', ru: 'Джем', ar: 'مربى' },
            'ריבה תות': { en: 'Strawberry Jam', ru: 'Клубничный джем', ar: 'مربى فراولة' },
            'ריבה משמש': { en: 'Apricot Jam', ru: 'Абрикосовый джем', ar: 'مربى مشمش' },
            'ריבה דובדבן': { en: 'Cherry Jam', ru: 'Вишнёвый джем', ar: 'مربى كرز' },
            'ריבה תפוז': { en: 'Orange Jam', ru: 'Апельсиновый джем', ar: 'مربى برتقال' },
            'ריבה פטל': { en: 'Raspberry Jam', ru: 'Малиновый джем', ar: 'مربى توت' },
            'ריבה ללא סוכר': { en: 'Sugar Free Jam', ru: 'Джем без сахара', ar: 'مربى بدون سكر' },
            'מרמלדה': { en: 'Marmalade', ru: 'Мармелад', ar: 'مربى البرتقال' },
            'דבש': { en: 'Honey', ru: 'Мёд', ar: 'عسل' },
            'דבש טהור': { en: 'Pure Honey', ru: 'Чистый мёд', ar: 'عسل نقي' },
            'דבש פרחים': { en: 'Flower Honey', ru: 'Цветочный мёд', ar: 'عسل زهور' },
            'דבש אורגני': { en: 'Organic Honey', ru: 'Органический мёд', ar: 'عسل عضوي' },
            'סילאן': { en: 'Date Syrup', ru: 'Финиковый сироп', ar: 'دبس التمر' },
            'סילאן טהור': { en: 'Pure Date Syrup', ru: 'Чистый финиковый сироп', ar: 'دبس تمر نقي' },
            'ממרח שום': { en: 'Garlic Spread', ru: 'Чесночная паста', ar: 'معجون ثوم' },
            'ממרח זיתים': { en: 'Olive Spread', ru: 'Оливковая паста', ar: 'معجون زيتون' },
            'ממרח עגבניות מיובשות': { en: 'Sun Dried Tomato Spread', ru: 'Паста из вяленых помидоров', ar: 'معجون طماطم مجففة' },
            'ממרח ארטישוק': { en: 'Artichoke Spread', ru: 'Артишоковая паста', ar: 'معجون خرشوف' },
            'פסטו': { en: 'Pesto', ru: 'Песто', ar: 'بيستو' },
            'פסטו ירוק': { en: 'Green Pesto', ru: 'Зелёный песто', ar: 'بيستو أخضر' },
            'פסטו אדום': { en: 'Red Pesto', ru: 'Красный песто', ar: 'بيستو أحمر' },
            'ממרח טונה': { en: 'Tuna Spread', ru: 'Тунцовая паста', ar: 'معجون تونة' },
            'ממרח חציל': { en: 'Eggplant Spread', ru: 'Баклажанная паста', ar: 'معجون باذنجان' },
            'חומוס ממרח': { en: 'Hummus Spread', ru: 'Хумус', ar: 'حمص' },
            // Deli - מעדניית נקניקים
            'סלמי מעושן': { en: 'Smoked Salami', ru: 'Копчёная салями', ar: 'سلامي مدخن' },
            'נקניק כתף': { en: 'Shoulder Sausage', ru: 'Колбаса из плеча', ar: 'نقانق كتف' },
            'סלמי תה': { en: 'Tea Salami', ru: 'Чайная салями', ar: 'سلامي شاي' },
            'נקניק סלמי קוניאק': { en: 'Cognac Salami', ru: 'Салями коньяк', ar: 'سلامي كونياك' },
            'נקניק מרטלדה': { en: 'Mortadella', ru: 'Мортаделла', ar: 'مورتاديلا' },
            'רוסטביף': { en: 'Roast Beef', ru: 'Ростбиф', ar: 'روست بيف' },
            'כתף בקר מפולפל': { en: 'Peppered Beef Shoulder', ru: 'Говяжья лопатка с перцем', ar: 'كتف بقر مفلفل' },
            'פסטרמה איטלקית': { en: 'Italian Pastrami', ru: 'Итальянская пастрами', ar: 'بسطرمة إيطالية' },
            'פסטרמה גחלים': { en: 'Charcoal Pastrami', ru: 'Пастрами на углях', ar: 'بسطرمة فحم' },
            'פסטרמה גריל': { en: 'Grilled Pastrami', ru: 'Пастрами гриль', ar: 'بسطرمة مشوية' },
            'פסטרמה הודו': { en: 'Turkey Pastrami', ru: 'Пастрами из индейки', ar: 'بسطرمة ديك رومي' },
            'פסטרמה דבש': { en: 'Honey Pastrami', ru: 'Пастрами с мёдом', ar: 'بسطرمة عسل' },
            'פסטרמה ברביקיו': { en: 'BBQ Pastrami', ru: 'Пастрами барбекю', ar: 'بسطرمة باربكيو' },
            'פסטרמה צלויה על לבנים': { en: 'Brick Roasted Pastrami', ru: 'Пастрами на кирпичах', ar: 'بسطرمة مشوية على الطوب' },
            'פסטרמה פרגיות': { en: 'Chicken Pastrami', ru: 'Куриная пастрами', ar: 'بسطرمة دجاج' },
            'פסטרמה כפרית': { en: 'Rustic Pastrami', ru: 'Деревенская пастрами', ar: 'بسطرمة ريفية' },
            // Salads - סלטים מוכנים
            'חומוס': { en: 'Hummus', ru: 'Хумус', ar: 'حمص' },
            'טחינה': { en: 'Tahini', ru: 'Тахини', ar: 'طحينة' },
            'סלט חצילים': { en: 'Eggplant Salad', ru: 'Салат из баклажанов', ar: 'سلطة باذنجان' },
            'סלט מטבוחה': { en: 'Matbucha', ru: 'Матбуха', ar: 'مطبوخة' },
            'סלט טורקי': { en: 'Turkish Salad', ru: 'Турецкий салат', ar: 'سلطة تركية' },
            'סלט כרוב': { en: 'Cabbage Salad', ru: 'Капустный салат', ar: 'سلطة ملفوف' },
            'סלט גזר': { en: 'Carrot Salad', ru: 'Морковный салат', ar: 'سلطة جزر' },
            'סלט קולסלו': { en: 'Coleslaw', ru: 'Коулслоу', ar: 'كول سلو' },
            'סלט ביצים': { en: 'Egg Salad', ru: 'Яичный салат', ar: 'سلطة بيض' },
            'סלט טונה': { en: 'Tuna Salad', ru: 'Салат с тунцом', ar: 'سلطة تونة' },
            'סלט בולגרי': { en: 'Bulgarian Salad', ru: 'Болгарский салат', ar: 'سلطة بلغارية' },
            'סלט ירקות': { en: 'Vegetable Salad', ru: 'Овощной салат', ar: 'سلطة خضار' },
            'סלט קינואה': { en: 'Quinoa Salad', ru: 'Салат с киноа', ar: 'سلطة كينوا' },
            'סלט פסטה': { en: 'Pasta Salad', ru: 'Салат с пастой', ar: 'سلطة باستا' },
            'סלט עדשים': { en: 'Lentil Salad', ru: 'Чечевичный салат', ar: 'سلطة عدس' },
            'גואקמולה': { en: 'Guacamole', ru: 'Гуакамоле', ar: 'جواكامولي' },
            'סלסה': { en: 'Salsa', ru: 'Сальса', ar: 'صلصة' },
            'באבא גנוש': { en: 'Baba Ganoush', ru: 'Баба Гануш', ar: 'بابا غنوج' },
            'סלט חומוס': { en: 'Chickpea Salad', ru: 'Салат из нута', ar: 'سلطة حمص' },
            'סלט פטריות': { en: 'Mushroom Salad', ru: 'Грибной салат', ar: 'سلطة فطر' },
            'סלט סלק': { en: 'Beet Salad', ru: 'Свекольный салат', ar: 'سلطة شمندر' },
            'סלט תפו״א': { en: 'Potato Salad', ru: 'Картофельный салат', ar: 'سلطة بطاطا' },
            'סלט פלפלים קלויים': { en: 'Roasted Pepper Salad', ru: 'Салат из печёного перца', ar: 'سلطة فلفل مشوي' },
            'ממרח אבוקדו': { en: 'Avocado Spread', ru: 'Паста из авокадо', ar: 'معجون أفوكادو' },
            'סלט אבוקדו': { en: 'Avocado Salad', ru: 'Салат из авокадо', ar: 'سلطة أفوكادو' },
            // Snacks - חטיפים
            'במבה': { en: 'Bamba', ru: 'Бамба', ar: 'بامبا' },
            'במבה אדומים': { en: 'Red Bamba', ru: 'Красная Бамба', ar: 'بامبا حمراء' },
            'במבה נוגט': { en: 'Nougat Bamba', ru: 'Бамба с нугой', ar: 'بامبا نوجا' },
            'ביסלי': { en: 'Bisli', ru: 'Бисли', ar: 'بيسلي' },
            'ביסלי גריל': { en: 'Grill Bisli', ru: 'Бисли гриль', ar: 'بيسلي شواء' },
            'ביסלי בצל': { en: 'Onion Bisli', ru: 'Бисли с луком', ar: 'بيسلي بصل' },
            'ביסלי פיצה': { en: 'Pizza Bisli', ru: 'Бисли пицца', ar: 'بيسلي بيتزا' },
            'דוריטוס': { en: 'Doritos', ru: 'Дорито', ar: 'دوريتوس' },
            'דוריטוס צ\'ילי': { en: 'Chili Doritos', ru: 'Дорито чили', ar: 'دوريتوس حار' },
            'טורטייה צ\'יפס': { en: 'Tortilla Chips', ru: 'Чипсы тортилья', ar: 'رقائق تورتيلا' },
            'תפוצ\'יפס': { en: 'Potato Chips', ru: 'Картофельные чипсы', ar: 'شيبس بطاطا' },
            'פרינגלס': { en: 'Pringles', ru: 'Принглс', ar: 'برينجلز' },
            'פרינגלס חמוץ': { en: 'Sour Pringles', ru: 'Кислый Принглс', ar: 'برينجلز حامض' },
            'פופקורן': { en: 'Popcorn', ru: 'Попкорн', ar: 'فشار' },
            'פופקורן מיקרו': { en: 'Microwave Popcorn', ru: 'Попкорн для микроволновки', ar: 'فشار ميكروويف' },
            'פופקורן קרמל': { en: 'Caramel Popcorn', ru: 'Карамельный попкорн', ar: 'فشار كراميل' },
            'שוקולד': { en: 'Chocolate', ru: 'Шоколад', ar: 'شوكولاتة' },
            'שוקולד פרה': { en: 'Para Chocolate', ru: 'Шоколад Пара', ar: 'شوكولاتة بارا' },
            'שוקולד מילקה': { en: 'Milka Chocolate', ru: 'Шоколад Милка', ar: 'شوكولاتة ميلكا' },
            'שוקולד חלב': { en: 'Milk Chocolate', ru: 'Молочный шоколад', ar: 'شوكولاتة حليب' },
            'שוקולד מריר': { en: 'Dark Chocolate', ru: 'Горький шоколад', ar: 'شوكولاتة داكنة' },
            'שוקולד לבן': { en: 'White Chocolate', ru: 'Белый шоколад', ar: 'شوكولاتة بيضاء' },
            'שוקולד עם אגוזים': { en: 'Chocolate with Nuts', ru: 'Шоколад с орехами', ar: 'شوكولاتة بالمكسرات' },
            'קינדר': { en: 'Kinder', ru: 'Киндер', ar: 'كيندر' },
            'סניקרס': { en: 'Snickers', ru: 'Сникерс', ar: 'سنيكرز' },
            'מארס': { en: 'Mars', ru: 'Марс', ar: 'مارس' },
            'טוויקס': { en: 'Twix', ru: 'Твикс', ar: 'تويكس' },
            'קיטקט': { en: 'KitKat', ru: 'КитКат', ar: 'كيت كات' },
            'ביסקוויטים': { en: 'Biscuits', ru: 'Бисквиты', ar: 'بسكويت' },
            'עוגיות אוראו': { en: 'Oreo Cookies', ru: 'Печенье Орео', ar: 'بسكويت أوريو' },
            'עוגיות לוטוס': { en: 'Lotus Cookies', ru: 'Печенье Лотус', ar: 'بسكويت لوتس' },
            'וופלים': { en: 'Waffles', ru: 'Вафли', ar: 'وافل' },
            'וופל בלגי': { en: 'Belgian Waffle', ru: 'Бельгийская вафля', ar: 'وافل بلجيكي' },
            'קצפת': { en: 'Whipped Cream', ru: 'Взбитые сливки', ar: 'كريمة مخفوقة' },
            'מרשמלו': { en: 'Marshmallow', ru: 'Маршмеллоу', ar: 'مارشميلو' },
            'סוכריות': { en: 'Candies', ru: 'Конфеты', ar: 'حلويات' },
            'סוכריות גומי': { en: 'Gummy Candies', ru: 'Жевательные конфеты', ar: 'حلوى جيلاتين' },
            'דובונים': { en: 'Gummy Bears', ru: 'Мармеладные мишки', ar: 'دببة جيلاتين' },
            'מסטיק': { en: 'Chewing Gum', ru: 'Жвачка', ar: 'علكة' },
            'מנטוס': { en: 'Mentos', ru: 'Ментос', ar: 'منتوس' },
            'טיק טק': { en: 'Tic Tac', ru: 'Тик Так', ar: 'تيك تاك' },
            'עוגת שוקולד': { en: 'Chocolate Cake', ru: 'Шоколадный торт', ar: 'كعكة شوكولاتة' },
            'עוגת גבינה': { en: 'Cheesecake', ru: 'Чизкейк', ar: 'كعكة الجبن' },
            'קרמבו': { en: 'Krembo', ru: 'Крембо', ar: 'كريمبو' },
            'פסק זמן': { en: 'Pesek Zman', ru: 'Песек Зман', ar: 'بيسك زمان' },
            'קליק': { en: 'Click', ru: 'Клик', ar: 'كليك' },
            'טעמי': { en: 'Taami', ru: 'Таами', ar: 'طعمي' },
            // Baking - אפייה
            'קמח': { en: 'Flour', ru: 'Мука', ar: 'طحين' },
            'קמח לבן': { en: 'White Flour', ru: 'Белая мука', ar: 'طحين أبيض' },
            'קמח מלא': { en: 'Whole Wheat Flour', ru: 'Цельнозерновая мука', ar: 'طحين قمح كامل' },
            'קמח תירס': { en: 'Corn Flour', ru: 'Кукурузная мука', ar: 'طحين ذرة' },
            'קמח כוסמין': { en: 'Spelt Flour', ru: 'Спельтовая мука', ar: 'طحين الحنطة' },
            'קמח שקדים': { en: 'Almond Flour', ru: 'Миндальная мука', ar: 'طحين اللوز' },
            'קמח קוקוס': { en: 'Coconut Flour', ru: 'Кокосовая мука', ar: 'طحين جوز الهند' },
            'קמח ללא גלוטן': { en: 'Gluten Free Flour', ru: 'Безглютеновая мука', ar: 'طحين خالي من الغلوتين' },
            'סוכר': { en: 'Sugar', ru: 'Сахар', ar: 'سكر' },
            'סוכר לבן': { en: 'White Sugar', ru: 'Белый сахар', ar: 'سكر أبيض' },
            'סוכר חום': { en: 'Brown Sugar', ru: 'Коричневый сахар', ar: 'سكر بني' },
            'סוכר אבקה': { en: 'Powdered Sugar', ru: 'Сахарная пудра', ar: 'سكر بودرة' },
            'שמרים': { en: 'Yeast', ru: 'Дрожжи', ar: 'خميرة' },
            'אבקת אפייה': { en: 'Baking Powder', ru: 'Разрыхлитель', ar: 'بيكنج باودر' },
            'וניל': { en: 'Vanilla', ru: 'Ваниль', ar: 'فانيلا' },
            'שוקולד צ\'יפס': { en: 'Chocolate Chips', ru: 'Шоколадная крошка', ar: 'رقائق شوكولاتة' },
            'קקאו': { en: 'Cocoa', ru: 'Какао', ar: 'كاكاو' },
            'קוקוס מגורד': { en: 'Shredded Coconut', ru: 'Кокосовая стружка', ar: 'جوز هند مبشور' },
            'שקדים': { en: 'Almonds', ru: 'Миндаль', ar: 'لوز' },
            'אגוזי מלך': { en: 'Walnuts', ru: 'Грецкие орехи', ar: 'جوز' },
            'פקאן': { en: 'Pecans', ru: 'Пекан', ar: 'بيكان' },
            'צימוקים': { en: 'Raisins', ru: 'Изюм', ar: 'زبيب' },
            'תמרים': { en: 'Dates', ru: 'Финики', ar: 'تمر' },
            // Meat - בשר
            'עוף שלם טרי': { en: 'Fresh Whole Chicken', ru: 'Свежая курица целиком', ar: 'دجاج كامل طازج' },
            'חזה עוף טרי': { en: 'Fresh Chicken Breast', ru: 'Свежая куриная грудка', ar: 'صدر دجاج طازج' },
            'כרעיים עוף טריות': { en: 'Fresh Chicken Legs', ru: 'Свежие куриные ножки', ar: 'أفخاذ دجاج طازجة' },
            'כנפיים עוף טריות': { en: 'Fresh Chicken Wings', ru: 'Свежие куриные крылья', ar: 'أجنحة دجاج طازجة' },
            'בשר טחון טרי': { en: 'Fresh Ground Beef', ru: 'Свежий говяжий фарш', ar: 'لحم مفروم طازج' },
            'אנטריקוט טרי': { en: 'Fresh Entrecote', ru: 'Свежий антрекот', ar: 'انتريكوت طازج' },
            'סלמון טרי': { en: 'Fresh Salmon', ru: 'Свежий лосось', ar: 'سلمون طازج' },
            'סלמון מעושן': { en: 'Smoked Salmon', ru: 'Копчёный лосось', ar: 'سلمون مدخن' },
            'שניצל עוף טרי': { en: 'Fresh Chicken Schnitzel', ru: 'Свежий куриный шницель', ar: 'شنيتسل دجاج طازج' },
            'המבורגר טרי': { en: 'Fresh Hamburger', ru: 'Свежий гамбургер', ar: 'همبرغر طازج' },
            // Desserts - קינוחים
            'מילקי': { en: 'Milky', ru: 'Милки', ar: 'ميلكي' },
            'דנונה': { en: 'Danone', ru: 'Данон', ar: 'دانون' },
            'שוקו יטבתה': { en: 'Yotvata Chocolate Milk', ru: 'Шоколадное молоко Йотвата', ar: 'شوكو يوتفاتا' },
            'מוס שוקולד': { en: 'Chocolate Mousse', ru: 'Шоколадный мусс', ar: 'موس شوكولاتة' },
            'טירמיסו': { en: 'Tiramisu', ru: 'Тирамису', ar: 'تيراميسو' },
            'אורז חלב': { en: 'Rice Pudding', ru: 'Рисовый пудинг', ar: 'أرز بالحليب' },
            // Canned & Grains - שימורים ואורז
            'אורז': { en: 'Rice', ru: 'Рис', ar: 'أرز' },
            'אורז בסמטי': { en: 'Basmati Rice', ru: 'Рис Басмати', ar: 'أرز بسمتي' },
            'פסטה': { en: 'Pasta', ru: 'Паста', ar: 'معكرونة' },
            'פסטה ספגטי': { en: 'Spaghetti', ru: 'Спагетти', ar: 'سباغيتي' },
            'קוסקוס': { en: 'Couscous', ru: 'Кускус', ar: 'كسكس' },
            'רוטב עגבניות': { en: 'Tomato Sauce', ru: 'Томатный соус', ar: 'صلصة طماطم' },
            'טונה': { en: 'Tuna', ru: 'Тунец', ar: 'تونة' },
            'תירס': { en: 'Corn', ru: 'Кукуруза', ar: 'ذرة' },
            'שמן זית': { en: 'Olive Oil', ru: 'Оливковое масло', ar: 'زيت زيتون' },
            'חומץ': { en: 'Vinegar', ru: 'Уксус', ar: 'خل' },
            'זיתים': { en: 'Olives', ru: 'Оливки', ar: 'زيتون' },
            'עדשים': { en: 'Lentils', ru: 'Чечевица', ar: 'عدس' },
            'שעועית': { en: 'Beans', ru: 'Фасоль', ar: 'فاصوليا' },
            // Cereals - דגנים
            'קורנפלקס': { en: 'Cornflakes', ru: 'Кукурузные хлопья', ar: 'كورن فليكس' },
            'גרנולה': { en: 'Granola', ru: 'Гранола', ar: 'جرانولا' },
            'שיבולת שועל': { en: 'Oatmeal', ru: 'Овсянка', ar: 'شوفان' },
            'מוזלי': { en: 'Muesli', ru: 'Мюсли', ar: 'موسلي' },
            // Spices - תבלינים
            'מלח': { en: 'Salt', ru: 'Соль', ar: 'ملح' },
            'פלפל שחור': { en: 'Black Pepper', ru: 'Чёрный перец', ar: 'فلفل أسود' },
            'פפריקה': { en: 'Paprika', ru: 'Паприка', ar: 'بابريكا' },
            'כורכום': { en: 'Turmeric', ru: 'Куркума', ar: 'كركم' },
            'כמון': { en: 'Cumin', ru: 'Кумин', ar: 'كمون' },
            'קינמון': { en: 'Cinnamon', ru: 'Корица', ar: 'قرفة' },
            'זעתר': { en: 'Za\'atar', ru: 'Заатар', ar: 'زعتر' },
            'קארי': { en: 'Curry', ru: 'Карри', ar: 'كاري' },
            // Coffee & Tea - קפה ותה
            'קפה נמס': { en: 'Instant Coffee', ru: 'Растворимый кофе', ar: 'قهوة سريعة' },
            'קפה טורקי': { en: 'Turkish Coffee', ru: 'Турецкий кофе', ar: 'قهوة تركية' },
            'תה שחור': { en: 'Black Tea', ru: 'Чёрный чай', ar: 'شاي أسود' },
            'תה ירוק': { en: 'Green Tea', ru: 'Зелёный чай', ar: 'شاي أخضر' },
            'תה נענע': { en: 'Mint Tea', ru: 'Мятный чай', ar: 'شاي نعناع' },
            // Drinks - משקאות
            'מים': { en: 'Water', ru: 'Вода', ar: 'ماء' },
            'קולה': { en: 'Cola', ru: 'Кола', ar: 'كولا' },
            'ספרייט': { en: 'Sprite', ru: 'Спрайт', ar: 'سبرايت' },
            'מיץ תפוזים': { en: 'Orange Juice', ru: 'Апельсиновый сок', ar: 'عصير برتقال' },
            'מיץ תפוחים': { en: 'Apple Juice', ru: 'Яблочный сок', ar: 'عصير تفاح' },
            // Cleaning - ניקיון
            'נייר טואלט': { en: 'Toilet Paper', ru: 'Туалетная бумага', ar: 'ورق تواليت' },
            'מגבות נייר': { en: 'Paper Towels', ru: 'Бумажные полотенца', ar: 'مناشف ورقية' },
            'סבון כלים': { en: 'Dish Soap', ru: 'Средство для посуды', ar: 'صابون أطباق' },
            'אבקת כביסה': { en: 'Laundry Detergent', ru: 'Стиральный порошок', ar: 'مسحوق غسيل' },
            'מרכך כביסה': { en: 'Fabric Softener', ru: 'Кондиционер для белья', ar: 'منعم أقمشة' },
            'אקונומיקה': { en: 'Bleach', ru: 'Отбеливатель', ar: 'مبيض' },
            'שקיות אשפה': { en: 'Garbage Bags', ru: 'Мусорные пакеты', ar: 'أكياس قمامة' },
            'נייר אלומיניום': { en: 'Aluminum Foil', ru: 'Фольга', ar: 'ورق ألمنيوم' },
            'ניילון נצמד': { en: 'Plastic Wrap', ru: 'Пищевая плёнка', ar: 'غلاف بلاستيك' },
            // Hygiene - היגיינה
            'סבון ידיים': { en: 'Hand Soap', ru: 'Мыло для рук', ar: 'صابون يدين' },
            'שמפו': { en: 'Shampoo', ru: 'Шампунь', ar: 'شامبو' },
            'מרכך שיער': { en: 'Conditioner', ru: 'Кондиционер', ar: 'بلسم شعر' },
            'משחת שיניים': { en: 'Toothpaste', ru: 'Зубная паста', ar: 'معجون أسنان' },
            'מברשת שיניים': { en: 'Toothbrush', ru: 'Зубная щётка', ar: 'فرشاة أسنان' },
            'דאודורנט': { en: 'Deodorant', ru: 'Дезодорант', ar: 'مزيل عرق' },
            'קרם לחות': { en: 'Moisturizer', ru: 'Увлажняющий крем', ar: 'كريم مرطب' },
            // Baby - תינוקות
            'חיתולים': { en: 'Diapers', ru: 'Подгузники', ar: 'حفاضات' },
            'מגבונים לתינוקות': { en: 'Baby Wipes', ru: 'Детские салфетки', ar: 'مناديل أطفال' },
            'שמפו לתינוקות': { en: 'Baby Shampoo', ru: 'Детский шампунь', ar: 'شامبو أطفال' },
            'אבקת חלב': { en: 'Baby Formula', ru: 'Детская смесь', ar: 'حليب أطفال' },
            // Pets - חיות מחמד
            'מזון לכלבים': { en: 'Dog Food', ru: 'Корм для собак', ar: 'طعام كلاب' },
            'מזון לחתולים': { en: 'Cat Food', ru: 'Корм для кошек', ar: 'طعام قطط' },
            'חול לחתולים': { en: 'Cat Litter', ru: 'Наполнитель для кошек', ar: 'رمل قطط' },
            // Frozen - קפואים
            'גלידה': { en: 'Ice Cream', ru: 'Мороженое', ar: 'آيس كريم' },
            'פיצה קפואה': { en: 'Frozen Pizza', ru: 'Замороженная пицца', ar: 'بيتزا مجمدة' },
            'ירקות קפואים': { en: 'Frozen Vegetables', ru: 'Замороженные овощи', ar: 'خضار مجمدة' },
            // Candles - נרות
            'נרות שבת': { en: 'Shabbat Candles', ru: 'Субботние свечи', ar: 'شموع السبت' },
            'נרות חנוכה': { en: 'Hanukkah Candles', ru: 'Ханукальные свечи', ar: 'شموع حانوكا' },
            'גפרורים': { en: 'Matches', ru: 'Спички', ar: 'كبريت' }
        };

        // Helper function to get translated product name
        function getProductTranslation(productName, language) {
            if (language === 'he') return productName;
            const translation = PRODUCT_TRANSLATIONS[productName];
            if (translation && translation[language]) {
                return translation[language];
            }
            return productName; // Return Hebrew if no translation found
        }

        // Confetti burst effect component
        function ConfettiBurst({ x, y, onComplete }) {
            const [particles, setParticles] = useState([]);

            useEffect(() => {
                const colors = ['#10b981', '#34d399', '#6ee7b7', '#fbbf24', '#f472b6', '#818cf8'];
                const newParticles = [];
                for (let i = 0; i < 12; i++) {
                    const angle = (i / 12) * 360;
                    const velocity = 60 + Math.random() * 40;
                    const size = 4 + Math.random() * 4;
                    newParticles.push({
                        id: i,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        angle,
                        velocity,
                        size,
                        x: Math.cos(angle * Math.PI / 180) * velocity,
                        y: Math.sin(angle * Math.PI / 180) * velocity
                    });
                }
                setParticles(newParticles);
                const timer = setTimeout(() => onComplete?.(), 600);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div style={{ position: 'absolute', left: x, top: y, pointerEvents: 'none', zIndex: 50 }}>
                    {particles.map(p => (
                        <div
                            key={p.id}
                            className="confetti-particle"
                            style={{
                                width: p.size,
                                height: p.size,
                                borderRadius: '50%',
                                backgroundColor: p.color,
                                '--tx': `${p.x}px`,
                                '--ty': `${p.y}px`,
                                animation: `particleFly 0.6s ease-out forwards`
                            }}
                        />
                    ))}
                </div>
            );
        }

        // Swipeable Item Component
        function SwipeableItem({ children, onSwipeRight, onSwipeLeft, className, purchased }) {
            const [touchStart, setTouchStart] = useState(null);
            const [touchDelta, setTouchDelta] = useState(0);
            const [isSwiping, setIsSwiping] = useState(false);
            const [completing, setCompleting] = useState(null); // 'right' or 'left'
            const THRESHOLD = 80;

            const handleTouchStart = (e) => {
                setTouchStart(e.touches[0].clientX);
                setIsSwiping(true);
            };

            const handleTouchMove = (e) => {
                if (touchStart === null) return;
                const delta = e.touches[0].clientX - touchStart;
                // RTL: negative delta = swiping right visually, positive = swiping left
                setTouchDelta(delta);
            };

            const handleTouchEnd = () => {
                if (Math.abs(touchDelta) > THRESHOLD) {
                    // RTL adjustment: negative delta means swiping toward the left side of screen (which is "right" in RTL)
                    if (touchDelta < -THRESHOLD) {
                        // Swiped left on screen = "right" action in RTL = bought
                        setCompleting('right');
                        setTimeout(() => {
                            onSwipeRight?.();
                            setCompleting(null);
                            setTouchDelta(0);
                        }, 300);
                    } else if (touchDelta > THRESHOLD) {
                        // Swiped right on screen = "left" action in RTL = postpone
                        setCompleting('left');
                        setTimeout(() => {
                            onSwipeLeft?.();
                            setCompleting(null);
                            setTouchDelta(0);
                        }, 300);
                    }
                } else {
                    setTouchDelta(0);
                }
                setTouchStart(null);
                setIsSwiping(false);
            };

            const showRightIndicator = touchDelta < -30;
            const showLeftIndicator = touchDelta > 30;
            const rightProgress = Math.min(Math.abs(Math.min(touchDelta, 0)) / THRESHOLD, 1);
            const leftProgress = Math.min(Math.max(touchDelta, 0) / THRESHOLD, 1);

            return (
                <div className={`swipe-container ${className || ''}`}>
                    {/* Right swipe background (bought - green) */}
                    <div
                        className="swipe-bg-right swipe-background"
                        style={{ opacity: rightProgress }}
                    >
                        <div className="swipe-indicator">
                            <span className={`swipe-icon swipe-icon-emoji ${showRightIndicator ? 'visible' : ''}`} style={{ transform: `scale(${0.5 + rightProgress * 0.5})` }}>
                                ✓
                            </span>
                            <span className={`swipe-icon text-sm ${showRightIndicator ? 'visible' : ''}`}>
                                נקנה
                            </span>
                        </div>
                    </div>
                    {/* Left swipe background (postpone - orange) */}
                    <div
                        className="swipe-bg-left swipe-background"
                        style={{ opacity: leftProgress }}
                    >
                        <div className="swipe-indicator">
                            <span className={`swipe-icon swipe-icon-emoji ${showLeftIndicator ? 'visible' : ''}`} style={{ transform: `scale(${0.5 + leftProgress * 0.5})` }}>
                                ⏭
                            </span>
                            <span className={`swipe-icon text-sm ${showLeftIndicator ? 'visible' : ''}`}>
                                אח״כ
                            </span>
                        </div>
                    </div>
                    {/* Content */}
                    <div
                        className={`swipe-content ${isSwiping ? 'swiping' : ''} ${completing === 'right' ? 'slide-out-right' : ''} ${completing === 'left' ? 'slide-out-left' : ''}`}
                        style={{ transform: completing ? undefined : `translateX(${touchDelta}px)` }}
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                    >
                        {children}
                    </div>
                </div>
            );
        }

        function ShoppingList() {
            const { user } = useAuth();
            const { family, lists, currentList, setCurrentList, logActivity } = useFamily();
            const { language, changeLanguage, t } = useLanguage();
            // Expose changeLanguage to window for accessibility modal buttons
            window.changeAppLanguage = changeLanguage;

            // Helper function to get translated category name
            const getCategoryName = (categoryKey) => {
                const categoryTranslationMap = {
                    fruits: 'fruitsVeg',
                    dairy: 'dairyProducts',
                    desserts: 'dairyDesserts',
                    meat: 'meatFish',
                    deli: 'deli',
                    salads: 'readySalads',
                    bakery: 'breadBakery',
                    spreads: 'spreads',
                    baking: 'bakingProducts',
                    cereals: 'cereals',
                    canned: 'cannedDry',
                    spices: 'spices',
                    coffee: 'coffeeTea',
                    drinks: 'drinks',
                    wine: 'wineAlcohol',
                    snacks: 'snacks',
                    frozen: 'frozen',
                    health: 'dietProtein',
                    hygiene: 'hygiene',
                    cleaning: 'cleaning',
                    candles: 'candlesOil',
                    baby: 'babyKids',
                    pets: 'pets'
                };
                return t(categoryTranslationMap[categoryKey]) || CATEGORIES[categoryKey]?.name || categoryKey;
            };
            const [items, setItems] = useState([]);
            const prevItemIdsRef = React.useRef(new Set());
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [darkMode, setDarkMode] = useState(false);
            const [showFinishShopping, setShowFinishShopping] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [totalAmount, setTotalAmount] = useState('');
            const [receiptPhoto, setReceiptPhoto] = useState(null);
            const [uploadingReceipt, setUploadingReceipt] = useState(false);
            const receiptInputRef = React.useRef(null);
            const [history, setHistory] = useState([]);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
            const [showDeleteAllConfirm, setShowDeleteAllConfirm] = useState(false);
            const [showFamilySettings, setShowFamilySettings] = useState(false);
            const [showCreateList, setShowCreateList] = useState(false);
            const [editingNote, setEditingNote] = useState(null);
            const [editingItemId, setEditingItemId] = useState(null);
            const [editingItemName, setEditingItemName] = useState('');
            const [confetti, setConfetti] = useState(null);
            const [animatingItems, setAnimatingItems] = useState(new Set());
            const addBarInputRef = React.useRef(null);
            // Chat & Photo states
            const [showChat, setShowChat] = useState(false);
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [showCamera, setShowCamera] = useState(false);
            const [capturedPhoto, setCapturedPhoto] = useState(null);
            const [notificationsEnabled, setNotificationsEnabled] = useState(false);
            const lastMessageIdRef = React.useRef(null);
            const videoRef = React.useRef(null);
            const canvasRef = React.useRef(null);
            // Recipe states
            const [showRecipes, setShowRecipes] = useState(false);
            const [recipes, setRecipes] = useState([]);
            const [showAddRecipe, setShowAddRecipe] = useState(false);
            const [newRecipeName, setNewRecipeName] = useState('');
            const [newRecipeIngredients, setNewRecipeIngredients] = useState('');
            const [addingRecipeItems, setAddingRecipeItems] = useState(null);
            // Recipe scanning states
            const [showRecipeScan, setShowRecipeScan] = useState(false);
            const [scanningRecipe, setScanningRecipe] = useState(false);
            const [scanProgress, setScanProgress] = useState(0);
            const [scannedText, setScannedText] = useState('');
            const [scannedIngredients, setScannedIngredients] = useState([]);
            const [scannedRecipeName, setScannedRecipeName] = useState('');
            const recipeVideoRef = React.useRef(null);
            const recipeCanvasRef = React.useRef(null);
            const recipeScanActiveRef = React.useRef(false);
            // Forgotten items tracking
            const [forgottenStats, setForgottenStats] = useState({});
            const [showForgottenStats, setShowForgottenStats] = useState(false);
            const [shoppingStreak, setShoppingStreak] = useState(0);
            const [achievements, setAchievements] = useState([]);
            // Regular items & Calendar
            const [regularItems, setRegularItems] = useState([]);
            const [showRegulars, setShowRegulars] = useState(false);
            const [showCalendar, setShowCalendar] = useState(false);
            const [upcomingHolidays, setUpcomingHolidays] = useState([]);
            // Quantity selector
            const [showQuantitySelector, setShowQuantitySelector] = useState(false);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [selectedQuantity, setSelectedQuantity] = useState(1);
            const [selectedUnit, setSelectedUnit] = useState('יח\'');
            const [selectedNote, setSelectedNote] = useState('');
            // Calendar view
            const [calendarMonth, setCalendarMonth] = useState(new Date());
            const [selectedHoliday, setSelectedHoliday] = useState(null);
            const [reminderDays, setReminderDays] = useState(7);
            // Voice recognition states
            const [isListening, setIsListening] = useState(false);
            const [voiceSupported, setVoiceSupported] = useState(false);
            const [voiceLang, setVoiceLang] = useState(localStorage.getItem('voiceLang') || 'he-IL');
            // Shopping mode - keeps screen awake
            const [shoppingMode, setShoppingMode] = useState(false);
            const [wakeLock, setWakeLock] = useState(null);
            // Out of stock tracking
            const [outOfStockItems, setOutOfStockItems] = useState([]);
            // Saved lists for quick reuse
            const [savedLists, setSavedLists] = useState([]);
            const [showSavedLists, setShowSavedLists] = useState(false);
            const [showImportWhatsApp, setShowImportWhatsApp] = useState(false);
            const [whatsAppText, setWhatsAppText] = useState('');
            // Real-time editing indicator
            const [activeEditors, setActiveEditors] = useState([]);
            // Holiday recommendations
            const [showHolidayRecommendations, setShowHolidayRecommendations] = useState(false);
            // Price comparison scanner
            const [showPriceScanner, setShowPriceScanner] = useState(false);
            const [scanningPrice, setScanningPrice] = useState(false);
            const [scannedProductName, setScannedProductName] = useState('');
            const [priceCompareResults, setPriceCompareResults] = useState(null);
            const priceVideoRef = React.useRef(null);
            const priceCanvasRef = React.useRef(null);
            // AI Assistant
            const [showAIAssistant, setShowAIAssistant] = useState(false);
            const [aiSuggestions, setAiSuggestions] = useState([]);
            const [aiThinking, setAiThinking] = useState(false);
            // Onboarding & Help
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [onboardingStep, setOnboardingStep] = useState(0);
            const [showHelp, setShowHelp] = useState(false);
            const [showFeedback, setShowFeedback] = useState(false);
            const [feedbackText, setFeedbackText] = useState('');
            const [feedbackType, setFeedbackType] = useState('bug');
            const [feedbackSending, setFeedbackSending] = useState(false);
            const [feedbackSent, setFeedbackSent] = useState(false);
            // Accessibility
            const [showAccessibility, setShowAccessibility] = useState(false);
            const [accessibilitySettings, setAccessibilitySettings] = useState({
                fontSize: 'normal',
                contrast: 'normal',
                highlightLinks: false,
                cursorSize: 'normal'
            });

            // English to Hebrew grocery translations
            const ENGLISH_TO_HEBREW = {
                // Dairy
                'milk': 'חלב', 'eggs': 'ביצים', 'egg': 'ביצים', 'cheese': 'גבינה', 'butter': 'חמאה',
                'yogurt': 'יוגורט', 'cream': 'שמנת', 'cottage': 'קוטג\'', 'cream cheese': 'גבינת שמנת',
                'sour cream': 'שמנת חמוצה', 'whipped cream': 'קצפת',
                // Bread & Bakery
                'bread': 'לחם', 'pita': 'פיתה', 'challah': 'חלה', 'bagel': 'בייגל', 'croissant': 'קרואסון',
                'toast': 'לחם טוסט', 'rolls': 'לחמניות', 'baguette': 'באגט',
                // Fruits
                'apple': 'תפוח', 'apples': 'תפוחים', 'banana': 'בננה', 'bananas': 'בננות',
                'orange': 'תפוז', 'oranges': 'תפוזים', 'lemon': 'לימון', 'lemons': 'לימונים',
                'grapes': 'ענבים', 'strawberry': 'תות', 'strawberries': 'תותים',
                'watermelon': 'אבטיח', 'melon': 'מלון', 'mango': 'מנגו', 'peach': 'אפרסק',
                'pear': 'אגס', 'plum': 'שזיף', 'cherry': 'דובדבן', 'cherries': 'דובדבנים',
                'avocado': 'אבוקדו', 'pomegranate': 'רימון', 'kiwi': 'קיווי', 'pineapple': 'אננס',
                // Vegetables
                'tomato': 'עגבניה', 'tomatoes': 'עגבניות', 'cucumber': 'מלפפון', 'cucumbers': 'מלפפונים',
                'onion': 'בצל', 'onions': 'בצל', 'garlic': 'שום', 'potato': 'תפוח אדמה', 'potatoes': 'תפוחי אדמה',
                'carrot': 'גזר', 'carrots': 'גזר', 'pepper': 'פלפל', 'peppers': 'פלפלים',
                'lettuce': 'חסה', 'cabbage': 'כרוב', 'broccoli': 'ברוקולי', 'cauliflower': 'כרובית',
                'spinach': 'תרד', 'celery': 'סלרי', 'corn': 'תירס', 'mushroom': 'פטריות', 'mushrooms': 'פטריות',
                'zucchini': 'קישוא', 'eggplant': 'חציל', 'beet': 'סלק', 'radish': 'צנון',
                // Meat & Fish
                'chicken': 'עוף', 'beef': 'בקר', 'meat': 'בשר', 'fish': 'דג', 'salmon': 'סלמון',
                'tuna': 'טונה', 'turkey': 'הודו', 'schnitzel': 'שניצל', 'steak': 'סטייק',
                'ground beef': 'בשר טחון', 'sausage': 'נקניק', 'hot dog': 'נקניקייה',
                // Pantry
                'rice': 'אורז', 'pasta': 'פסטה', 'noodles': 'אטריות', 'flour': 'קמח',
                'sugar': 'סוכר', 'salt': 'מלח', 'oil': 'שמן', 'olive oil': 'שמן זית',
                'vinegar': 'חומץ', 'sauce': 'רוטב', 'ketchup': 'קטשופ', 'mayonnaise': 'מיונז',
                'mustard': 'חרדל', 'honey': 'דבש', 'jam': 'ריבה', 'peanut butter': 'חמאת בוטנים',
                'coffee': 'קפה', 'tea': 'תה', 'juice': 'מיץ', 'water': 'מים', 'soda': 'סודה',
                'cereal': 'דגני בוקר', 'oatmeal': 'שיבולת שועל', 'crackers': 'קרקרים',
                'chips': 'צ\'יפס', 'cookies': 'עוגיות', 'chocolate': 'שוקולד', 'candy': 'ממתקים',
                'nuts': 'אגוזים', 'almonds': 'שקדים', 'walnuts': 'אגוזי מלך',
                // Frozen
                'ice cream': 'גלידה', 'frozen vegetables': 'ירקות קפואים', 'pizza': 'פיצה',
                // Cleaning
                'soap': 'סבון', 'shampoo': 'שמפו', 'toilet paper': 'נייר טואלט',
                'tissues': 'טישו', 'detergent': 'אבקת כביסה', 'dish soap': 'סבון כלים',
                'trash bags': 'שקיות אשפה', 'paper towels': 'מגבות נייר',
                // Baby
                'diapers': 'חיתולים', 'baby food': 'מזון לתינוקות', 'formula': 'תרכובת מזון',
                'wipes': 'מגבונים',
                // Other common
                'hummus': 'חומוס', 'tahini': 'טחינה', 'falafel': 'פלאפל', 'shawarma': 'שווארמה'
            };
            const [voiceTranscript, setVoiceTranscript] = useState('');
            const recognitionRef = React.useRef(null);

            // Voice status for debugging
            const [voiceStatus, setVoiceStatus] = useState('');
            const voiceTimeoutRef = React.useRef(null);

            // Check voice support and setup recognition
            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    setVoiceSupported(true);
                } else {
                    setVoiceStatus('הדפדפן לא תומך בזיהוי קול');
                }
            }, []);

            // Create recognition when starting to listen
            const createRecognition = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return null;

                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.maxAlternatives = 3; // More alternatives for better Hebrew recognition

                // Check if iOS Safari - Hebrew support is limited
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

                if (isIOS && isSafari && voiceLang === 'he-IL') {
                    // iOS Safari has limited Hebrew support, try a workaround
                    recognition.lang = 'he'; // Try shorter code
                } else {
                    recognition.lang = voiceLang;
                }

                recognition.onstart = () => {
                    const isIOSSafari = isIOS && isSafari;
                    if (isIOSSafari && voiceLang === 'he-IL') {
                        setVoiceStatus('מאזין... (ב-iPhone נסה לדבר באנגלית)');
                    } else {
                        setVoiceStatus(voiceLang === 'en-US' ? 'Listening... speak now' : 'מאזין... דבר עכשיו');
                    }
                };

                recognition.onaudiostart = () => {
                    setVoiceStatus(voiceLang === 'en-US' ? 'Hearing audio...' : 'קולט שמע...');
                };

                recognition.onspeechstart = () => {
                    setVoiceStatus(voiceLang === 'en-US' ? 'Detecting speech...' : 'מזהה דיבור...');
                };

                recognition.onresult = (event) => {
                    // Clear timeout since we got a result
                    if (voiceTimeoutRef.current) {
                        clearTimeout(voiceTimeoutRef.current);
                    }

                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    setVoiceTranscript(transcript);
                    setVoiceStatus(voiceLang === 'en-US' ? 'Got it!' : 'קיבלתי!');

                    // If final result, process it
                    if (event.results[0].isFinal) {
                        processVoiceCommand(transcript, voiceLang);
                        setIsListening(false);
                    }
                };

                recognition.onend = () => {
                    if (voiceTimeoutRef.current) {
                        clearTimeout(voiceTimeoutRef.current);
                    }
                    setIsListening(false);
                    if (!voiceTranscript) {
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                        if (isIOS && isSafari && voiceLang === 'he-IL') {
                            setVoiceStatus('עברית לא נתמכת באייפון. נסה באנגלית או הקלד ידנית 🇺🇸');
                        } else {
                            setVoiceStatus(voiceLang === 'en-US' ? 'No speech detected. Try again.' : 'לא זוהה דיבור. נסה שוב.');
                        }
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Voice recognition error:', event.error);
                    if (voiceTimeoutRef.current) {
                        clearTimeout(voiceTimeoutRef.current);
                    }
                    setIsListening(false);

                    switch(event.error) {
                        case 'not-allowed':
                            setVoiceStatus('נא לאפשר גישה למיקרופון בהגדרות הדפדפן');
                            alert('נא לאפשר גישה למיקרופון. לחץ על סמל המנעול בשורת הכתובת ואפשר מיקרופון.');
                            break;
                        case 'no-speech':
                            setVoiceStatus(voiceLang === 'en-US' ? 'No speech detected. Tap mic to try again.' : 'לא נשמע דיבור. לחץ שוב על המיקרופון.');
                            break;
                        case 'audio-capture':
                            setVoiceStatus('לא נמצא מיקרופון. בדוק את החיבור.');
                            break;
                        case 'network':
                            setVoiceStatus('בעיית רשת. בדוק את החיבור לאינטרנט.');
                            break;
                        case 'aborted':
                            setVoiceStatus(voiceLang === 'en-US' ? 'Cancelled' : 'בוטל');
                            break;
                        default:
                            setVoiceStatus(`שגיאה: ${event.error}`);
                    }
                };

                return recognition;
            };

            // Toggle voice language
            const toggleVoiceLang = () => {
                const newLang = voiceLang === 'he-IL' ? 'en-US' : 'he-IL';
                setVoiceLang(newLang);
                localStorage.setItem('voiceLang', newLang);
            };

            // Shopping Mode - Keep screen awake
            const toggleShoppingMode = async () => {
                if (shoppingMode) {
                    // Turn off shopping mode
                    if (wakeLock) {
                        await wakeLock.release();
                        setWakeLock(null);
                    }
                    setShoppingMode(false);
                } else {
                    // Turn on shopping mode
                    try {
                        if ('wakeLock' in navigator) {
                            const lock = await navigator.wakeLock.request('screen');
                            setWakeLock(lock);
                            lock.addEventListener('release', () => {
                                setShoppingMode(false);
                                setWakeLock(null);
                            });
                        }
                        setShoppingMode(true);
                    } catch (err) {
                        console.log('Wake Lock not supported or failed:', err);
                        setShoppingMode(true); // Still enable mode visually
                    }
                }
            };

            // Mark item as out of stock
            const markOutOfStock = async (item) => {
                try {
                    await window.firestore.updateDoc(
                        window.firestore.doc(window.db, 'shopping-items', item.id),
                        { outOfStock: true, outOfStockAt: new Date(), outOfStockBy: user.displayName || user.email }
                    );
                    // Save to out of stock list for future reference
                    const newOutOfStock = [...outOfStockItems, { name: item.name, date: new Date() }];
                    setOutOfStockItems(newOutOfStock);
                    localStorage.setItem(`outOfStock_${family.id}`, JSON.stringify(newOutOfStock));
                } catch (err) {
                    console.error('Error marking out of stock:', err);
                }
            };

            // Save current list for reuse
            const saveListForReuse = () => {
                const currentItems = items.filter(i => !i.purchased).map(i => ({ name: i.name, category: i.category, quantity: i.quantity, unit: i.unit }));
                if (currentItems.length === 0) return;

                const listName = `רשימה ${new Date().toLocaleDateString('he-IL')}`;
                const newList = { id: Date.now(), name: listName, items: currentItems, createdAt: new Date() };
                const updated = [newList, ...savedLists.slice(0, 9)]; // Keep max 10
                setSavedLists(updated);
                localStorage.setItem(`savedLists_${family.id}`, JSON.stringify(updated));
            };

            // Load saved list to cart
            const loadSavedList = async (savedList) => {
                for (const item of savedList.items) {
                    await addProduct(item.name, item.category);
                }
                setShowSavedLists(false);
            };

            // Delete saved list
            const deleteSavedList = (listId) => {
                const updated = savedLists.filter(list => list.id !== listId);
                setSavedLists(updated);
                localStorage.setItem(`savedLists_${family.id}`, JSON.stringify(updated));
            };

            // Import from WhatsApp text
            const importFromWhatsApp = async () => {
                if (!whatsAppText.trim()) return;

                // Parse WhatsApp text - split by newlines, commas, or bullet points
                const lines = whatsAppText
                    .split(/[\n,•\-\*]/)
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && line.length < 50);

                let addedCount = 0;
                for (const line of lines) {
                    // Try to extract quantity if present (e.g., "2 חלב" or "חלב x3" or "2 ק"ג בשר")
                    let qty = 1;
                    let productName = line;

                    // Match patterns like "2 חלב", "חלב x3", "2 ק"ג בשר"
                    const qtyMatch = line.match(/^([\d.]+)\s*(.+)$/) || line.match(/^(.+?)\s*[xX×]\s*([\d.]+)$/);
                    if (qtyMatch) {
                        qty = parseFloat(qtyMatch[1]) || parseFloat(qtyMatch[2]) || 1;
                        productName = (qtyMatch[2] || qtyMatch[1]).trim();
                        // Remove unit from product name if it starts with a unit
                        productName = productName.replace(/^(ק"ג|קג|גרם|ליטר|מ"ל|יח'|יחידות?)\s*/i, '').trim();
                    }

                    if (!productName) continue;

                    // Detect category and get appropriate unit
                    const category = detectCategory(productName);
                    const unit = CATEGORIES[category]?.unit || 'יח\'';

                    // Check if already exists
                    const existing = items.find(item => item.name === productName && !item.purchased);
                    if (existing) {
                        // Update quantity
                        let newQty;
                        if (typeof existing.quantity === 'string') {
                            const numMatch = existing.quantity.match(/^([\d.]+)/);
                            const existingNum = numMatch ? parseFloat(numMatch[1]) : 1;
                            newQty = `${existingNum + qty} ${unit}`;
                        } else {
                            newQty = `${(existing.quantity || 0) + qty} ${unit}`;
                        }
                        await window.firestore.updateDoc(
                            window.firestore.doc(window.db, 'shopping-items', existing.id),
                            { quantity: newQty, unit: unit, updatedAt: new Date() }
                        );
                    } else {
                        // Add new item with correct unit
                        await window.firestore.addDoc(window.firestore.collection(window.db, 'shopping-items'), {
                            name: productName,
                            category: category,
                            quantity: `${qty} ${unit}`,
                            unit: unit,
                            purchased: false,
                            familyId: family.id,
                            listId: currentList.id,
                            addedBy: user.displayName || user.email,
                            addedByUid: user.uid,
                            note: '',
                            createdAt: new Date()
                        });
                    }
                    addedCount++;
                }

                setWhatsAppText('');
                setShowImportWhatsApp(false);
            };

            // Price comparison scanner functions
            const startPriceScanner = async () => {
                setShowPriceScanner(true);
                setScannedProductName('');
                setPriceCompareResults(null);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                    });
                    if (priceVideoRef.current) {
                        priceVideoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    console.error('Camera error:', err);
                    alert('לא ניתן לגשת למצלמה');
                    setShowPriceScanner(false);
                }
            };

            const stopPriceScanner = () => {
                if (priceVideoRef.current?.srcObject) {
                    const tracks = priceVideoRef.current.srcObject.getTracks();
                    tracks.forEach(track => {
                        track.stop();
                        track.enabled = false;
                    });
                    priceVideoRef.current.srcObject = null;
                }
                setShowPriceScanner(false);
                setScanningPrice(false);
            };

            // Get product suggestions for price search
            const getPriceSearchSuggestions = (searchText) => {
                if (!searchText || searchText.length < 2) return [];
                const text = searchText.toLowerCase();
                const suggestions = [];
                for (const [cat, products] of Object.entries(PRODUCTS)) {
                    for (const product of products) {
                        if (product.includes(searchText) || product.toLowerCase().includes(text)) {
                            suggestions.push(product);
                            if (suggestions.length >= 8) return suggestions;
                        }
                    }
                }
                return suggestions;
            };

            // Translate English product name to Hebrew
            const translateProductToHebrew = (text) => {
                if (!text) return text;
                const lower = text.toLowerCase().trim();

                // Check direct translation
                if (ENGLISH_TO_HEBREW[lower]) {
                    return ENGLISH_TO_HEBREW[lower];
                }

                // Check if any word matches
                const words = lower.split(/\s+/);
                for (const word of words) {
                    if (ENGLISH_TO_HEBREW[word]) {
                        return ENGLISH_TO_HEBREW[word];
                    }
                }

                // Check partial matches
                for (const [eng, heb] of Object.entries(ENGLISH_TO_HEBREW)) {
                    if (lower.includes(eng) || eng.includes(lower)) {
                        return heb;
                    }
                }

                return text; // Return original if no translation found
            };

            // Check if text is English (contains mostly English letters)
            const isEnglishText = (text) => {
                const englishChars = (text.match(/[a-zA-Z]/g) || []).length;
                const hebrewChars = (text.match(/[\u0590-\u05FF]/g) || []).length;
                return englishChars > hebrewChars;
            };

            const captureAndScanPrice = async () => {
                if (!priceVideoRef.current || !priceCanvasRef.current) return;

                setScanningPrice(true);
                const video = priceVideoRef.current;
                const canvas = priceCanvasRef.current;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');

                // Enhance image for better OCR
                ctx.drawImage(video, 0, 0);
                // Increase contrast
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    // Convert to grayscale and increase contrast
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const contrast = 1.5;
                    const newVal = Math.min(255, Math.max(0, ((avg - 128) * contrast) + 128));
                    data[i] = data[i + 1] = data[i + 2] = newVal > 128 ? 255 : 0; // Binarize
                }
                ctx.putImageData(imageData, 0, 0);

                try {
                    // Try Hebrew first
                    const result = await Tesseract.recognize(canvas, 'heb', {
                        logger: m => console.log(m)
                    });

                    let text = result.data.text.trim();

                    // If no Hebrew found, try English and translate
                    if (!text || text.length < 2) {
                        const engResult = await Tesseract.recognize(canvas, 'eng', {
                            logger: m => console.log(m)
                        });
                        text = engResult.data.text.trim();
                    }

                    // Extract meaningful words
                    const words = text.match(/[\u0590-\u05FFa-zA-Z]{2,}/g) || [];
                    const cleanWords = words.filter(w => w.length >= 2 && !['של', 'את', 'או', 'גם', 'עם', 'the', 'and', 'or'].includes(w.toLowerCase()));

                    if (cleanWords.length > 0) {
                        let productName = cleanWords.slice(0, 3).join(' ');

                        // If English, translate to Hebrew
                        if (isEnglishText(productName)) {
                            productName = translateProductToHebrew(productName);
                        }

                        // Try to find matching product in our database
                        const suggestions = getPriceSearchSuggestions(productName);
                        if (suggestions.length > 0) {
                            setScannedProductName(suggestions[0]);
                        } else {
                            setScannedProductName(productName);
                        }
                    } else {
                        setScannedProductName('');
                    }
                } catch (err) {
                    console.error('OCR Error:', err);
                } finally {
                    setScanningPrice(false);

                    // Stop camera after scan - more robust cleanup
                    if (priceVideoRef.current?.srcObject) {
                        const tracks = priceVideoRef.current.srcObject.getTracks();
                        tracks.forEach(track => {
                            track.stop();
                            track.enabled = false;
                        });
                        priceVideoRef.current.srcObject = null;
                    }
                }
            };

            const searchPriceComparison = (productName) => {
                if (!productName) return;

                const encodedName = encodeURIComponent(productName);

                // Israeli supermarket search URLs
                const sites = [
                    { name: 'שופרסל', url: `https://www.shufersal.co.il/online/he/search?text=${encodedName}`, color: 'bg-red-500' },
                    { name: 'רמי לוי', url: `https://www.rami-levy.co.il/he/online/search?q=${encodedName}`, color: 'bg-blue-500' },
                    { name: 'ויקטורי', url: `https://www.victoryonline.co.il/search?q=${encodedName}`, color: 'bg-orange-500' },
                    { name: 'יינות ביתן', url: `https://www.ybitan.co.il/search?q=${encodedName}`, color: 'bg-purple-500' },
                    { name: 'חצי חינם', url: `https://shop.hazi-hinam.co.il/search?q=${encodedName}`, color: 'bg-green-500' }
                ];

                setPriceCompareResults(sites);
            };

            const openPriceLink = (url) => {
                window.open(url, '_blank');
            };

            // Get holiday recommendations
            const getHolidayRecommendations = () => {
                const now = new Date();
                const upcoming = ISRAELI_HOLIDAYS.filter(h => {
                    const daysUntil = Math.ceil((h.dateObj - now) / (1000 * 60 * 60 * 24));
                    return daysUntil > 0 && daysUntil <= 14;
                });

                const recommendations = {
                    'פורים': ['אוזני המן', 'שוקולד', 'ממתקים', 'משקאות', 'פירות יבשים', 'אגוזים'],
                    'פסח': ['מצות', 'יין', 'חרוסת', 'חסה', 'ביצים', 'בשר', 'תפוחי אדמה', 'בצל'],
                    'יום העצמאות': ['בשר טחון', 'נקניקיות', 'המבורגר', 'פחם', 'לחמניות', 'סלטים', 'משקאות קלים'],
                    'ל"ג בעומר': ['נקניקיות', 'בשר', 'פחם', 'תירס', 'לחמניות', 'קטשופ', 'חרדל'],
                    'שבועות': ['גבינות', 'שמנת', 'חלב', 'ביצים', 'פירות', 'עוגת גבינה'],
                    'ראש השנה': ['תפוחים', 'דבש', 'רימונים', 'דגים', 'בשר', 'יין', 'חלה'],
                    'סוכות': ['פירות', 'ירקות', 'בשר', 'עוף', 'יין'],
                    'חנוכה': ['שמן', 'תפוחי אדמה', 'בצל', 'ביצים', 'קמח', 'סופגניות', 'שוקולד מטבעות']
                };

                return upcoming.map(holiday => ({
                    ...holiday,
                    products: recommendations[holiday.name] || []
                })).filter(h => h.products.length > 0);
            };

            // AI Assistant - Smart Shopping Suggestions
            const generateAISuggestions = () => {
                setAiThinking(true);
                setAiSuggestions([]);

                // Simulate AI thinking delay
                setTimeout(() => {
                    const suggestions = [];
                    const currentItems = items.map(i => i.name.toLowerCase());
                    const currentCategories = [...new Set(items.map(i => i.category))];

                    // 1. Suggest complementary items based on what's in cart
                    const complementaryRules = {
                        'פסטה': ['רוטב עגבניות', 'גבינה צהובה', 'שמן זית'],
                        'בשר טחון': ['בצל', 'שום', 'ביצים', 'פירורי לחם'],
                        'חזה עוף': ['לימון', 'שום', 'שמן זית', 'תבלינים'],
                        'לחם': ['חמאה', 'ריבה', 'גבינה צהובה'],
                        'ביצים': ['חלב', 'גבינה צהובה', 'ירקות'],
                        'סלט': ['שמן זית', 'לימון', 'עגבניות', 'מלפפונים'],
                        'אורז': ['רוטב סויה', 'ירקות מוקפצים', 'עוף'],
                        'קפה': ['חלב', 'סוכר', 'עוגיות'],
                        'תה': ['דבש', 'לימון', 'עוגיות'],
                        'שניצל': ['תפוחי אדמה', 'סלט', 'לימון'],
                        'המבורגר': ['לחמניות', 'קטשופ', 'חרדל', 'חסה', 'עגבניות'],
                        'פיצה': ['גבינה צהובה', 'רוטב עגבניות', 'זיתים', 'פטריות']
                    };

                    items.forEach(item => {
                        const itemLower = item.name.toLowerCase();
                        Object.keys(complementaryRules).forEach(key => {
                            if (itemLower.includes(key)) {
                                complementaryRules[key].forEach(suggestion => {
                                    if (!currentItems.some(ci => ci.includes(suggestion.toLowerCase())) &&
                                        !suggestions.some(s => s.name === suggestion)) {
                                        suggestions.push({
                                            type: 'complementary',
                                            name: suggestion,
                                            reason: `משלים ל${item.name}`,
                                            icon: '🧩'
                                        });
                                    }
                                });
                            }
                        });
                    });

                    // 2. Suggest basics if missing
                    const basicItems = ['חלב', 'לחם', 'ביצים', 'חמאה', 'גבינה צהובה'];
                    basicItems.forEach(basic => {
                        if (!currentItems.some(ci => ci.includes(basic.toLowerCase()))) {
                            if (Math.random() > 0.5) { // Don't suggest all basics
                                suggestions.push({
                                    type: 'basic',
                                    name: basic,
                                    reason: 'מוצר בסיסי שכדאי שיהיה בבית',
                                    icon: '🏠'
                                });
                            }
                        }
                    });

                    // 3. Suggest based on day of week
                    const dayOfWeek = new Date().getDay();
                    if (dayOfWeek === 4 || dayOfWeek === 5) { // Thursday or Friday - Shabbat prep
                        const shabbatItems = ['חלה', 'יין', 'נרות שבת', 'עוף', 'תפוחי אדמה'];
                        shabbatItems.forEach(item => {
                            if (!currentItems.some(ci => ci.includes(item.toLowerCase()))) {
                                suggestions.push({
                                    type: 'shabbat',
                                    name: item,
                                    reason: 'לקראת שבת',
                                    icon: '🕯️'
                                });
                            }
                        });
                    }

                    // 4. Suggest based on weather/season (simple logic)
                    const month = new Date().getMonth();
                    if (month >= 5 && month <= 8) { // Summer
                        const summerItems = ['מים', 'אבטיח', 'גלידה', 'מיץ'];
                        summerItems.forEach(item => {
                            if (!currentItems.some(ci => ci.includes(item.toLowerCase())) && Math.random() > 0.6) {
                                suggestions.push({
                                    type: 'seasonal',
                                    name: item,
                                    reason: 'מתאים לקיץ',
                                    icon: '☀️'
                                });
                            }
                        });
                    } else if (month >= 11 || month <= 2) { // Winter
                        const winterItems = ['מרק', 'תה', 'דבש', 'שוקו'];
                        winterItems.forEach(item => {
                            if (!currentItems.some(ci => ci.includes(item.toLowerCase())) && Math.random() > 0.6) {
                                suggestions.push({
                                    type: 'seasonal',
                                    name: item,
                                    reason: 'מתאים לחורף',
                                    icon: '❄️'
                                });
                            }
                        });
                    }

                    // 5. Recipe suggestion based on items
                    if (currentItems.some(ci => ci.includes('פסטה')) &&
                        currentItems.some(ci => ci.includes('רוטב') || ci.includes('עגבני'))) {
                        suggestions.unshift({
                            type: 'recipe',
                            name: '🍝 אפשר להכין פסטה ברוטב עגבניות!',
                            reason: 'כל המרכיבים ברשימה',
                            icon: '👨‍🍳',
                            isRecipe: true
                        });
                    }

                    if (currentItems.some(ci => ci.includes('ביצ')) &&
                        currentItems.some(ci => ci.includes('גבינ'))) {
                        suggestions.unshift({
                            type: 'recipe',
                            name: '🍳 אפשר להכין חביתה עם גבינה!',
                            reason: 'כל המרכיבים ברשימה',
                            icon: '👨‍🍳',
                            isRecipe: true
                        });
                    }

                    // Limit suggestions
                    setAiSuggestions(suggestions.slice(0, 8));
                    setAiThinking(false);
                }, 1500);
            };

            // Add AI suggestion to cart
            const addAISuggestion = async (suggestion) => {
                if (suggestion.isRecipe) return;
                await addProduct(suggestion.name);
                setAiSuggestions(prev => prev.filter(s => s.name !== suggestion.name));
            };

            // Load saved data on mount
            React.useEffect(() => {
                const savedListsData = localStorage.getItem(`savedLists_${family?.id}`);
                if (savedListsData) setSavedLists(JSON.parse(savedListsData));

                const outOfStockData = localStorage.getItem(`outOfStock_${family?.id}`);
                if (outOfStockData) setOutOfStockItems(JSON.parse(outOfStockData));
            }, [family?.id]);

            // Update presence for real-time editing
            React.useEffect(() => {
                if (!family?.id || !user) return;

                const presenceRef = window.firestore.doc(window.db, 'families', family.id, 'presence', user.uid);

                const updatePresence = () => {
                    window.firestore.setDoc(presenceRef, {
                        name: user.displayName || user.email,
                        lastSeen: new Date(),
                        isActive: true
                    }, { merge: true });
                };

                updatePresence();
                const interval = setInterval(updatePresence, 30000);

                // Listen to other editors
                const unsubscribe = window.firestore.onSnapshot(
                    window.firestore.collection(window.db, 'families', family.id, 'presence'),
                    (snapshot) => {
                        const editors = [];
                        const now = new Date();
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (doc.id !== user.uid && data.lastSeen) {
                                const lastSeen = data.lastSeen.toDate ? data.lastSeen.toDate() : new Date(data.lastSeen);
                                if ((now - lastSeen) < 60000) { // Active in last minute
                                    editors.push(data.name);
                                }
                            }
                        });
                        setActiveEditors(editors);
                    }
                );

                return () => {
                    clearInterval(interval);
                    unsubscribe();
                    window.firestore.updateDoc(presenceRef, { isActive: false });
                };
            }, [family?.id, user]);

            // Translate English to Hebrew
            const translateToHebrew = (text) => {
                const lowerText = text.toLowerCase().trim();
                // Direct match
                if (ENGLISH_TO_HEBREW[lowerText]) {
                    return ENGLISH_TO_HEBREW[lowerText];
                }
                // Try without 's' for plurals
                if (lowerText.endsWith('s') && ENGLISH_TO_HEBREW[lowerText.slice(0, -1)]) {
                    return ENGLISH_TO_HEBREW[lowerText.slice(0, -1)];
                }
                // Try partial match
                for (const [eng, heb] of Object.entries(ENGLISH_TO_HEBREW)) {
                    if (lowerText.includes(eng) || eng.includes(lowerText)) {
                        return heb;
                    }
                }
                return text; // Return original if no translation found
            };

            useEffect(() => {
                const savedDark = localStorage.getItem('darkMode') === 'true';
                if (savedDark) {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }
            }, []);

            // Check for first-time visit and show onboarding
            useEffect(() => {
                const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
                if (!hasSeenOnboarding) {
                    setTimeout(() => setShowOnboarding(true), 1000);
                }
                // Load saved accessibility settings
                const savedAccessibility = localStorage.getItem('accessibilitySettings');
                if (savedAccessibility) {
                    const settings = JSON.parse(savedAccessibility);
                    setAccessibilitySettings(settings);
                    applyAccessibilitySettings(settings);
                }
            }, []);

            // Apply accessibility settings to document
            const applyAccessibilitySettings = (settings) => {
                const root = document.documentElement;
                // Font size
                root.style.fontSize = settings.fontSize === 'large' ? '120%' : settings.fontSize === 'small' ? '85%' : '100%';
                // Contrast
                if (settings.contrast === 'high') {
                    root.classList.add('high-contrast');
                    root.classList.remove('low-contrast');
                } else if (settings.contrast === 'low') {
                    root.classList.add('low-contrast');
                    root.classList.remove('high-contrast');
                } else {
                    root.classList.remove('high-contrast', 'low-contrast');
                }
                // Highlight links
                if (settings.highlightLinks) {
                    root.classList.add('highlight-links');
                } else {
                    root.classList.remove('highlight-links');
                }
                // Cursor size
                if (settings.cursorSize === 'large-black') {
                    root.classList.add('cursor-large-black');
                    root.classList.remove('cursor-large-white');
                } else if (settings.cursorSize === 'large-white') {
                    root.classList.add('cursor-large-white');
                    root.classList.remove('cursor-large-black');
                } else {
                    root.classList.remove('cursor-large-black', 'cursor-large-white');
                }
            };

            const updateAccessibility = (key, value) => {
                const newSettings = { ...accessibilitySettings, [key]: value };
                setAccessibilitySettings(newSettings);
                localStorage.setItem('accessibilitySettings', JSON.stringify(newSettings));
                applyAccessibilitySettings(newSettings);
            };

            const resetAccessibility = () => {
                const defaultSettings = { fontSize: 'normal', contrast: 'normal', highlightLinks: false, cursorSize: 'normal' };
                setAccessibilitySettings(defaultSettings);
                localStorage.setItem('accessibilitySettings', JSON.stringify(defaultSettings));
                applyAccessibilitySettings(defaultSettings);
            };

            const completeOnboarding = () => {
                localStorage.setItem('hasSeenOnboarding', 'true');
                setShowOnboarding(false);
            };

            const sendFeedback = async () => {
                if (!feedbackText.trim()) return;
                setFeedbackSending(true);
                try {
                    // Send feedback using EmailJS or similar service (hidden from user)
                    const templateParams = {
                        type: feedbackType,
                        message: feedbackText,
                        user_email: user?.email || 'לא מחובר',
                        user_name: user?.displayName || 'אנונימי'
                    };
                    // Using a simple mailto link as fallback (opens email client)
                    const subject = encodeURIComponent(`[ListNest] ${feedbackType === 'bug' ? 'דיווח על בעיה' : feedbackType === 'feature' ? 'בקשת פיצ\'ר' : 'משוב כללי'}`);
                    const body = encodeURIComponent(`סוג: ${feedbackType}\n\nהודעה:\n${feedbackText}\n\n---\nמשתמש: ${user?.displayName || 'אנונימי'}\nאימייל: ${user?.email || 'לא זמין'}`);
                    window.open(`mailto:shopinglist1979@gmail.com?subject=${subject}&body=${body}`, '_blank');
                    setFeedbackSent(true);
                    setFeedbackText('');
                    setTimeout(() => {
                        setShowFeedback(false);
                        setFeedbackSent(false);
                    }, 2000);
                } catch (error) {
                    console.error('Error sending feedback:', error);
                }
                setFeedbackSending(false);
            };

            useEffect(() => {
                if (!family || !currentList) {
                    setItems([]);
                    setLoading(false);
                    return;
                }

                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'shopping-items'),
                    window.firestore.where('familyId', '==', family.id),
                    window.firestore.where('listId', '==', currentList.id)
                );

                const unsubscribe = window.firestore.onSnapshot(
                    q,
                    (snapshot) => {
                        const itemsData = [];
                        snapshot.forEach((doc) => {
                            itemsData.push({ id: doc.id, ...doc.data() });
                        });
                        // Sort client-side (newest first)
                        itemsData.sort((a, b) => {
                            const dateA = a.createdAt?.toDate?.() || new Date(0);
                            const dateB = b.createdAt?.toDate?.() || new Date(0);
                            return dateB - dateA;
                        });

                        // Check for new items added by other users
                        const currentIds = new Set(itemsData.map(item => item.id));
                        itemsData.forEach(item => {
                            if (!prevItemIdsRef.current.has(item.id) && prevItemIdsRef.current.size > 0) {
                                // New item detected
                                if (item.addedByUid && item.addedByUid !== user?.uid) {
                                    // Added by another user - show notification
                                    showProductNotification(item, item.addedBy || 'מישהו');
                                }
                            }
                        });
                        prevItemIdsRef.current = currentIds;

                        setItems(itemsData);
                        setLoading(false);
                    },
                    (error) => {
                        console.error('שגיאה בטעינת נתונים:', error);
                        setLoading(false);
                    }
                );

                loadHistory();
                return () => unsubscribe();
            }, [family, currentList]);

            const loadHistory = async () => {
                if (!family) return;
                try {
                    const historyQuery = window.firestore.query(
                        window.firestore.collection(window.db, 'shopping-history'),
                        window.firestore.where('familyId', '==', family.id)
                    );
                    const snapshot = await window.firestore.getDocs(historyQuery);
                    const historyData = [];
                    snapshot.forEach(doc => {
                        historyData.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort client-side (newest first)
                    historyData.sort((a, b) => {
                        const dateA = a.completedAt?.toDate?.() || new Date(0);
                        const dateB = b.completedAt?.toDate?.() || new Date(0);
                        return dateB - dateA;
                    });
                    setHistory(historyData);
                } catch (error) {
                    console.error('שגיאה בטעינת היסטוריה:', error);
                }
            };

            // Request notification permission
            useEffect(() => {
                const requestNotificationPermission = async () => {
                    if ('Notification' in window) {
                        if (Notification.permission === 'granted') {
                            setNotificationsEnabled(true);
                        } else if (Notification.permission !== 'denied') {
                            const permission = await Notification.requestPermission();
                            setNotificationsEnabled(permission === 'granted');
                        }
                    }
                };
                requestNotificationPermission();
            }, []);

            // Show chat notification
            const showChatNotification = (message) => {
                if (!notificationsEnabled || !('Notification' in window)) return;
                if (Notification.permission !== 'granted') return;

                // Don't show if chat is open and visible
                if (showChat && document.visibilityState === 'visible') return;

                const title = `💬 ${message.senderName || 'הודעה חדשה'}`;
                const body = message.photoUrl ? '📷 שלח/ה תמונה' : message.text || 'הודעה חדשה';

                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: '🛒',
                        badge: '🛒',
                        tag: 'chat-message',
                        renotify: true,
                        vibrate: [200, 100, 200]
                    });

                    notification.onclick = () => {
                        window.focus();
                        setShowChat(true);
                        notification.close();
                    };

                    // Auto close after 5 seconds
                    setTimeout(() => notification.close(), 5000);
                } catch (error) {
                    console.error('Notification error:', error);
                }
            };

            // Show product added notification
            const showProductNotification = (item, addedByName) => {
                if (!notificationsEnabled || !('Notification' in window)) return;
                if (Notification.permission !== 'granted') return;
                if (document.visibilityState === 'visible') return; // Don't notify if app is visible

                const title = `🛒 מוצר נוסף לרשימה`;
                const body = `${addedByName} הוסיף/ה: ${item.name}`;

                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: '🛒',
                        badge: '🛒',
                        tag: 'product-added',
                        renotify: true,
                        vibrate: [200, 100, 200]
                    });

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    setTimeout(() => notification.close(), 4000);
                } catch (error) {
                    console.error('Notification error:', error);
                }
            };

            // Mark messages as read when chat is opened
            const markMessagesAsRead = async () => {
                if (!family || !user || !showChat) return;

                const unreadMessages = chatMessages.filter(msg =>
                    msg.senderUid !== user.uid &&
                    (!msg.readBy || !msg.readBy.includes(user.uid))
                );

                for (const msg of unreadMessages) {
                    try {
                        await window.firestore.updateDoc(
                            window.firestore.doc(window.db, 'family-chat', msg.id),
                            { readBy: window.firestore.arrayUnion(user.uid) }
                        );
                    } catch (e) {
                        console.error('Error marking message as read:', e);
                    }
                }
            };

            // Mark messages as read when chat opens
            useEffect(() => {
                if (showChat && chatMessages.length > 0) {
                    markMessagesAsRead();
                }
            }, [showChat, chatMessages.length]);

            // Load chat messages
            useEffect(() => {
                if (!family) {
                    setChatMessages([]);
                    return;
                }

                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'family-chat'),
                    window.firestore.where('familyId', '==', family.id)
                );

                const unsubscribe = window.firestore.onSnapshot(q, (snapshot) => {
                    const messages = [];
                    snapshot.forEach((doc) => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    messages.sort((a, b) => {
                        const dateA = a.createdAt?.toDate?.() || new Date(0);
                        const dateB = b.createdAt?.toDate?.() || new Date(0);
                        return dateA - dateB;
                    });

                    // Check for new messages from other users and send notification
                    if (messages.length > 0 && user) {
                        const latestMessage = messages[messages.length - 1];
                        if (latestMessage.id !== lastMessageIdRef.current &&
                            latestMessage.senderUid !== user.uid &&
                            lastMessageIdRef.current !== null) {
                            // New message from someone else
                            showChatNotification(latestMessage);
                        }
                        lastMessageIdRef.current = latestMessage.id;
                    }

                    setChatMessages(messages);
                });

                return () => unsubscribe();
            }, [family, user]);

            // Load recipes
            useEffect(() => {
                if (!family) {
                    setRecipes([]);
                    return;
                }

                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'recipes'),
                    window.firestore.where('familyId', '==', family.id)
                );

                const unsubscribe = window.firestore.onSnapshot(q, (snapshot) => {
                    const recipesData = [];
                    snapshot.forEach((doc) => {
                        recipesData.push({ id: doc.id, ...doc.data() });
                    });
                    recipesData.sort((a, b) => {
                        const dateA = a.createdAt?.toDate?.() || new Date(0);
                        const dateB = b.createdAt?.toDate?.() || new Date(0);
                        return dateB - dateA;
                    });
                    setRecipes(recipesData);
                });

                return () => unsubscribe();
            }, [family]);

            // Load forgotten stats
            useEffect(() => {
                if (!family) {
                    setForgottenStats({});
                    setShoppingStreak(0);
                    setAchievements([]);
                    return;
                }

                const monthKey = new Date().toISOString().slice(0, 7);
                const docRef = window.firestore.doc(window.db, 'forgotten-stats', `${family.id}_${monthKey}`);

                const unsubscribe = window.firestore.onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        setForgottenStats(doc.data().items || {});
                    } else {
                        setForgottenStats({});
                    }
                });

                // Load streak data
                loadShoppingStreak();

                return () => unsubscribe();
            }, [family]);

            // Recalculate achievements when stats change
            useEffect(() => {
                const newAchievements = [];

                // Only show achievements if we have some shopping history
                const essentials = ['חלב', 'לחם', 'ביצים', 'גבינה', 'עגבניות', 'מלפפונים'];

                // Check for items with zero forgets this month (only show top 3)
                let perfectCount = 0;
                essentials.forEach(item => {
                    if ((!forgottenStats[item] || forgottenStats[item] === 0) && perfectCount < 3) {
                        newAchievements.push({
                            name: `${item} Master`,
                            emoji: '🏆',
                            description: `0 פעמים שכחת ${item} החודש`
                        });
                        perfectCount++;
                    }
                });

                // Perfect week achievement
                if (shoppingStreak >= 7) {
                    newAchievements.push({
                        name: 'שבוע מושלם',
                        emoji: '⭐',
                        description: `${shoppingStreak} קניות ברצף בלי לשכוח!`
                    });
                } else if (shoppingStreak >= 3) {
                    newAchievements.push({
                        name: 'על הדרך הנכונה',
                        emoji: '🌟',
                        description: `${shoppingStreak} קניות ברצף!`
                    });
                }

                // Memory champion
                if (Object.keys(forgottenStats).length === 0 || Object.values(forgottenStats).every(v => v === 0)) {
                    newAchievements.push({
                        name: 'אלוף הזיכרון',
                        emoji: '🧠',
                        description: 'לא שכחת כלום החודש!'
                    });
                }

                setAchievements(newAchievements);
            }, [forgottenStats, shoppingStreak]);

            // Load regular items (items that appear frequently in shopping history)
            useEffect(() => {
                if (!family || history.length === 0) {
                    setRegularItems([]);
                    return;
                }

                // Count item frequency across all shopping history
                const itemCounts = {};
                history.forEach(record => {
                    record.items?.forEach(item => {
                        const name = item.name?.toLowerCase?.() || '';
                        if (name) {
                            itemCounts[name] = (itemCounts[name] || 0) + 1;
                        }
                    });
                });

                // Get items that appear in at least 3 shopping trips or 30% of trips
                const minCount = Math.max(3, Math.floor(history.length * 0.3));
                const regulars = Object.entries(itemCounts)
                    .filter(([_, count]) => count >= minCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 20)
                    .map(([name, count]) => ({ name, count }));

                setRegularItems(regulars);
            }, [family, history]);

            // Calculate upcoming holidays (within next 14 days)
            useEffect(() => {
                // This is a simplified version - in production you'd use a proper Hebrew calendar library
                const checkUpcomingHolidays = () => {
                    const today = new Date();
                    const twoWeeksFromNow = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);

                    // For demo purposes, we'll show random holiday reminders occasionally
                    // In production, you'd integrate with a Hebrew calendar API
                    const savedReminders = JSON.parse(localStorage.getItem('holidayReminders') || '[]');
                    const lastCheck = localStorage.getItem('lastHolidayCheck');
                    const now = Date.now();

                    // Check once per day
                    if (!lastCheck || now - parseInt(lastCheck) > 24 * 60 * 60 * 1000) {
                        localStorage.setItem('lastHolidayCheck', now.toString());
                        // In a real implementation, calculate actual Hebrew dates here
                    }

                    setUpcomingHolidays(savedReminders);
                };

                checkUpcomingHolidays();
            }, []);

            // Add regular items to cart
            const addRegularItems = async () => {
                const currentItemNames = items.map(i => i.name.toLowerCase());
                const itemsToAdd = regularItems.filter(r => !currentItemNames.includes(r.name.toLowerCase()));

                for (const item of itemsToAdd) {
                    // Find category for the item
                    let category = 'other';
                    for (const [cat, products] of Object.entries(PRODUCTS)) {
                        if (products.some(p => p.toLowerCase() === item.name.toLowerCase())) {
                            category = cat;
                            break;
                        }
                    }

                    const unit = CATEGORIES[category]?.unit || 'יח\'';

                    await window.firestore.addDoc(window.firestore.collection(window.db, 'shopping-items'), {
                        name: item.name.charAt(0).toUpperCase() + item.name.slice(1),
                        category,
                        quantity: `1 ${unit}`,
                        unit,
                        purchased: false,
                        addedBy: user.displayName || user.email,
                        addedByUid: user.uid,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        familyId: family.id,
                        listId: currentList.id,
                        isRegular: true
                    });
                }

                if (itemsToAdd.length > 0) {
                    alert(`נוספו ${itemsToAdd.length} מוצרים קבועים לרשימה! 🎉`);
                } else {
                    alert('כל המוצרים הקבועים כבר נמצאים ברשימה');
                }

                setShowRegulars(false);
            };

            // Load shopping streak
            const loadShoppingStreak = async () => {
                if (!family) return;

                try {
                    const streakRef = window.firestore.doc(window.db, 'shopping-streaks', family.id);
                    const streakDoc = await window.firestore.getDoc(streakRef);

                    if (streakDoc.exists()) {
                        const data = streakDoc.data();
                        const lastDate = data.lastShoppingDate?.toDate?.() || new Date(0);
                        const daysSinceLast = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));

                        // Reset streak if more than 2 days passed
                        if (daysSinceLast > 2) {
                            setShoppingStreak(0);
                        } else {
                            setShoppingStreak(data.streak || 0);
                        }
                    }
                } catch (error) {
                    console.error('Error loading streak:', error);
                }
            };

            // Update streak on successful shopping
            const updateShoppingStreak = async (hadForgottenItems) => {
                if (!family) return;

                try {
                    const streakRef = window.firestore.doc(window.db, 'shopping-streaks', family.id);
                    const streakDoc = await window.firestore.getDoc(streakRef);

                    let newStreak = 1;
                    if (streakDoc.exists() && !hadForgottenItems) {
                        const data = streakDoc.data();
                        const lastDate = data.lastShoppingDate?.toDate?.() || new Date(0);
                        const daysSinceLast = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));

                        if (daysSinceLast <= 2) {
                            newStreak = (data.streak || 0) + 1;
                        }
                    } else if (hadForgottenItems) {
                        newStreak = 0;
                    }

                    await window.firestore.setDoc(streakRef, {
                        familyId: family.id,
                        streak: newStreak,
                        lastShoppingDate: new Date(),
                        updatedAt: new Date()
                    });

                    setShoppingStreak(newStreak);
                } catch (error) {
                    console.error('Error updating streak:', error);
                }
            };

            // Get playful message for forgotten count
            const getForgottenMessage = (count) => {
                if (count === 0) return { emoji: '👌', text: 'מושלם!' };
                if (count === 1) return { emoji: '😅', text: 'קרה פעם אחת' };
                if (count === 2) return { emoji: '🙈', text: 'אופס, שוב?' };
                if (count === 3) return { emoji: '😬', text: 'שלוש פעמים...' };
                if (count >= 4) return { emoji: '🤦', text: 'בואו נשים תזכורת!' };
                return { emoji: '📊', text: `${count} פעמים` };
            };

            // Recipe scanning functions
            const startRecipeScan = () => {
                setScanningRecipe(false);
                setScanProgress(0);
                setScannedText('');
                setScannedIngredients([]);
                setScannedRecipeName('מתכון סרוק');
                recipeScanActiveRef.current = true;
                setShowRecipeScan(true);

                // Wait for modal to render, then start camera
                setTimeout(async () => {
                    if (!recipeScanActiveRef.current) return;

                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
                        });
                        // Another small delay to ensure video element is fully mounted
                        setTimeout(() => {
                            if (recipeVideoRef.current && recipeScanActiveRef.current) {
                                recipeVideoRef.current.srcObject = stream;
                            } else {
                                // Stop stream if modal was closed
                                stream.getTracks().forEach(track => track.stop());
                            }
                        }, 200);
                    } catch (error) {
                        console.error('Camera error:', error);
                        alert('לא ניתן לגשת למצלמה');
                        recipeScanActiveRef.current = false;
                        setShowRecipeScan(false);
                    }
                }, 300);
            };

            const captureAndScanRecipe = async () => {
                if (!recipeVideoRef.current || !recipeCanvasRef.current) return;

                const video = recipeVideoRef.current;
                const canvas = recipeCanvasRef.current;

                // Use higher resolution for better OCR
                const scale = 2;
                canvas.width = video.videoWidth * scale;
                canvas.height = video.videoHeight * scale;
                const ctx = canvas.getContext('2d');

                // Draw and scale up
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Image preprocessing for better OCR
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                // Convert to grayscale with enhanced contrast
                for (let i = 0; i < data.length; i += 4) {
                    // Grayscale
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    // Increase contrast
                    const contrast = 1.4;
                    let newVal = ((gray - 128) * contrast) + 128;
                    newVal = Math.min(255, Math.max(0, newVal));
                    // Apply sharpening threshold (adaptive binarization simulation)
                    const threshold = 140;
                    const finalVal = newVal > threshold ? 255 : (newVal > 80 ? newVal * 1.2 : 0);
                    data[i] = data[i + 1] = data[i + 2] = Math.min(255, finalVal);
                }
                ctx.putImageData(imageData, 0, 0);

                // Stop camera - more robust cleanup
                if (video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => {
                        track.stop();
                        track.enabled = false;
                    });
                    video.srcObject = null;
                }

                setScanningRecipe(true);
                setScanProgress(5);

                try {
                    if (typeof Tesseract === 'undefined') {
                        throw new Error('OCR library not loaded');
                    }

                    const processedImageData = canvas.toDataURL('image/png');

                    const result = await Tesseract.recognize(
                        processedImageData,
                        'heb',
                        {
                            logger: info => {
                                if (info.status === 'recognizing text') {
                                    setScanProgress(Math.round(info.progress * 85) + 10);
                                }
                            },
                            tessedit_pageseg_mode: '6', // Assume uniform block of text
                            preserve_interword_spaces: '1'
                        }
                    );

                    setScanProgress(95);
                    const text = result.data.text;
                    setScannedText(text);

                    const parsedIngredients = parseIngredientsFromText(text);
                    setScannedIngredients(parsedIngredients);
                    setScanProgress(100);

                } catch (error) {
                    console.error('OCR error:', error);
                    alert('שגיאה בזיהוי טקסט: ' + error.message);
                } finally {
                    setScanningRecipe(false);
                }
            };

            // Common Hebrew ingredients for better matching
            const COMMON_INGREDIENTS = [
                'בשר', 'בשר טחון', 'בשר בקר', 'עוף', 'חזה עוף', 'שוקיים', 'כרעיים',
                'בצל', 'שום', 'גזר', 'תפוח אדמה', 'עגבניה', 'עגבניות', 'מלפפון', 'פלפל',
                'שמן', 'שמן זית', 'שמן קנולה', 'חמאה', 'מרגרינה',
                'מלח', 'פלפל שחור', 'פפריקה', 'כמון', 'כורכום', 'אבקת מרק',
                'קמח', 'סוכר', 'ביצים', 'ביצה', 'חלב', 'שמנת', 'גבינה',
                'אורז', 'פסטה', 'אטריות', 'קוסקוס', 'בורגול',
                'עלי כוסברה', 'פטרוזיליה', 'שמיר', 'בזיליקום', 'נענע',
                'לימון', 'מיץ לימון', 'חומץ', 'רסק עגבניות', 'תמרים',
                'אגוזים', 'שקדים', 'צנוברים', 'אגוזי מלך',
                'חומוס', 'טחינה', 'תחינה', 'סילאן', 'דבש',
                'יין', 'יין אדום', 'יין לבן', 'מים', 'ציר עוף', 'ציר ירקות'
            ];

            const parseIngredientsFromText = (text) => {
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 2);
                const ingredients = [];
                const seenNames = new Set();

                // Skip words that indicate instructions, not ingredients
                const skipWords = ['הוראות', 'הכנה', 'אופן', 'שלב', 'הגשה', 'טיפ', 'הערה', 'לקישוט', 'step', 'instructions', 'method', 'directions'];
                const skipPatterns = [/^\d+\.\s*[א-ת]/, /^שלב\s*\d/, /מנות|זמן|דקות|שעות/];

                // Units patterns
                const unitPatterns = /(\d+\.?\d*)\s*(כוס|כוסות|כפ[יו]ת?|כף|גרם|ג['\u0027]|ק["\u0022]ג|קילו|מ["\u0022]ל|ליטר|יחיד[הו]ת?|יח['\u0027]?|חבילה|חבילות|שקית|קופסה|פחית)/i;

                for (const line of lines) {
                    // Skip instruction lines
                    if (skipWords.some(word => line.includes(word))) continue;
                    if (skipPatterns.some(pattern => pattern.test(line))) continue;
                    if (line.length > 60) continue; // Too long, probably instructions

                    // Clean the line
                    let cleanLine = line
                        .replace(/[•\-\*\(\)]/g, ' ')
                        .replace(/\s+/g, ' ')
                        .trim();

                    if (cleanLine.length < 3) continue;

                    // Extract quantity and unit
                    let quantity = 1;
                    let unit = '';
                    const unitMatch = cleanLine.match(unitPatterns);
                    if (unitMatch) {
                        quantity = parseFloat(unitMatch[1]) || 1;
                        unit = unitMatch[2];
                    }

                    // Try to find known ingredient in line
                    let foundIngredient = null;

                    // First try exact match with common ingredients
                    for (const ing of COMMON_INGREDIENTS) {
                        if (cleanLine.includes(ing)) {
                            foundIngredient = ing;
                            break;
                        }
                    }

                    // Then try matching with PRODUCTS database
                    if (!foundIngredient) {
                        for (const [cat, products] of Object.entries(PRODUCTS)) {
                            for (const product of products) {
                                if (cleanLine.includes(product) || product.split(' ').every(word => word.length > 2 && cleanLine.includes(word))) {
                                    foundIngredient = product;
                                    break;
                                }
                            }
                            if (foundIngredient) break;
                        }
                    }

                    // If no match found, try to extract ingredient name
                    if (!foundIngredient) {
                        // Remove quantities and units, keep the ingredient name
                        let name = cleanLine
                            .replace(/\d+\.?\d*/g, '')
                            .replace(/(כוס|כוסות|כפ[יו]ת?|כף|גרם|ג['\u0027]|ק["\u0022]ג|קילו|מ["\u0022]ל|ליטר|יחיד[הו]ת?|יח['\u0027]?|חבילה|שקית|קופסה|פחית|סה["\u0022]כ|בערך|כ\-|או)/gi, '')
                            .replace(/[\-–—]/g, '')
                            .replace(/\s+/g, ' ')
                            .trim();

                        // Only keep if it looks like a valid ingredient (Hebrew letters, reasonable length)
                        if (name.length >= 2 && name.length <= 30 && /[א-ת]/.test(name)) {
                            foundIngredient = name;
                        }
                    }

                    if (foundIngredient && !seenNames.has(foundIngredient.toLowerCase())) {
                        seenNames.add(foundIngredient.toLowerCase());
                        ingredients.push({
                            name: foundIngredient,
                            quantity,
                            unit,
                            original: line,
                            selected: true
                        });
                    }
                }

                return ingredients;
            };

            const cancelRecipeScan = () => {
                recipeScanActiveRef.current = false;
                if (recipeVideoRef.current && recipeVideoRef.current.srcObject) {
                    const tracks = recipeVideoRef.current.srcObject.getTracks();
                    tracks.forEach(track => {
                        track.stop();
                        track.enabled = false;
                    });
                    recipeVideoRef.current.srcObject = null;
                }
                setShowRecipeScan(false);
                setScannedIngredients([]);
            };

            const toggleScannedIngredient = (index) => {
                setScannedIngredients(prev => prev.map((ing, i) => i === index ? { ...ing, selected: !ing.selected } : ing));
            };

            const addScannedToCart = async () => {
                const selected = scannedIngredients.filter(ing => ing.selected);
                if (selected.length === 0) { alert('נא לבחור לפחות מרכיב אחד'); return; }

                setScanningRecipe(true);
                try {
                    for (const ingredient of selected) {
                        let category = 'other';
                        for (const [cat, products] of Object.entries(PRODUCTS)) {
                            if (products.some(p => p.includes(ingredient.name) || ingredient.name.includes(p))) {
                                category = cat; break;
                            }
                        }

                        await window.firestore.addDoc(window.firestore.collection(window.db, 'shopping-items'), {
                            name: ingredient.name,
                            category: category,
                            quantity: ingredient.quantity,
                            purchased: false,
                            familyId: family.id,
                            listId: currentList.id,
                            addedBy: user.displayName || user.email,
                            addedByUid: user.uid,
                            note: '📷 נסרק ממתכון',
                            createdAt: new Date()
                        });
                    }

                    await logActivity('scanned_recipe_added', { count: selected.length });
                    recipeScanActiveRef.current = false;
                    setShowRecipeScan(false);
                    setShowRecipes(false);
                    setScannedIngredients([]);
                } catch (error) {
                    console.error('Error adding items:', error);
                    alert('שגיאה בהוספת המרכיבים');
                } finally {
                    setScanningRecipe(false);
                }
            };

            // Save new recipe
            const saveRecipe = async () => {
                if (!newRecipeName.trim() || !newRecipeIngredients.trim()) {
                    alert('נא למלא שם מתכון ורשימת מרכיבים');
                    return;
                }

                // Parse ingredients - split by newlines or commas
                const ingredients = newRecipeIngredients
                    .split(/[\n,]/)
                    .map(i => i.trim())
                    .filter(i => i.length > 0)
                    .map(i => {
                        // Try to parse quantity and item name
                        // Patterns like: "2 כוסות קמח", "קמח 2 כוסות", "חלב", "3 ביצים"
                        const match = i.match(/^(\d+\.?\d*)\s*(.+)$/) || i.match(/^(.+?)\s+(\d+\.?\d*).*$/);
                        if (match) {
                            const num = parseFloat(match[1]) || parseFloat(match[2]);
                            const name = match[2] || match[1];
                            if (!isNaN(num)) {
                                return { name: name.replace(/^\d+\.?\d*\s*/, '').trim(), quantity: Math.ceil(num) || 1 };
                            }
                        }
                        return { name: i, quantity: 1 };
                    });

                try {
                    await window.firestore.addDoc(window.firestore.collection(window.db, 'recipes'), {
                        name: newRecipeName.trim(),
                        ingredients: ingredients,
                        rawIngredients: newRecipeIngredients.trim(),
                        familyId: family.id,
                        createdBy: user.displayName || user.email,
                        createdByUid: user.uid,
                        createdAt: window.firestore.serverTimestamp()
                    });
                    setNewRecipeName('');
                    setNewRecipeIngredients('');
                    setShowAddRecipe(false);
                    await logActivity('recipe_added', { recipeName: newRecipeName.trim() });
                } catch (error) {
                    console.error('שגיאה בשמירת מתכון:', error);
                    alert('שגיאה בשמירת המתכון');
                }
            };

            // Delete recipe
            const deleteRecipe = async (recipeId, recipeName) => {
                if (!confirm(`למחוק את המתכון "${recipeName}"?`)) return;
                try {
                    await window.firestore.deleteDoc(window.firestore.doc(window.db, 'recipes', recipeId));
                } catch (error) {
                    console.error('שגיאה במחיקת מתכון:', error);
                }
            };

            // Add all recipe ingredients to shopping list
            const addRecipeToCart = async (recipe) => {
                setAddingRecipeItems(recipe.id);
                try {
                    for (const ingredient of recipe.ingredients) {
                        // Check if item already exists in current list
                        const existing = items.find(item =>
                            item.name.includes(ingredient.name) || ingredient.name.includes(item.name)
                        );

                        if (existing && !existing.purchased) {
                            // Update quantity
                            await window.firestore.updateDoc(
                                window.firestore.doc(window.db, 'shopping-items', existing.id),
                                {
                                    quantity: existing.quantity + ingredient.quantity,
                                    updatedAt: new Date(),
                                    updatedBy: user.displayName || user.email
                                }
                            );
                        } else {
                            // Find matching category from products
                            let category = 'other';
                            for (const [cat, products] of Object.entries(PRODUCTS)) {
                                if (products.some(p => p.includes(ingredient.name) || ingredient.name.includes(p))) {
                                    category = cat;
                                    break;
                                }
                            }

                            // Add new item
                            await window.firestore.addDoc(window.firestore.collection(window.db, 'shopping-items'), {
                                name: ingredient.name,
                                category: category,
                                quantity: ingredient.quantity,
                                purchased: false,
                                familyId: family.id,
                                listId: currentList.id,
                                addedBy: user.displayName || user.email,
                                addedByUid: user.uid,
                                note: `מתכון: ${recipe.name}`,
                                createdAt: new Date()
                            });
                        }
                    }
                    await logActivity('recipe_added_to_cart', { recipeName: recipe.name, itemCount: recipe.ingredients.length });
                    setShowRecipes(false);
                } catch (error) {
                    console.error('שגיאה בהוספת מרכיבי מתכון:', error);
                    alert('שגיאה בהוספת המרכיבים');
                } finally {
                    setAddingRecipeItems(null);
                }
            };

            // Voice recognition functions
            const startListening = () => {
                if (isListening) return;

                // Stop any existing recognition
                if (recognitionRef.current) {
                    try { recognitionRef.current.abort(); } catch(e) {}
                }

                // Clear previous timeout
                if (voiceTimeoutRef.current) {
                    clearTimeout(voiceTimeoutRef.current);
                }

                setVoiceTranscript('');
                setVoiceStatus(voiceLang === 'en-US' ? 'Starting...' : 'מתחיל...');
                setIsListening(true);

                // Create fresh recognition instance
                const recognition = createRecognition();
                if (!recognition) {
                    setIsListening(false);
                    setVoiceStatus('הדפדפן לא תומך בזיהוי קול');
                    return;
                }

                recognitionRef.current = recognition;

                try {
                    recognition.start();

                    // Auto-stop after 10 seconds if no result
                    voiceTimeoutRef.current = setTimeout(() => {
                        if (isListening) {
                            setVoiceStatus(voiceLang === 'en-US' ? 'Timeout - try again' : 'זמן ההאזנה נגמר - נסה שוב');
                            try { recognition.stop(); } catch(e) {}
                            setIsListening(false);
                        }
                    }, 10000);

                } catch (e) {
                    console.error('Failed to start recognition:', e);
                    setIsListening(false);
                    setVoiceStatus('שגיאה בהפעלת זיהוי קול: ' + e.message);
                }
            };

            const stopListening = () => {
                if (voiceTimeoutRef.current) {
                    clearTimeout(voiceTimeoutRef.current);
                }
                if (recognitionRef.current) {
                    try {
                        recognitionRef.current.stop();
                    } catch(e) {}
                }
                setIsListening(false);
                setVoiceStatus(voiceLang === 'en-US' ? 'Stopped' : 'הופסק');
            };

            const processVoiceCommand = async (transcript, lang = 'he-IL') => {
                const text = transcript.trim().toLowerCase();
                if (!text) return;

                const isEnglish = lang === 'en-US';
                let itemPatterns;

                if (isEnglish) {
                    // Parse English - remove common phrases and split by "and", commas
                    itemPatterns = text
                        .replace(/add|buy|get|i need|i want|we need|please|some|the|a |an /gi, '')
                        .split(/\s*(?:,|and|&)\s*/)
                        .map(item => item.trim())
                        .filter(item => item.length > 1)
                        .map(item => translateToHebrew(item)); // Translate each item
                } else {
                    // Parse Hebrew - remove common phrases and split by "ו" (and), commas
                    itemPatterns = text
                        .replace(/תוסיף|הוסף|צריך|צריכה|קנה|קני|תקנה|תקני|אני רוצה|אני צריך|אני צריכה/g, '')
                        .split(/\s*(?:,|ו(?:גם)?|וגם)\s*/)
                        .map(item => item.trim())
                        .filter(item => item.length > 1);
                }

                if (itemPatterns.length === 0) {
                    // Try as single item
                    let singleItem;
                    if (isEnglish) {
                        singleItem = translateToHebrew(text.replace(/add|buy|get|i need|i want|we need|please|some|the|a |an /gi, '').trim());
                    } else {
                        singleItem = text.replace(/תוסיף|הוסף|צריך|צריכה|קנה|קני|תקנה|תקני|אני רוצה|אני צריך|אני צריכה/g, '').trim();
                    }
                    if (singleItem.length > 1) {
                        itemPatterns.push(singleItem);
                    }
                }

                let addedCount = 0;
                for (const itemText of itemPatterns) {
                    // Try to find matching product in database
                    let matchedProduct = null;
                    let matchedCategory = 'other';

                    for (const [cat, products] of Object.entries(PRODUCTS)) {
                        const found = products.find(p =>
                            p.includes(itemText) || itemText.includes(p) ||
                            p.split(' ').some(word => itemText.includes(word) && word.length > 2)
                        );
                        if (found) {
                            matchedProduct = found;
                            matchedCategory = cat;
                            break;
                        }
                    }

                    const productName = matchedProduct || itemText;

                    // Check if already in list
                    const existing = items.find(item =>
                        item.name === productName ||
                        item.name.includes(itemText) ||
                        itemText.includes(item.name)
                    );

                    try {
                        if (existing && !existing.purchased) {
                            await window.firestore.updateDoc(
                                window.firestore.doc(window.db, 'shopping-items', existing.id),
                                { quantity: existing.quantity + 1, updatedAt: new Date() }
                            );
                        } else {
                            await window.firestore.addDoc(window.firestore.collection(window.db, 'shopping-items'), {
                                name: productName,
                                category: matchedCategory,
                                quantity: 1,
                                purchased: false,
                                familyId: family.id,
                                listId: currentList.id,
                                addedBy: user.displayName || user.email,
                                addedByUid: user.uid,
                                note: '🎤 נוסף בקול',
                                createdAt: new Date()
                            });
                        }
                        addedCount++;
                    } catch (error) {
                        console.error('Error adding voice item:', error);
                    }
                }

                if (addedCount > 0) {
                    await logActivity('voice_items_added', { count: addedCount, transcript: transcript });
                    // Visual/audio feedback
                    if (navigator.vibrate) navigator.vibrate(100);
                }

                setVoiceTranscript('');
            };

            // Send chat message
            const sendChatMessage = async (text, photoUrl = null) => {
                if (!text.trim() && !photoUrl) return;
                try {
                    await window.firestore.addDoc(window.firestore.collection(window.db, 'family-chat'), {
                        text: text.trim(),
                        photoUrl: photoUrl,
                        senderName: user.displayName || user.email,
                        senderUid: user.uid,
                        familyId: family.id,
                        createdAt: window.firestore.serverTimestamp()
                    });
                    setChatInput('');
                    setCapturedPhoto(null);
                } catch (error) {
                    console.error('שגיאה בשליחת הודעה:', error);
                }
            };

            // Camera functions
            const startCamera = async () => {
                setShowCamera(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (error) {
                    console.error('שגיאה בפתיחת מצלמה:', error);
                    alert('לא ניתן לגשת למצלמה');
                    setShowCamera(false);
                }
            };

            const capturePhoto = () => {
                if (videoRef.current && canvasRef.current) {
                    const canvas = canvasRef.current;
                    const video = videoRef.current;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    const photoData = canvas.toDataURL('image/jpeg', 0.8);
                    setCapturedPhoto(photoData);
                    stopCamera();
                }
            };

            const stopCamera = () => {
                if (videoRef.current && videoRef.current.srcObject) {
                    const tracks = videoRef.current.srcObject.getTracks();
                    tracks.forEach(track => {
                        track.stop();
                        track.enabled = false;
                    });
                    videoRef.current.srcObject = null;
                }
                setShowCamera(false);
            };

            // Handle receipt photo capture
            const handleReceiptCapture = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                setUploadingReceipt(true);
                try {
                    // Compress and convert to base64
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const img = new Image();
                        img.onload = () => {
                            // Create canvas for compression
                            const canvas = document.createElement('canvas');
                            const maxSize = 800;
                            let width = img.width;
                            let height = img.height;

                            // Scale down if too large
                            if (width > height && width > maxSize) {
                                height = (height * maxSize) / width;
                                width = maxSize;
                            } else if (height > maxSize) {
                                width = (width * maxSize) / height;
                                height = maxSize;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            // Get compressed base64
                            const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                            setReceiptPhoto(compressedData);
                            setUploadingReceipt(false);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error processing receipt:', error);
                    setUploadingReceipt(false);
                    alert('שגיאה בעיבוד התמונה');
                }

                // Clear the input
                e.target.value = '';
            };

            // Enhanced toggle purchased with animation
            const togglePurchasedWithAnimation = async (id, currentStatus, event) => {
                if (!currentStatus) {
                    // Adding to purchased - show confetti!
                    const rect = event?.currentTarget?.getBoundingClientRect();
                    if (rect) {
                        setConfetti({ x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 });
                        setTimeout(() => setConfetti(null), 600);
                    }
                    setAnimatingItems(prev => new Set([...prev, id]));
                    setTimeout(() => {
                        setAnimatingItems(prev => {
                            const newSet = new Set(prev);
                            newSet.delete(id);
                            return newSet;
                        });
                    }, 400);
                }
                await togglePurchased(id, currentStatus);
            };

            const handleLogout = async () => {
                try {
                    await window.firebaseAuth.signOut(window.auth);
                } catch (error) {
                    console.error('שגיאה בהתנתקות:', error);
                }
            };

            const toggleDarkMode = () => {
                const newMode = !darkMode;
                setDarkMode(newMode);
                localStorage.setItem('darkMode', String(newMode));
                document.documentElement.classList.toggle('dark');
            };

            // Calendar helper functions
            const getCalendarDays = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();

                const days = [];
                // Add empty cells for days before the first day of the month
                for (let i = 0; i < startingDay; i++) {
                    days.push(null);
                }
                // Add days of the month
                for (let i = 1; i <= daysInMonth; i++) {
                    days.push(new Date(year, month, i));
                }
                return days;
            };

            const getHolidayForDate = (date) => {
                if (!date) return null;
                return ISRAELI_HOLIDAYS.find(h => {
                    const hDate = h.dateObj;
                    return hDate.getDate() === date.getDate() &&
                           hDate.getMonth() === date.getMonth() &&
                           hDate.getFullYear() === date.getFullYear();
                });
            };

            const formatDateForGoogle = (date) => {
                return date.toISOString().replace(/-|:|\.\d+/g, '').slice(0, 8);
            };

            const addToGoogleCalendar = (holiday, daysBefore = 7) => {
                const reminderDate = new Date(holiday.dateObj);
                reminderDate.setDate(reminderDate.getDate() - daysBefore);

                const endDate = new Date(reminderDate);
                endDate.setDate(endDate.getDate() + 1);

                const title = encodeURIComponent(`🛒 קניות לפני ${holiday.name}`);
                const details = encodeURIComponent(`${holiday.reminder}\n\nתזכורת מאפליקציית ListNest`);
                const startStr = formatDateForGoogle(reminderDate);
                const endStr = formatDateForGoogle(endDate);

                const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startStr}/${endStr}&details=${details}`;
                window.open(url, '_blank');
            };

            const downloadICSFile = (holiday, daysBefore = 7) => {
                const reminderDate = new Date(holiday.dateObj);
                reminderDate.setDate(reminderDate.getDate() - daysBefore);

                const formatICSDate = (d) => d.toISOString().replace(/-|:|\.\d+/g, '').slice(0, 8);

                const endDate = new Date(reminderDate);
                endDate.setDate(endDate.getDate() + 1);

                const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//ListNest//Shopping Reminder//HE
BEGIN:VEVENT
DTSTART;VALUE=DATE:${formatICSDate(reminderDate)}
DTEND;VALUE=DATE:${formatICSDate(endDate)}
SUMMARY:🛒 קניות לפני ${holiday.name}
DESCRIPTION:${holiday.reminder}\\n\\nתזכורת מאפליקציית ListNest
END:VEVENT
END:VCALENDAR`;

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `shopping-reminder-${holiday.name}.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const HEBREW_MONTHS = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
            const HEBREW_DAYS = ['א׳', 'ב׳', 'ג׳', 'ד׳', 'ה׳', 'ו׳', 'ש׳'];

            // Smart category detection with partial matching
            const detectCategory = (productName) => {
                const name = productName.trim().toLowerCase();

                // First try exact match
                for (const [cat, products] of Object.entries(PRODUCTS)) {
                    if (products.some(p => p === productName || p.toLowerCase() === name)) {
                        return cat;
                    }
                }

                // Then try partial match - product name contains or is contained in known product
                for (const [cat, products] of Object.entries(PRODUCTS)) {
                    if (products.some(p => p.includes(productName) || productName.includes(p) ||
                        p.toLowerCase().includes(name) || name.includes(p.toLowerCase()))) {
                        return cat;
                    }
                }

                // Keyword-based detection for common items
                const keywords = {
                    fruits: ['תפוח', 'בננ', 'עגבני', 'מלפפון', 'גזר', 'בצל', 'שום', 'פלפל', 'חס', 'ירק', 'פרי', 'לימון', 'תפוז', 'ענב', 'אבוקדו', 'תות', 'אבטיח', 'מלון', 'תפו"א', 'תפוא', 'בטטה', 'קישוא', 'חציל', 'ברוקולי', 'כרוב', 'סלק', 'פטריות'],
                    meat: ['בשר', 'עוף', 'חזה', 'שניצל', 'כרעיים', 'כנפיים', 'סלמון', 'דג', 'טונה', 'פילה', 'קציצ', 'המבורגר', 'נקניק', 'אנטריקוט', 'צלעות', 'טחון', 'כבד', 'הודו'],
                    dairy: ['חלב', 'גבינ', 'יוגורט', 'ביצ', 'קוטג', 'שמנת', 'חמאה', 'לבן', 'מוצרלה', 'צפתית'],
                    bakery: ['לחם', 'חלה', 'פיתה', 'לחמני', 'בגט', 'עוגי', 'קרואסון', 'מאפה', 'בורקס'],
                    drinks: ['מים', 'קולה', 'פפסי', 'מיץ', 'סודה', 'ספרייט', 'פאנטה', 'משקה'],
                    wine: ['יין', 'בירה', 'וודקה', 'וויסקי', 'ערק', 'שמפניה', 'אלכוהול'],
                    cleaning: ['נייר טואלט', 'אקונומיקה', 'סבון כלים', 'אבקת כביסה', 'מנקה', 'שקיות אשפה', 'ספוג', 'מטלית'],
                    spices: ['מלח', 'פלפל', 'פפריקה', 'כורכום', 'קינמון', 'אורגנו', 'בזיליקום', 'תבלין', 'סוכר', 'קמח'],
                    canned: ['אורז', 'פסטה', 'שימור', 'טונה', 'תירס', 'זית', 'רסק', 'שמן', 'חומוס', 'טחינה', 'ריבה', 'דבש'],
                    snacks: ['במבה', 'ביסלי', 'שוקולד', 'חטיף', 'עוגיות', 'ממתק', 'צ\'יפס', 'פופקורן'],
                    frozen: ['גלידה', 'קפוא', 'שלגון', 'ארטיק', 'בצק'],
                    hygiene: ['שמפו', 'סבון', 'משחת שיניים', 'דאודורנט', 'מברשת', 'מגבון', 'קרם'],
                    coffee: ['קפה', 'תה', 'נס', 'קפסול'],
                    baby: ['חיתול', 'תינוק', 'פמפרס'],
                    pets: ['כלב', 'חתול', 'מזון לחיות']
                };

                for (const [cat, words] of Object.entries(keywords)) {
                    if (words.some(word => name.includes(word) || productName.includes(word))) {
                        return cat;
                    }
                }

                return 'canned'; // Default fallback to general groceries
            };

            // Check if product is a cheese that should be in grams
            const isCheeseInGrams = (productName) => {
                const cheeseKeywords = [
                    'גבינה צהובה', 'צהובה', 'שמנת', 'בולגרית', 'פרמזן', 'צפתית',
                    'קשקבל', 'רוקפור', 'גאודה', 'ברי', 'אמנטל', 'חלומי', 'גבינת שמנת',
                    'מוצרלה', 'קממבר', 'עמק', 'גלבוע', 'פילדלפיה', 'לאבנה', 'ריקוטה',
                    'מסקרפונה', 'גבינת עזים', 'גבינה לבנה'
                ];
                const nameLower = productName.toLowerCase();
                return cheeseKeywords.some(cheese => nameLower.includes(cheese));
            };

            // Open quantity selector before adding product
            const addProduct = (product) => {
                const category = selectedCategory || detectCategory(product);
                let unit = CATEGORIES[category]?.unit || 'יח\'';
                const unitOptions = CATEGORIES[category]?.unitOptions || ['יח\''];

                // Override unit for cheese products to grams
                if (category === 'dairy' && isCheeseInGrams(product)) {
                    unit = 'גרם';
                }

                setSelectedProduct({ name: product, category, unitOptions });
                setSelectedQuantity(1); // Always start at 1, user can adjust
                setSelectedUnit(unit);
                setShowQuantitySelector(true);
            };

            // Actually add product with selected quantity
            const addProductWithQuantity = async () => {
                if (!selectedProduct) return;

                try {
                    const { name: product, category } = selectedProduct;
                    const existing = items.find(item => item.name === product && !item.purchased);

                    if (existing) {
                        // Add to existing quantity
                        let newQty;
                        if (typeof existing.quantity === 'string') {
                            const numMatch = existing.quantity.match(/^([\d.]+)/);
                            if (numMatch) {
                                const num = parseFloat(numMatch[1]) + selectedQuantity;
                                newQty = `${num} ${selectedUnit}`;
                            } else {
                                newQty = `${selectedQuantity + 1} ${selectedUnit}`;
                            }
                        } else {
                            newQty = `${(existing.quantity || 0) + selectedQuantity} ${selectedUnit}`;
                        }

                        const updateData = {
                                quantity: newQty,
                                unit: selectedUnit,
                                updatedAt: new Date(),
                                updatedBy: user.displayName || user.email
                            };
                        if (selectedNote) {
                            updateData.note = existing.note ? `${existing.note}, ${selectedNote}` : selectedNote;
                        }
                        await window.firestore.updateDoc(
                            window.firestore.doc(window.db, 'shopping-items', existing.id),
                            updateData
                        );
                        await logActivity('quantity_changed', { itemName: product });
                    } else {
                        await window.firestore.addDoc(window.firestore.collection(window.db, 'shopping-items'), {
                            name: product,
                            category: category,
                            quantity: `${selectedQuantity} ${selectedUnit}`,
                            unit: selectedUnit,
                            purchased: false,
                            familyId: family.id,
                            listId: currentList.id,
                            addedBy: user.displayName || user.email,
                            addedByUid: user.uid,
                            note: selectedNote || '',
                            createdAt: new Date()
                        });
                        await logActivity('item_added', { itemName: product });
                    }

                    setSearchTerm('');
                    setShowQuantitySelector(false);
                    setSelectedNote('');
                    setSelectedProduct(null);
                } catch (error) {
                    console.error('שגיאה בהוספת מוצר:', error);
                    alert('שגיאה בהוספת המוצר. נסה שוב.');
                }
            };

            const togglePurchased = async (id, currentStatus) => {
                try {
                    const item = items.find(i => i.id === id);

                    // Conflict detection: Check if item was already marked by someone else
                    const docRef = window.firestore.doc(window.db, 'shopping-items', id);
                    const freshDoc = await window.firestore.getDoc(docRef);

                    if (freshDoc.exists()) {
                        const freshData = freshDoc.data();

                        // If someone else already marked it as purchased
                        if (!currentStatus && freshData.purchased && freshData.purchasedBy !== (user.displayName || user.email)) {
                            // Auto-unified: item already purchased by someone else
                            console.log(`Smart conflict resolved: ${item?.name} already marked by ${freshData.purchasedBy}`);
                            return; // No need to update, already done
                        }
                    }

                    await window.firestore.updateDoc(docRef, {
                        purchased: !currentStatus,
                        purchasedBy: !currentStatus ? (user.displayName || user.email) : null,
                        purchasedByUid: !currentStatus ? user.uid : null,
                        purchasedAt: !currentStatus ? new Date() : null
                    });

                    if (!currentStatus && item) {
                        await logActivity('item_purchased', { itemName: item.name });
                    }
                } catch (error) {
                    console.error('שגיאה בעדכון מוצר:', error);
                }
            };

            const updateQuantity = async (id, newQuantity) => {
                try {
                    if (newQuantity < 1) {
                        setShowDeleteConfirm(id);
                    } else {
                        const item = items.find(i => i.id === id);
                        await window.firestore.updateDoc(window.firestore.doc(window.db, 'shopping-items', id), {
                            quantity: newQuantity,
                            updatedAt: new Date(),
                            updatedBy: user.displayName || user.email
                        });
                        if (item) {
                            await logActivity('quantity_changed', { itemName: item.name });
                        }
                    }
                } catch (error) {
                    console.error('שגיאה בעדכון כמות:', error);
                }
            };

            // Inline edit item name
            const startEditingItem = (item) => {
                setEditingItemId(item.id);
                setEditingItemName(item.name);
            };

            const saveItemName = async () => {
                if (!editingItemId || !editingItemName.trim()) {
                    setEditingItemId(null);
                    return;
                }
                try {
                    await window.firestore.updateDoc(window.firestore.doc(window.db, 'shopping-items', editingItemId), {
                        name: editingItemName.trim(),
                        updatedAt: new Date(),
                        updatedBy: user.displayName || user.email
                    });
                } catch (error) {
                    console.error('שגיאה בעדכון שם:', error);
                }
                setEditingItemId(null);
            };

            const deleteItem = async (id) => {
                try {
                    const item = items.find(i => i.id === id);
                    await window.firestore.deleteDoc(window.firestore.doc(window.db, 'shopping-items', id));
                    setShowDeleteConfirm(null);
                    if (item) {
                        await logActivity('item_deleted', { itemName: item.name });
                        // Track as forgotten if wasn't purchased
                        if (!item.purchased) {
                            await trackForgottenItem(item.name);
                        }
                    }
                } catch (error) {
                    console.error('שגיאה במחיקת מוצר:', error);
                }
            };

            // Delete all items from the shopping list
            const deleteAllItems = async () => {
                try {
                    const itemCount = items.length;
                    // Delete all items using Promise.all for parallel deletion
                    await Promise.all(
                        items.map(item =>
                            window.firestore.deleteDoc(window.firestore.doc(window.db, 'shopping-items', item.id))
                        )
                    );
                    await logActivity('all_items_deleted', { itemCount });
                    setShowDeleteAllConfirm(false);
                } catch (error) {
                    console.error('Error deleting all items:', error);
                    setShowDeleteAllConfirm(false);
                }
            };

            // Postpone item - moves it to the end of the list
            const postponeItem = async (id) => {
                try {
                    const item = items.find(i => i.id === id);
                    await window.firestore.updateDoc(window.firestore.doc(window.db, 'shopping-items', id), {
                        postponedAt: new Date(),
                        postponedBy: user.displayName || user.email
                    });
                    if (item) {
                        await logActivity('item_postponed', { itemName: item.name });
                        // Track as forgotten
                        if (!item.purchased) {
                            await trackForgottenItem(item.name);
                        }
                    }
                } catch (error) {
                    console.error('שגיאה בדחיית מוצר:', error);
                }
            };

            // Track forgotten items
            const trackForgottenItem = async (itemName) => {
                try {
                    const monthKey = new Date().toISOString().slice(0, 7); // YYYY-MM
                    const docRef = window.firestore.doc(window.db, 'forgotten-stats', `${family.id}_${monthKey}`);
                    const docSnap = await window.firestore.getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const items = data.items || {};
                        items[itemName] = (items[itemName] || 0) + 1;
                        await window.firestore.updateDoc(docRef, { items, updatedAt: new Date() });
                    } else {
                        await window.firestore.setDoc(docRef, {
                            familyId: family.id,
                            month: monthKey,
                            items: { [itemName]: 1 },
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                    }
                } catch (error) {
                    console.error('Error tracking forgotten item:', error);
                }
            };

            const updateItemNote = async (itemId, note) => {
                try {
                    const item = items.find(i => i.id === itemId);
                    await window.firestore.updateDoc(window.firestore.doc(window.db, 'shopping-items', itemId), {
                        note: note,
                        updatedAt: new Date(),
                        updatedBy: user.displayName || user.email
                    });
                    if (item && note) {
                        await logActivity('note_added', { itemName: item.name });
                    }
                } catch (error) {
                    console.error('שגיאה בעדכון הערה:', error);
                }
            };

            const finishShopping = async () => {
                if (!totalAmount || parseFloat(totalAmount) <= 0) {
                    alert('נא להזין סכום תקין');
                    return;
                }

                const purchasedItems = items.filter(item => item.purchased);
                const unpurchasedItems = items.filter(item => !item.purchased);

                if (purchasedItems.length === 0) {
                    alert('לא נבחרו מוצרים שנקנו');
                    return;
                }

                try {
                    // Track forgotten items (unpurchased items left behind)
                    const hadForgottenItems = unpurchasedItems.length > 0;
                    for (const item of unpurchasedItems) {
                        await trackForgottenItem(item.name);
                    }

                    await window.firestore.addDoc(window.firestore.collection(window.db, 'shopping-history'), {
                        items: purchasedItems,
                        totalAmount: parseFloat(totalAmount),
                        completedAt: new Date(),
                        completedBy: user.displayName || user.email,
                        completedByUid: user.uid,
                        familyId: family.id,
                        listId: currentList.id,
                        forgottenCount: unpurchasedItems.length,
                        receiptPhoto: receiptPhoto || null
                    });

                    for (const item of purchasedItems) {
                        await window.firestore.deleteDoc(window.firestore.doc(window.db, 'shopping-items', item.id));
                    }

                    // Update shopping streak
                    await updateShoppingStreak(hadForgottenItems);

                    setShowFinishShopping(false);
                    setTotalAmount('');
                    setReceiptPhoto(null);
                    loadHistory();

                    // Show achievement celebration if perfect shopping
                    if (!hadForgottenItems) {
                        setTimeout(() => {
                            alert('🎉 קנייה מושלמת! לא שכחת כלום!');
                        }, 500);
                    }
                } catch (error) {
                    console.error('שגיאה בסיום קנייה:', error);
                    alert('שגיאה בשמירת הקנייה. נסה שוב.');
                }
            };

            const exportToWhatsApp = async () => {
                const unpurchased = items.filter(item => !item.purchased);
                let text = '🛒 רשימת קניות:\n\n';
                Object.entries(CATEGORIES).forEach(([key, cat]) => {
                    const categoryItems = unpurchased.filter(item => item.category === key);
                    if (categoryItems.length > 0) {
                        text += `${cat.icon} ${getCategoryName(key)}:\n`;
                        categoryItems.forEach(item => {
                            text += `  ✓ ${item.name} (${item.quantity})\n`;
                        });
                        text += '\n';
                    }
                });

                // Use native share API if available (better for PWA)
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'רשימת קניות',
                            text: text
                        });
                    } catch (err) {
                        // User cancelled or error - fallback to clipboard
                        if (err.name !== 'AbortError') {
                            await navigator.clipboard.writeText(text);
                            alert('הרשימה הועתקה ללוח!');
                        }
                    }
                } else {
                    // Fallback: copy to clipboard
                    try {
                        await navigator.clipboard.writeText(text);
                        alert('הרשימה הועתקה ללוח! הדבק בווטסאפ או בכל אפליקציה אחרת.');
                    } catch (err) {
                        // Last fallback: open WhatsApp
                        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                    }
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-6xl mb-4 float">🛒</div>
                            <div className="text-xl text-white font-medium">טוען...</div>
                            <div className="mt-4 w-32 h-1 bg-white/20 rounded-full overflow-hidden mx-auto">
                                <div className="h-full w-1/2 progress-animate rounded-full"></div>
                            </div>
                        </div>
                    </div>
                );
            }

            const filteredItems = items;
            const groupedItems = filteredItems.reduce((acc, item) => {
                if (!acc[item.category]) acc[item.category] = [];
                acc[item.category].push(item);
                return acc;
            }, {});

            const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
            const purchasedCount = items.filter(item => item.purchased).reduce((sum, item) => sum + item.quantity, 0);

            // WCAG 4.1.3 - Announce status messages to screen readers
            const announceToScreenReader = (message, priority = 'polite') => {
                const region = document.getElementById(priority === 'assertive' ? 'aria-live-assertive' : 'aria-live-region');
                if (region) {
                    region.textContent = '';
                    setTimeout(() => { region.textContent = message; }, 100);
                }
            };

            return (
                <div className="min-h-screen gradient-bg p-4 pb-20" role="application" aria-label="ListNest - רשימת קניות">
                    {/* Main content landmark for skip link */}
                    <main id="main-content" role="main" aria-label="תוכן ראשי">

                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass rounded-3xl p-8 max-w-sm w-full shadow-2xl">
                                <div className="text-5xl text-center mb-4">🗑️</div>
                                <h2 className="text-xl font-bold text-center text-gradient mb-2">מחיקת מוצר</h2>
                                <p className="text-gray-600 dark:text-gray-300 mb-6 text-center">האם אתה בטוח שברצונך למחוק מוצר זה?</p>
                                <div className="flex gap-3">
                                    <button onClick={() => deleteItem(showDeleteConfirm)}
                                        className="flex-1 bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-3 rounded-xl hover:shadow-lg hover:scale-105 font-semibold transition-all">
                                        מחק
                                    </button>
                                    <button onClick={() => setShowDeleteConfirm(null)}
                                        className="flex-1 px-6 py-3 glass border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 hover:scale-105 transition-all">
                                        ביטול
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showDeleteAllConfirm && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass rounded-3xl p-8 max-w-sm w-full shadow-2xl">
                                <div className="text-5xl text-center mb-4">⚠️</div>
                                <h2 className="text-xl font-bold text-center text-gradient mb-2">{t('deleteAllTitle')}</h2>
                                <p className="text-gray-600 dark:text-gray-300 mb-2 text-center">{t('deleteAllConfirm')}</p>
                                <p className="text-red-500 dark:text-red-400 mb-6 text-center text-sm font-semibold">{t('deleteAllWarning').replace('{count}', items.length)}</p>
                                <div className="flex gap-3">
                                    <button onClick={deleteAllItems}
                                        className="flex-1 bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-3 rounded-xl hover:shadow-lg hover:scale-105 font-semibold transition-all">
                                        {t('deleteAll')}
                                    </button>
                                    <button onClick={() => setShowDeleteAllConfirm(false)}
                                        className="flex-1 px-6 py-3 glass border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 hover:scale-105 transition-all">
                                        {t('cancel')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Import from WhatsApp Modal */}
                    {showImportWhatsApp && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass rounded-3xl p-6 max-w-md w-full shadow-2xl">
                                <div className="text-4xl text-center mb-3">📱</div>
                                <h2 className="text-xl font-bold text-center text-gradient mb-2">{t('importFromWhatsapp')}</h2>
                                <p className="text-gray-500 dark:text-gray-400 text-sm text-center mb-4">{t('whatsapp')}</p>
                                <textarea
                                    value={whatsAppText}
                                    onChange={e => setWhatsAppText(e.target.value)}
                                    placeholder={t('importExample')}
                                    className="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-800 dark:text-white min-h-[150px] mb-4 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all text-sm"
                                    dir="rtl"
                                />
                                <div className="text-xs text-gray-400 dark:text-gray-500 mb-4">
                                    נתמך: שורות נפרדות, פסיקים, מספרים (2 חלב או חלב x2)
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={importFromWhatsApp}
                                        className="flex-1 btn-gradient text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all"
                                    >
                                        יבא לרשימה
                                    </button>
                                    <button
                                        onClick={() => { setShowImportWhatsApp(false); setWhatsAppText(''); }}
                                        className="px-6 py-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-all"
                                    >
                                        ביטול
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Saved Lists Modal */}
                    {showSavedLists && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass rounded-3xl p-6 max-w-md w-full shadow-2xl max-h-[80vh] overflow-y-auto">
                                <div className="text-4xl text-center mb-3">📋</div>
                                <h2 className="text-xl font-bold text-center text-gradient mb-4">רשימות שמורות</h2>
                                {savedLists.length === 0 ? (
                                    <div className="text-center py-8">
                                        <div className="text-5xl mb-3">📝</div>
                                        <p className="text-gray-500 dark:text-gray-400">אין רשימות שמורות</p>
                                        <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">לחץ על "שמור רשימה" לשמירת הרשימה הנוכחית</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3 mb-4">
                                        {savedLists.map(list => (
                                            <div
                                                key={list.id}
                                                className="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700"
                                            >
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="font-semibold text-gray-800 dark:text-white">{list.name}</span>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xs text-gray-400">{list.items.length} פריטים</span>
                                                        <button
                                                            onClick={() => deleteSavedList(list.id)}
                                                            className="w-7 h-7 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center hover:bg-red-200 dark:hover:bg-red-900/50 transition-all text-sm"
                                                            title="מחק רשימה"
                                                        >
                                                            🗑️
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="text-xs text-gray-500 dark:text-gray-400 mb-3 truncate">
                                                    {list.items.slice(0, 5).map(i => i.name).join(', ')}
                                                    {list.items.length > 5 && '...'}
                                                </div>
                                                <button
                                                    onClick={() => loadSavedList(list)}
                                                    className="w-full py-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-lg font-medium hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-all text-sm"
                                                >
                                                    טען לעגלה
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <button
                                    onClick={() => setShowSavedLists(false)}
                                    className="w-full py-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-all"
                                >
                                    סגור
                                </button>
                            </div>
                        </div>
                    )}

                    {/* AI Assistant Modal */}
                    {showAIAssistant && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass rounded-3xl p-6 max-w-lg w-full shadow-2xl max-h-[85vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold flex items-center gap-3 text-gradient">
                                        <span className="text-3xl">🤖</span>
                                        עוזר קניות חכם
                                    </h2>
                                    <button onClick={() => setShowAIAssistant(false)} className="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition-all">✕</button>
                                </div>

                                {aiThinking ? (
                                    <div className="text-center py-12">
                                        <div className="text-6xl mb-4 animate-bounce">🤔</div>
                                        <p className="text-lg text-gray-600 dark:text-gray-300 font-medium">AI חושב...</p>
                                        <p className="text-sm text-gray-400 dark:text-gray-500 mt-2">מנתח את הרשימה ומכין הצעות</p>
                                        <div className="mt-4 flex justify-center gap-1">
                                            <div className="w-2 h-2 bg-violet-500 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                                            <div className="w-2 h-2 bg-violet-500 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                                            <div className="w-2 h-2 bg-violet-500 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                                        </div>
                                    </div>
                                ) : aiSuggestions.length === 0 ? (
                                    <div className="text-center py-12">
                                        <div className="text-6xl mb-4">🎉</div>
                                        <p className="text-lg text-gray-600 dark:text-gray-300 font-medium">הרשימה שלך נראית מושלמת!</p>
                                        <p className="text-sm text-gray-400 dark:text-gray-500 mt-2">אין לי הצעות נוספות כרגע</p>
                                        <button
                                            onClick={generateAISuggestions}
                                            className="mt-6 px-6 py-3 bg-violet-100 dark:bg-violet-900/50 text-violet-700 dark:text-violet-300 rounded-xl font-medium hover:bg-violet-200 transition-all"
                                        >
                                            🔄 נסה שוב
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                                            בהתבסס על הרשימה שלך, הנה כמה הצעות:
                                        </p>
                                        {aiSuggestions.map((suggestion, idx) => (
                                            <div
                                                key={idx}
                                                className={`p-4 rounded-xl border-2 transition-all ${
                                                    suggestion.isRecipe
                                                        ? 'bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border-amber-300 dark:border-amber-700'
                                                        : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-violet-400 dark:hover:border-violet-500'
                                                }`}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-2xl">{suggestion.icon}</span>
                                                        <div>
                                                            <p className="font-bold text-gray-800 dark:text-white">{suggestion.name}</p>
                                                            <p className="text-xs text-gray-500 dark:text-gray-400">{suggestion.reason}</p>
                                                        </div>
                                                    </div>
                                                    {!suggestion.isRecipe && (
                                                        <button
                                                            onClick={() => addAISuggestion(suggestion)}
                                                            className="px-4 py-2 bg-violet-500 text-white rounded-xl text-sm font-medium hover:bg-violet-600 transition-all"
                                                        >
                                                            ➕ הוסף
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}

                                        <div className="flex gap-3 mt-6">
                                            <button
                                                onClick={generateAISuggestions}
                                                className="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-all"
                                            >
                                                🔄 הצעות חדשות
                                            </button>
                                            <button
                                                onClick={() => setShowAIAssistant(false)}
                                                className="flex-1 py-3 btn-gradient text-white rounded-xl font-medium"
                                            >
                                                ✓ סיימתי
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Price Comparison Scanner Modal */}
                    {showPriceScanner && (
                        <div className="fixed inset-0 bg-black/95 flex flex-col z-50">
                            {/* Header */}
                            <div className="p-4 flex items-center justify-between">
                                <button onClick={stopPriceScanner} className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white text-xl hover:bg-white/20 transition-all">✕</button>
                                <h2 className="text-white font-bold text-lg">🔍 {t('priceComparison')}</h2>
                                <div className="w-10"></div>
                            </div>

                            <div className="flex-1 p-4 overflow-y-auto">
                                {/* Search Input - Primary */}
                                <div className="mb-4">
                                    <label className="text-white text-sm mb-2 block">{t('searchProduct')}</label>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={scannedProductName}
                                            onChange={e => { setScannedProductName(e.target.value); setPriceCompareResults(null); }}
                                            placeholder={t('productSearchExample')}
                                            className="flex-1 px-4 py-3 rounded-xl bg-white text-gray-800 border-2 border-transparent focus:border-cyan-400 transition-all text-lg"
                                            autoFocus
                                        />
                                        <button
                                            onClick={() => searchPriceComparison(scannedProductName)}
                                            disabled={!scannedProductName}
                                            className="px-5 py-3 bg-cyan-500 text-white rounded-xl font-bold disabled:opacity-50 hover:bg-cyan-600 transition-all"
                                        >
                                            🔍
                                        </button>
                                    </div>
                                </div>

                                {/* Autocomplete Suggestions */}
                                {scannedProductName && !priceCompareResults && getPriceSearchSuggestions(scannedProductName).length > 0 && (
                                    <div className="mb-4 bg-white/10 rounded-xl p-2">
                                        <div className="text-gray-400 text-xs mb-2 px-2">הצעות:</div>
                                        <div className="flex flex-wrap gap-2">
                                            {getPriceSearchSuggestions(scannedProductName).map((suggestion, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => { setScannedProductName(suggestion); searchPriceComparison(suggestion); }}
                                                    className="px-3 py-2 bg-white/20 text-white rounded-lg text-sm hover:bg-cyan-500 transition-all"
                                                >
                                                    {suggestion}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Quick Popular Products */}
                                {!scannedProductName && !priceCompareResults && (
                                    <div className="mb-4">
                                        <div className="text-gray-400 text-sm mb-2">מוצרים פופולריים:</div>
                                        <div className="flex flex-wrap gap-2">
                                            {['חלב', 'ביצים', 'לחם', 'גבינה צהובה', 'שוקולד', 'קולה', 'במבה', 'שמן זית'].map((product, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => { setScannedProductName(product); searchPriceComparison(product); }}
                                                    className="px-3 py-2 bg-white/10 text-white rounded-lg text-sm hover:bg-white/20 transition-all"
                                                >
                                                    {product}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Camera Scan - Secondary Option */}
                                {!priceCompareResults && (
                                    <div className="mb-4 p-4 bg-white/10 rounded-xl border border-white/20">
                                        <div className="text-white text-sm mb-3 text-center font-medium">או צלם את שם המוצר:</div>
                                        <div className="relative aspect-video bg-black rounded-xl overflow-hidden mb-4">
                                            <video ref={priceVideoRef} autoPlay playsInline className="w-full h-full object-cover" />
                                            <canvas ref={priceCanvasRef} className="hidden" />
                                            {scanningPrice && (
                                                <div className="absolute inset-0 bg-black/70 flex items-center justify-center">
                                                    <div className="text-center">
                                                        <div className="text-3xl mb-2 animate-spin">⏳</div>
                                                        <div className="text-white text-sm">מנתח תמונה...</div>
                                                    </div>
                                                </div>
                                            )}
                                            {/* Big Capture Button Overlay */}
                                            {!scanningPrice && (
                                                <button
                                                    onClick={captureAndScanPrice}
                                                    className="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-16 h-16 rounded-full bg-white border-4 border-cyan-400 shadow-lg flex items-center justify-center hover:scale-110 transition-all"
                                                >
                                                    <div className="w-12 h-12 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center">
                                                        <span className="text-2xl">📸</span>
                                                    </div>
                                                </button>
                                            )}
                                        </div>
                                        <button
                                            onClick={captureAndScanPrice}
                                            disabled={scanningPrice}
                                            className="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-xl font-bold text-lg shadow-lg disabled:opacity-50 hover:shadow-xl hover:scale-[1.02] transition-all"
                                        >
                                            {scanningPrice ? '⏳ מנתח...' : '📸 לחץ לצילום וזיהוי'}
                                        </button>
                                        <p className="text-gray-400 text-xs text-center mt-2">* כוון את המצלמה לשם המוצר ולחץ על הכפתור</p>
                                    </div>
                                )}

                                {/* Supermarket Links - Results */}
                                {priceCompareResults && (
                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between mb-2">
                                            <h3 className="text-white font-bold">תוצאות עבור: {scannedProductName}</h3>
                                            <button
                                                onClick={() => { setPriceCompareResults(null); }}
                                                className="text-cyan-400 text-sm hover:underline"
                                            >
                                                חיפוש חדש
                                            </button>
                                        </div>
                                        {priceCompareResults.map((site, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => openPriceLink(site.url)}
                                                className={`w-full p-4 ${site.color} text-white rounded-xl font-bold text-lg flex items-center justify-between hover:opacity-90 hover:scale-[1.02] transition-all`}
                                            >
                                                <span>{site.name}</span>
                                                <span>🔗</span>
                                            </button>
                                        ))}
                                        <button
                                            onClick={() => {
                                                priceCompareResults.forEach(site => window.open(site.url, '_blank'));
                                            }}
                                            className="w-full p-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-bold text-lg mt-2 hover:opacity-90 transition-all"
                                        >
                                            🚀 פתח הכל בו-זמנית
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {showFinishShopping && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass rounded-3xl p-8 max-w-md w-full shadow-2xl max-h-[90vh] overflow-y-auto">
                                <div className="text-5xl text-center mb-4">✅</div>
                                <h2 className="text-2xl font-bold text-center text-gradient mb-2">{t('finishShopping')}</h2>
                                <p className="text-gray-600 dark:text-gray-300 mb-6 text-center">{purchasedCount} {t('itemsPurchased')}</p>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('totalAmount')}</label>
                                <input
                                    type="number"
                                    value={totalAmount}
                                    onChange={e => setTotalAmount(e.target.value)}
                                    placeholder="0"
                                    className="w-full px-5 py-4 border-2 border-indigo-200 dark:border-indigo-600 rounded-xl bg-white/50 dark:bg-gray-700/50 dark:text-white text-xl mb-4 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all"
                                    autoFocus
                                />

                                {/* Receipt Photo Section */}
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{t('uploadReceipt')}</label>
                                    <input
                                        type="file"
                                        accept="image/*"
                                        capture="environment"
                                        ref={receiptInputRef}
                                        onChange={handleReceiptCapture}
                                        className="hidden"
                                    />
                                    {!receiptPhoto ? (
                                        <button
                                            onClick={() => receiptInputRef.current?.click()}
                                            disabled={uploadingReceipt}
                                            className="w-full p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl hover:border-indigo-400 dark:hover:border-indigo-500 transition-colors flex flex-col items-center gap-2 text-gray-500 dark:text-gray-400 hover:text-indigo-500"
                                        >
                                            {uploadingReceipt ? (
                                                <>
                                                    <div className="animate-spin text-2xl">⏳</div>
                                                    <span className="text-sm">מעלה...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <span className="text-3xl">🧾</span>
                                                    <span className="text-sm">לחץ לצילום קבלה</span>
                                                </>
                                            )}
                                        </button>
                                    ) : (
                                        <div className="relative">
                                            <img
                                                src={receiptPhoto}
                                                alt="קבלה"
                                                className="w-full h-32 object-cover rounded-xl border-2 border-green-300"
                                            />
                                            <button
                                                onClick={() => setReceiptPhoto(null)}
                                                className="absolute top-2 left-2 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors shadow-lg"
                                            >
                                                ✕
                                            </button>
                                            <div className="absolute bottom-2 right-2 bg-green-500 text-white px-2 py-1 rounded-lg text-xs flex items-center gap-1">
                                                <span>✓</span> קבלה צורפה
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={finishShopping}
                                        disabled={uploadingReceipt}
                                        className="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-3 rounded-xl hover:shadow-lg hover:scale-105 font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                        ✓ סיים ושמור
                                    </button>
                                    <button onClick={() => { setShowFinishShopping(false); setTotalAmount(''); setReceiptPhoto(null); }}
                                        className="px-6 py-3 glass border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 hover:scale-105 transition-all">
                                        ביטול
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showHistory && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-y-auto">
                            <div className="glass rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl scrollbar-thin">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold flex items-center gap-3">
                                        <span className="text-3xl">📊</span>
                                        <span className="text-gradient">היסטוריית קניות</span>
                                    </h2>
                                    <button onClick={() => setShowHistory(false)}
                                        className="w-10 h-10 flex items-center justify-center glass rounded-full text-gray-500 hover:text-red-500 dark:hover:text-red-400 text-2xl hover:scale-110 hover:rotate-90 transition-all">×</button>
                                </div>
                                {history.length === 0 ? (
                                    <div className="text-center py-12">
                                        <div className="text-7xl mb-4 float">📭</div>
                                        <p className="text-xl text-gradient font-bold mb-2">{t('noHistoryYet')}</p>
                                        <p className="text-gray-500 dark:text-gray-400">{t('completeFirstShopping')}</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {history.map((record) => (
                                            <div key={record.id} className="glass rounded-xl p-5 card-hover border border-gray-200/50 dark:border-gray-600/50">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <div className="text-sm text-gray-600 dark:text-gray-400 font-semibold flex items-center gap-2">
                                                            <span className="text-lg">📅</span>
                                                            {record.completedAt?.toDate?.()?.toLocaleDateString('he-IL', {
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric',
                                                                weekday: 'long'
                                                            }) || 'תאריך לא ידוע'}
                                                        </div>
                                                        <div className="text-xs text-gray-500 dark:text-gray-500 mt-1">👤 {record.completedBy}</div>
                                                    </div>
                                                    <div className="text-2xl font-bold bg-gradient-to-r from-green-500 to-emerald-500 bg-clip-text text-transparent">
                                                        ₪{record.totalAmount.toFixed(2)}
                                                    </div>
                                                </div>
                                                <div className="text-sm text-gray-700 dark:text-gray-300 bg-indigo-50/50 dark:bg-indigo-900/20 rounded-lg p-3">
                                                    🛒 {record.items.length} פריטים • ממוצע: ₪{(record.totalAmount / record.items.length).toFixed(2)} לפריט
                                                </div>
                                                {record.receiptPhoto && (
                                                    <div className="mt-3">
                                                        <button
                                                            onClick={() => window.open(record.receiptPhoto, '_blank')}
                                                            className="flex items-center gap-2 text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 transition-colors"
                                                        >
                                                            <span>🧾</span>
                                                            <span>צפה בקבלה</span>
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        <div className="glass rounded-xl p-5 border-2 border-indigo-200/50 dark:border-indigo-700/50">
                                            <h3 className="font-bold text-gradient mb-4 flex items-center gap-2">
                                                <span className="text-xl">📈</span>
                                                סטטיסטיקה כללית
                                            </h3>
                                            <div className="space-y-3">
                                                <div className="flex justify-between text-gray-700 dark:text-gray-300 bg-gray-50/50 dark:bg-gray-800/50 p-3 rounded-lg">
                                                    <span>סה"כ קניות:</span>
                                                    <span className="font-bold text-lg">{history.length}</span>
                                                </div>
                                                <div className="flex justify-between text-gray-700 dark:text-gray-300 bg-green-50/50 dark:bg-green-900/20 p-3 rounded-lg">
                                                    <span>סה"כ הוצאות:</span>
                                                    <span className="font-bold text-lg text-green-600 dark:text-green-400">
                                                        ₪{history.reduce((sum, h) => sum + h.totalAmount, 0).toFixed(2)}
                                                    </span>
                                                </div>
                                                <div className="flex justify-between text-gray-700 dark:text-gray-300 bg-blue-50/50 dark:bg-blue-900/20 p-3 rounded-lg">
                                                    <span>ממוצע לקנייה:</span>
                                                    <span className="font-bold text-lg text-blue-600 dark:text-blue-400">
                                                        ₪{(history.reduce((sum, h) => sum + h.totalAmount, 0) / history.length).toFixed(2)}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Forgotten Stats Modal */}
                    {showForgottenStats && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-y-auto">
                            <div className="glass rounded-3xl p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl scrollbar-thin">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold flex items-center gap-3">
                                        <span className="text-3xl">🧠</span>
                                        <span className="text-gradient">{t('whatForgot')}</span>
                                    </h2>
                                    <button onClick={() => setShowForgottenStats(false)}
                                        className="w-10 h-10 flex items-center justify-center glass rounded-full text-gray-500 hover:text-red-500 dark:hover:text-red-400 text-2xl hover:scale-110 hover:rotate-90 transition-all">×</button>
                                </div>

                                {/* Shopping Streak */}
                                <div className="bg-gradient-to-r from-orange-100 to-amber-100 dark:from-orange-900/30 dark:to-amber-900/30 rounded-2xl p-4 mb-6 border border-orange-200 dark:border-orange-800">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="text-lg font-bold text-orange-800 dark:text-orange-200">🔥 {t('shoppingStreak')}</div>
                                            <div className="text-sm text-orange-600 dark:text-orange-400">קניות בלי לשכוח דברים</div>
                                        </div>
                                        <div className="text-4xl font-bold text-orange-600 dark:text-orange-400">
                                            {shoppingStreak}
                                        </div>
                                    </div>
                                    {shoppingStreak >= 3 && (
                                        <div className="mt-2 text-sm text-orange-700 dark:text-orange-300 animate-pulse">
                                            ⭐ מדהים! {shoppingStreak} קניות ברצף!
                                        </div>
                                    )}
                                </div>

                                {/* Achievements */}
                                {achievements.length > 0 && (
                                    <div className="mb-6">
                                        <h3 className="font-bold text-gray-800 dark:text-gray-200 mb-3 flex items-center gap-2">
                                            <span>🏆</span> הישגים החודש
                                        </h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            {achievements.map((achievement, idx) => (
                                                <div key={idx} className="bg-gradient-to-br from-yellow-50 to-amber-100 dark:from-yellow-900/20 dark:to-amber-900/20 rounded-xl p-3 border border-yellow-200 dark:border-yellow-800 hover:scale-105 transition-transform">
                                                    <div className="text-2xl mb-1">{achievement.emoji}</div>
                                                    <div className="text-sm font-bold text-amber-800 dark:text-amber-200">{achievement.name}</div>
                                                    <div className="text-xs text-amber-600 dark:text-amber-400">{achievement.description}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Monthly Stats */}
                                <div className="mb-4">
                                    <h3 className="font-bold text-gray-800 dark:text-gray-200 mb-3 flex items-center gap-2">
                                        <span>📅</span> סטטיסטיקה חודשית - {new Date().toLocaleDateString('he-IL', { month: 'long', year: 'numeric' })}
                                    </h3>

                                    {Object.keys(forgottenStats).length === 0 ? (
                                        <div className="text-center py-8 bg-green-50 dark:bg-green-900/20 rounded-2xl">
                                            <div className="text-5xl mb-3">🎉</div>
                                            <p className="text-lg font-bold text-green-700 dark:text-green-300">מושלם!</p>
                                            <p className="text-sm text-green-600 dark:text-green-400">לא שכחת כלום החודש</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {Object.entries(forgottenStats)
                                                .sort(([,a], [,b]) => b - a)
                                                .map(([item, count]) => {
                                                    const msg = getForgottenMessage(count);
                                                    return (
                                                        <div key={item} className="flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 rounded-xl p-3 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors">
                                                            <div className="flex items-center gap-3">
                                                                <span className="text-2xl">{msg.emoji}</span>
                                                                <span className="font-medium text-gray-800 dark:text-gray-200">{item}</span>
                                                            </div>
                                                            <div className="text-left">
                                                                <div className="font-bold text-gray-700 dark:text-gray-300">{count} פעמים</div>
                                                                <div className="text-xs text-gray-500">{msg.text}</div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    )}
                                </div>

                                {/* Tips Section */}
                                {Object.keys(forgottenStats).length > 0 && (
                                    <div className="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800">
                                        <div className="flex items-start gap-2">
                                            <span className="text-xl">💡</span>
                                            <div>
                                                <div className="font-bold text-blue-800 dark:text-blue-200 text-sm">טיפ!</div>
                                                <div className="text-xs text-blue-600 dark:text-blue-400">
                                                    הוסף את הפריטים שנשכחים לעתים קרובות לרשימה קבועה, או הגדר תזכורת בטלפון
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {showFamilySettings && <FamilySettingsModal onClose={() => setShowFamilySettings(false)} />}
                    {showCreateList && <CreateListModal onClose={() => setShowCreateList(false)} />}
                    {editingNote && <ItemNoteModal item={editingNote} onClose={() => setEditingNote(null)} onSave={(note) => updateItemNote(editingNote.id, note)} />}

                    {/* Regular Items Modal */}
                    {showRegulars && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-y-auto">
                            <div className="glass rounded-3xl p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl scrollbar-thin">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold flex items-center gap-3">
                                        <span className="text-3xl">⭐</span>
                                        <span className="text-gradient">המוצרים הקבועים שלי</span>
                                    </h2>
                                    <button onClick={() => setShowRegulars(false)}
                                        className="w-10 h-10 flex items-center justify-center glass rounded-full text-gray-500 hover:text-red-500 dark:hover:text-red-400 text-2xl hover:scale-110 hover:rotate-90 transition-all">×</button>
                                </div>

                                <p className="text-gray-600 dark:text-gray-400 mb-4 text-sm">
                                    מוצרים שאתה קונה לעתים קרובות, לפי ההיסטוריה שלך:
                                </p>

                                {regularItems.length === 0 ? (
                                    <div className="text-center py-8">
                                        <div className="text-5xl mb-3">📊</div>
                                        <p className="text-gray-500 dark:text-gray-400">אין מספיק היסטוריית קניות</p>
                                        <p className="text-sm text-gray-400 dark:text-gray-500 mt-1">סיים עוד כמה קניות כדי לזהות מוצרים קבועים</p>
                                    </div>
                                ) : (
                                    <>
                                        <div className="space-y-2 mb-6">
                                            {regularItems.map((item, idx) => (
                                                <div key={idx} className="flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 rounded-xl p-3 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-xl">🔄</span>
                                                        <span className="font-medium text-gray-800 dark:text-gray-200 capitalize">{getProductTranslation(item.name, language)}</span>
                                                    </div>
                                                    <div className="text-sm text-gray-500 dark:text-gray-400">
                                                        נקנה {item.count} פעמים
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <button
                                            onClick={addRegularItems}
                                            className="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white px-6 py-4 rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all font-bold text-lg shadow-lg hover:shadow-xl hover:scale-[1.02]"
                                        >
                                            ➕ הוסף את כולם לרשימה
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Calendar & Holidays Modal */}
                    {showCalendar && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-y-auto">
                            <div className="glass rounded-3xl p-6 max-w-md w-full max-h-[95vh] overflow-y-auto shadow-2xl scrollbar-thin">
                                {/* Header */}
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold flex items-center gap-2">
                                        <span className="text-2xl">📅</span>
                                        <span className="text-gradient">{t('calendar')}</span>
                                    </h2>
                                    <button onClick={() => { setShowCalendar(false); setSelectedHoliday(null); }}
                                        className="w-10 h-10 flex items-center justify-center glass rounded-full text-gray-500 hover:text-red-500 dark:hover:text-red-400 text-2xl hover:scale-110 hover:rotate-90 transition-all">×</button>
                                </div>

                                {/* Month Navigation */}
                                <div className="flex items-center justify-between mb-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl p-3">
                                    <button
                                        onClick={() => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1))}
                                        className="w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-xl transition-all"
                                    >
                                        ‹
                                    </button>
                                    <div className="text-center">
                                        <div className="text-lg font-bold">{HEBREW_MONTHS[calendarMonth.getMonth()]}</div>
                                        <div className="text-sm opacity-80">{calendarMonth.getFullYear()}</div>
                                    </div>
                                    <button
                                        onClick={() => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1))}
                                        className="w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-xl transition-all"
                                    >
                                        ›
                                    </button>
                                </div>

                                {/* Days Header */}
                                <div className="grid grid-cols-7 gap-1 mb-2">
                                    {HEBREW_DAYS.map((day, i) => (
                                        <div key={i} className={`text-center text-xs font-bold py-2 ${i === 6 ? 'text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-400'}`}>
                                            {day}
                                        </div>
                                    ))}
                                </div>

                                {/* Calendar Grid */}
                                <div className="grid grid-cols-7 gap-1 mb-4">
                                    {getCalendarDays(calendarMonth).map((day, idx) => {
                                        const holiday = getHolidayForDate(day);
                                        const isToday = day && day.toDateString() === new Date().toDateString();
                                        const isSaturday = day && day.getDay() === 6;

                                        return (
                                            <div
                                                key={idx}
                                                onClick={() => holiday && setSelectedHoliday(holiday)}
                                                className={`
                                                    aspect-square rounded-lg flex flex-col items-center justify-center text-sm relative
                                                    ${!day ? '' : 'cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700'}
                                                    ${isToday ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/30' : ''}
                                                    ${isSaturday ? 'text-blue-600 dark:text-blue-400' : 'text-gray-700 dark:text-gray-300'}
                                                    ${holiday ? 'bg-gradient-to-br from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 font-bold' : ''}
                                                `}
                                            >
                                                {day && (
                                                    <>
                                                        <span className={`${holiday ? 'text-amber-700 dark:text-amber-300' : ''}`}>{day.getDate()}</span>
                                                        {holiday && (
                                                            <span className="text-xs absolute -bottom-0.5">{holiday.icon}</span>
                                                        )}
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* Selected Holiday Details */}
                                {selectedHoliday ? (
                                    <div className="bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl p-4 border-2 border-amber-300 dark:border-amber-700 mb-4">
                                        <div className="flex items-center gap-3 mb-3">
                                            <span className="text-3xl">{selectedHoliday.icon}</span>
                                            <div>
                                                <h3 className="font-bold text-lg text-gray-800 dark:text-white">{selectedHoliday.name}</h3>
                                                <p className="text-sm text-amber-700 dark:text-amber-300">{selectedHoliday.date}</p>
                                            </div>
                                        </div>
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">{selectedHoliday.reminder}</p>

                                        {/* Reminder Days Selector */}
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">תזכורת לקניות לפני:</label>
                                            <div className="flex gap-2 flex-wrap">
                                                {[3, 5, 7, 10, 14].map(days => (
                                                    <button
                                                        key={days}
                                                        onClick={() => setReminderDays(days)}
                                                        className={`px-3 py-1 rounded-full text-sm transition-all ${
                                                            reminderDays === days
                                                                ? 'bg-indigo-500 text-white'
                                                                : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200'
                                                        }`}
                                                    >
                                                        {days} ימים
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Add to Calendar Buttons */}
                                        <div className="space-y-2">
                                            <button
                                                onClick={() => addToGoogleCalendar(selectedHoliday, reminderDays)}
                                                className="w-full flex items-center justify-center gap-2 bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-600 text-gray-800 dark:text-white px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all font-medium"
                                            >
                                                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm6.369 8.648l-1.816 1.244c-.216.148-.504.087-.641-.138l-.858-1.416c-.137-.226-.451-.297-.698-.158l-1.674.938c-.247.139-.547.048-.669-.203l-.795-1.628c-.122-.25-.413-.365-.65-.255l-1.66.77c-.236.11-.512-.018-.616-.284l-.703-1.78c-.103-.267-.391-.401-.642-.3l-1.692.682c-.25.1-.528-.048-.618-.331L6.37 4.107c-.09-.282-.373-.44-.631-.353L4 4.42v14.16c0 .552.448 1 1 1h14c.552 0 1-.448 1-1V8.42l-1.631.228z"/>
                                                </svg>
                                                הוסף ל-Google Calendar
                                            </button>
                                            <button
                                                onClick={() => downloadICSFile(selectedHoliday, reminderDays)}
                                                className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-3 rounded-xl hover:from-indigo-600 hover:to-purple-600 transition-all font-medium"
                                            >
                                                📥 הורד ליומן (iPhone/מחשב)
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    /* Upcoming Holidays List */
                                    <div className="space-y-2">
                                        <h3 className="font-bold text-gray-800 dark:text-white text-sm mb-2">🎉 חגים קרובים:</h3>
                                        {ISRAELI_HOLIDAYS
                                            .filter(h => h.dateObj >= new Date())
                                            .sort((a, b) => a.dateObj - b.dateObj)
                                            .slice(0, 4)
                                            .map((holiday, idx) => {
                                                const daysUntil = Math.ceil((holiday.dateObj - new Date()) / (1000 * 60 * 60 * 24));
                                                return (
                                                    <button
                                                        key={idx}
                                                        onClick={() => {
                                                            setSelectedHoliday(holiday);
                                                            setCalendarMonth(new Date(holiday.dateObj));
                                                        }}
                                                        className="w-full flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-all text-right"
                                                    >
                                                        <span className="text-xl">{holiday.icon}</span>
                                                        <div className="flex-1">
                                                            <div className="font-medium text-gray-800 dark:text-white">{holiday.name}</div>
                                                            <div className="text-xs text-gray-500">{holiday.date}</div>
                                                        </div>
                                                        <span className={`text-xs px-2 py-1 rounded-full ${
                                                            daysUntil <= 7 ? 'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300' :
                                                            daysUntil <= 30 ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300' :
                                                            'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400'
                                                        }`}>
                                                            {daysUntil} ימים
                                                        </span>
                                                    </button>
                                                );
                                            })}
                                    </div>
                                )}

                                {/* Legend */}
                                <div className="mt-4 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                                    <div className="text-xs text-gray-500 dark:text-gray-400 flex flex-wrap gap-3">
                                        <span className="flex items-center gap-1">
                                            <span className="w-3 h-3 rounded bg-amber-200 dark:bg-amber-700"></span> חג
                                        </span>
                                        <span className="flex items-center gap-1">
                                            <span className="w-3 h-3 rounded ring-2 ring-indigo-500"></span> היום
                                        </span>
                                        <span className="flex items-center gap-1">
                                            <span className="text-blue-600">ש׳</span> שבת
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Quantity Selector Modal */}
                    {showQuantitySelector && selectedProduct && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass rounded-3xl p-6 max-w-sm w-full shadow-2xl">
                                <div className="text-center mb-6">
                                    <div className="text-4xl mb-2">{CATEGORIES[selectedProduct.category]?.icon || '🛒'}</div>
                                    <h2 className="text-xl font-bold text-gray-800 dark:text-white">{selectedProduct.name}</h2>
                                    <p className="text-sm text-gray-500 dark:text-gray-400">{CATEGORIES[selectedProduct.category]?.name}</p>
                                </div>

                                {/* Quantity Selector */}
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 text-center">כמות</label>
                                    <div className="flex items-center justify-center gap-4">
                                        <button
                                            onClick={() => setSelectedQuantity(Math.max(0.5, selectedQuantity - (selectedUnit === 'גרם' ? 100 : selectedUnit === 'ק"ג' ? 0.5 : 1)))}
                                            className="w-14 h-14 bg-gray-100 dark:bg-gray-700 rounded-2xl text-2xl font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition-all hover:scale-110"
                                        >
                                            -
                                        </button>
                                        <div className="text-center min-w-[80px]">
                                            <input
                                                type="number"
                                                value={selectedQuantity}
                                                onChange={(e) => setSelectedQuantity(Math.max(0.1, parseFloat(e.target.value) || 1))}
                                                onFocus={(e) => e.target.select()}
                                                className="w-20 text-center text-3xl font-bold bg-transparent border-none outline-none text-gradient"
                                                step={selectedUnit === 'גרם' ? 100 : selectedUnit === 'ק"ג' ? 0.5 : 1}
                                            />
                                        </div>
                                        <button
                                            onClick={() => setSelectedQuantity(selectedQuantity + (selectedUnit === 'גרם' ? 100 : selectedUnit === 'ק"ג' ? 0.5 : 1))}
                                            className="w-14 h-14 btn-gradient text-white rounded-2xl text-2xl font-bold hover:scale-110 transition-all"
                                        >
                                            +
                                        </button>
                                    </div>
                                </div>

                                {/* Unit Selector */}
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 text-center">יחידת מידה</label>
                                    <div className="flex justify-center gap-2 flex-wrap">
                                        {selectedProduct.unitOptions?.map((unit) => (
                                            <button
                                                key={unit}
                                                onClick={() => {
                                                    setSelectedUnit(unit);
                                                    // Reset quantity when changing units
                                                    if (unit === 'גרם') setSelectedQuantity(100);
                                                    else if (unit === 'ק"ג') setSelectedQuantity(1);
                                                    else setSelectedQuantity(1);
                                                }}
                                                className={`px-4 py-2 rounded-xl font-medium transition-all ${
                                                    selectedUnit === unit
                                                        ? 'btn-gradient text-white shadow-lg'
                                                        : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
                                                }`}
                                            >
                                                {unit}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Note Input */}
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">📝 הוסף הערה (אופציונלי):</label>
                                    <input
                                        type="text"
                                        value={selectedNote}
                                        onChange={(e) => setSelectedNote(e.target.value)}
                                        placeholder="לדוגמה: טרי, ללא גלוטן, אורגני..."
                                        className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white focus:border-indigo-400 transition-all"
                                    />
                                </div>

                                {/* Preview */}
                                <div className="bg-indigo-50 dark:bg-indigo-900/30 rounded-xl p-3 mb-6 text-center">
                                    <span className="text-lg font-bold text-indigo-700 dark:text-indigo-300">
                                        {selectedProduct.name} - {selectedQuantity} {selectedUnit}
                                        {selectedNote && <span className="block text-sm mt-1">📝 {selectedNote}</span>}
                                    </span>
                                </div>

                                {/* Buttons */}
                                <div className="flex gap-3">
                                    <button
                                        onClick={addProductWithQuantity}
                                        className="flex-1 btn-gradient text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all"
                                    >
                                        ➕ הוסף לרשימה
                                    </button>
                                    <button
                                        onClick={() => { setShowQuantitySelector(false); setSelectedProduct(null); setSelectedNote(''); }}
                                        className="px-6 py-4 glass border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-all"
                                    >
                                        ביטול
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Confetti Effect */}
                    {confetti && <ConfettiBurst x={confetti.x} y={confetti.y} onComplete={() => setConfetti(null)} />}

                    {/* Family Chat Modal */}
                    {showChat && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white dark:bg-gray-900 rounded-3xl w-full max-w-lg h-[85vh] max-h-[650px] shadow-2xl flex flex-col overflow-hidden">
                                {/* Chat Header - Modern Design */}
                                <div className="p-4 flex items-center justify-between bg-white dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xl shadow-lg">
                                            👨‍👩‍👧‍👦
                                        </div>
                                        <div>
                                            <h2 className="font-bold text-gray-800 dark:text-white">{family?.name}</h2>
                                            <p className="text-xs text-gray-500 dark:text-gray-400">
                                                {activeEditors.length > 0 ? `${activeEditors[0]} מקליד/ה...` : 'צ\'אט משפחתי'}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={async () => {
                                                if ('Notification' in window) {
                                                    if (Notification.permission === 'granted') {
                                                        setNotificationsEnabled(!notificationsEnabled);
                                                    } else if (Notification.permission !== 'denied') {
                                                        const permission = await Notification.requestPermission();
                                                        setNotificationsEnabled(permission === 'granted');
                                                    } else {
                                                        alert('התראות חסומות. אנא אפשר התראות בהגדרות הדפדפן.');
                                                    }
                                                }
                                            }}
                                            className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all ${notificationsEnabled ? 'bg-green-100 dark:bg-green-900/50 text-green-600' : 'bg-gray-100 dark:bg-gray-700 text-gray-500'}`}
                                            title={notificationsEnabled ? 'התראות פעילות' : 'הפעל התראות'}
                                        >
                                            {notificationsEnabled ? '🔔' : '🔕'}
                                        </button>
                                        <button onClick={() => setShowChat(false)} className="w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                {/* Chat Messages - Modern Bubbles */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 scrollbar-thin">
                                    {chatMessages.length === 0 ? (
                                        <div className="text-center py-16">
                                            <div className="w-20 h-20 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center mx-auto mb-4">
                                                <span className="text-4xl">💬</span>
                                            </div>
                                            <p className="text-gray-600 dark:text-gray-300 font-medium">אין הודעות עדיין</p>
                                            <p className="text-sm text-gray-400 dark:text-gray-500 mt-1">שלחו הודעה ראשונה למשפחה!</p>
                                        </div>
                                    ) : (
                                        chatMessages.map(msg => {
                                            const isMe = msg.senderUid === user.uid;
                                            return (
                                                <div key={msg.id} className={`flex ${isMe ? 'justify-start' : 'justify-end'} items-end gap-2`}>
                                                    {isMe && (
                                                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                                            {(msg.senderName || '?')[0]}
                                                        </div>
                                                    )}
                                                    <div className={`max-w-[75%] ${isMe ? 'order-2' : ''}`}>
                                                        {!isMe && <p className="text-xs text-gray-500 dark:text-gray-400 mb-1 mr-2 font-medium">{msg.senderName}</p>}
                                                        <div className={`rounded-2xl p-3 shadow-sm ${
                                                            isMe
                                                                ? 'bg-indigo-500 text-white rounded-bl-md'
                                                                : 'bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-br-md border border-gray-100 dark:border-gray-600'
                                                        }`}>
                                                            {msg.photoUrl && (
                                                                <img src={msg.photoUrl} alt="תמונה" className="rounded-xl mb-2 max-w-full cursor-pointer hover:opacity-90 shadow-sm" onClick={() => window.open(msg.photoUrl, '_blank')} />
                                                            )}
                                                            {msg.text && <p className="text-sm leading-relaxed">{msg.text}</p>}
                                                            <div className={`flex items-center gap-1 mt-1.5 ${isMe ? 'justify-start' : 'justify-end'}`}>
                                                                <p className={`text-xs ${isMe ? 'text-indigo-200' : 'text-gray-400'}`}>
                                                                    {msg.createdAt?.toDate?.().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) || ''}
                                                                </p>
                                                                {isMe && (
                                                                    <span className={`text-xs ${msg.readBy && msg.readBy.some(uid => uid !== msg.senderUid) ? 'text-cyan-300' : 'text-indigo-300'}`}>
                                                                        {msg.readBy && msg.readBy.some(uid => uid !== msg.senderUid) ? '✓✓' : '✓'}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {!isMe && (
                                                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                                            {(msg.senderName || '?')[0]}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })
                                    )}
                                </div>

                                {/* Photo Preview - Improved */}
                                {capturedPhoto && (
                                    <div className="px-4 py-3 bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700">
                                        <div className="relative inline-block">
                                            <img src={capturedPhoto} alt="תצוגה מקדימה" className="h-24 rounded-xl shadow-md" />
                                            <button onClick={() => setCapturedPhoto(null)} className="absolute -top-2 -right-2 w-7 h-7 bg-red-500 text-white rounded-full text-sm flex items-center justify-center shadow-lg hover:bg-red-600 transition-colors">✕</button>
                                        </div>
                                    </div>
                                )}

                                {/* Chat Input - Modern Design */}
                                <div className="p-4 bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700">
                                    <div className="flex items-center gap-3">
                                        <button onClick={startCamera} className="w-11 h-11 rounded-xl bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-all" title="צלם תמונה">
                                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                        </button>
                                        <input
                                            type="text"
                                            value={chatInput}
                                            onChange={e => setChatInput(e.target.value)}
                                            onKeyPress={e => e.key === 'Enter' && sendChatMessage(chatInput, capturedPhoto)}
                                            placeholder="הקלד הודעה..."
                                            className="flex-1 px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 dark:focus:ring-indigo-900/50 transition-all text-sm"
                                        />
                                        <button
                                            onClick={() => sendChatMessage(chatInput, capturedPhoto)}
                                            className="w-11 h-11 bg-indigo-500 hover:bg-indigo-600 rounded-xl flex items-center justify-center text-white transition-all shadow-md hover:shadow-lg"
                                        >
                                            <svg className="w-5 h-5 rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Recipes Modal */}
                    {showRecipes && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass rounded-3xl w-full max-w-2xl max-h-[85vh] shadow-2xl flex flex-col overflow-hidden">
                                {/* Header */}
                                <div className="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-t-3xl">
                                    <div className="flex items-center gap-3">
                                        <span className="text-2xl">🍳</span>
                                        <div>
                                            <h2 className="font-bold text-lg">{t('recipes')}</h2>
                                            <p className="text-xs opacity-80">{t('addToCart')}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button onClick={startRecipeScan} className="px-3 py-1.5 bg-white/20 rounded-lg hover:bg-white/30 transition-colors text-sm font-medium">📷 {t('scanRecipe')}</button>
                                        <button onClick={() => setShowAddRecipe(true)} className="px-3 py-1.5 bg-white/20 rounded-lg hover:bg-white/30 transition-colors text-sm font-medium">+ {t('add')}</button>
                                        <button onClick={() => setShowRecipes(false)} className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/30 transition-colors">✕</button>
                                    </div>
                                </div>

                                {/* Add Recipe Form */}
                                {showAddRecipe && (
                                    <div className="p-4 bg-orange-50 dark:bg-orange-900/20 border-b border-orange-200 dark:border-orange-800">
                                        <div className="mb-3">
                                            <input
                                                type="text"
                                                value={newRecipeName}
                                                onChange={e => setNewRecipeName(e.target.value)}
                                                placeholder={t('recipeNameExample')}
                                                className="w-full px-4 py-3 border-2 border-orange-200 dark:border-orange-700 rounded-xl bg-white dark:bg-gray-800 dark:text-white focus:border-orange-400 transition-all"
                                            />
                                        </div>
                                        <div className="mb-3">
                                            <textarea
                                                value={newRecipeIngredients}
                                                onChange={e => setNewRecipeIngredients(e.target.value)}
                                                placeholder={t('ingredientsExample')}
                                                rows={5}
                                                className="w-full px-4 py-3 border-2 border-orange-200 dark:border-orange-700 rounded-xl bg-white dark:bg-gray-800 dark:text-white focus:border-orange-400 transition-all resize-none"
                                            />
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={saveRecipe} className="flex-1 bg-gradient-to-r from-orange-500 to-amber-500 text-white px-4 py-2 rounded-xl hover:shadow-lg transition-all font-medium">
                                                💾 {t('save')}
                                            </button>
                                            <button onClick={() => { setShowAddRecipe(false); setNewRecipeName(''); setNewRecipeIngredients(''); }} className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-all">
                                                {t('cancel')}
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Recipes List */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin">
                                    {recipes.length === 0 ? (
                                        <div className="text-center py-12">
                                            <div className="text-6xl mb-4">🍳</div>
                                            <p className="text-gray-500 dark:text-gray-400 text-lg">{t('noRecipesSaved')}</p>
                                            <p className="text-sm text-gray-400 dark:text-gray-500 mt-2">{t('identifiedIngredients')}</p>
                                            <button onClick={() => setShowAddRecipe(true)} className="mt-4 bg-gradient-to-r from-orange-500 to-amber-500 text-white px-6 py-2 rounded-xl hover:shadow-lg transition-all font-medium">
                                                + {t('addFirstRecipe')}
                                            </button>
                                        </div>
                                    ) : (
                                        recipes.map(recipe => (
                                            <div key={recipe.id} className="bg-white dark:bg-gray-800 rounded-2xl p-4 border-2 border-orange-100 dark:border-orange-900/50 hover:border-orange-300 dark:hover:border-orange-700 transition-all">
                                                <div className="flex items-start justify-between mb-3">
                                                    <div>
                                                        <h3 className="font-bold text-lg text-gray-800 dark:text-white flex items-center gap-2">
                                                            🍽️ {recipe.name}
                                                        </h3>
                                                        <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                                            {recipe.ingredients?.length || 0} מרכיבים • נוסף ע״י {recipe.createdBy}
                                                        </p>
                                                    </div>
                                                    <button onClick={() => deleteRecipe(recipe.id, recipe.name)} className="text-gray-400 hover:text-red-500 transition-colors p-1">🗑️</button>
                                                </div>
                                                <div className="flex flex-wrap gap-1.5 mb-3">
                                                    {recipe.ingredients?.slice(0, 8).map((ing, idx) => (
                                                        <span key={idx} className="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-2 py-1 rounded-full">
                                                            {ing.quantity > 1 ? `${ing.quantity}× ` : ''}{ing.name}
                                                        </span>
                                                    ))}
                                                    {recipe.ingredients?.length > 8 && (
                                                        <span className="text-xs bg-gray-100 dark:bg-gray-700 text-gray-500 px-2 py-1 rounded-full">
                                                            +{recipe.ingredients.length - 8} עוד
                                                        </span>
                                                    )}
                                                </div>
                                                <button
                                                    onClick={() => addRecipeToCart(recipe)}
                                                    disabled={addingRecipeItems === recipe.id}
                                                    className={`w-full py-3 rounded-xl font-bold transition-all ${addingRecipeItems === recipe.id ? 'bg-gray-300 dark:bg-gray-600 text-gray-500 cursor-wait' : 'bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:shadow-lg hover:scale-[1.02]'}`}
                                                >
                                                    {addingRecipeItems === recipe.id ? (
                                                        <span className="flex items-center justify-center gap-2">
                                                            <span className="animate-spin">⏳</span> מוסיף מרכיבים...
                                                        </span>
                                                    ) : (
                                                        <span>🛒 הוסף הכל לעגלה</span>
                                                    )}
                                                </button>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Recipe Scan Modal */}
                    {showRecipeScan && (
                        <div className="fixed inset-0 bg-black z-[60]">
                            {/* Header - fixed at top */}
                            <div className="fixed top-0 left-0 right-0 flex items-center justify-between p-4 bg-gradient-to-r from-orange-500 to-amber-500 z-[70]">
                                <button onClick={cancelRecipeScan} className="text-white px-4 py-2 font-bold text-lg">ביטול</button>
                                <h2 className="text-white font-bold text-lg">📷 סריקת מתכון</h2>
                                <div className="w-20"></div>
                            </div>

                            {scannedIngredients.length === 0 ? (
                                <>
                                    {/* Video area - full screen behind buttons */}
                                    <div className="fixed inset-0 bg-black pt-16 pb-52">
                                        <video ref={recipeVideoRef} autoPlay playsInline muted className="w-full h-full object-cover" />
                                        {scanningRecipe && (
                                            <div className="absolute inset-0 bg-black/80 flex flex-col items-center justify-center">
                                                <div className="text-5xl mb-4 animate-pulse">🔍</div>
                                                <p className="text-white text-lg mb-4">מזהה מרכיבים...</p>
                                                <div className="w-64 h-3 bg-white/20 rounded-full overflow-hidden">
                                                    <div className="h-full bg-gradient-to-r from-orange-500 to-amber-500 rounded-full transition-all" style={{ width: `${scanProgress}%` }} />
                                                </div>
                                                <p className="text-white/70 text-sm mt-2">{scanProgress}%</p>
                                            </div>
                                        )}
                                    </div>
                                    {/* Buttons area - fixed at bottom with high z-index */}
                                    <div className="fixed bottom-0 left-0 right-0 bg-black/95 p-4 flex flex-col items-center gap-2 z-[70]" style={{ paddingBottom: 'calc(1rem + env(safe-area-inset-bottom, 8px))' }}>
                                        <p className="text-white text-sm text-center">👆 כוון את המצלמה אל רשימת המרכיבים</p>
                                        <button onClick={captureAndScanRecipe} disabled={scanningRecipe}
                                            className="w-18 h-18 rounded-full bg-white border-4 border-orange-400 shadow-2xl flex items-center justify-center disabled:opacity-50">
                                            <div className="w-14 h-14 rounded-full bg-gradient-to-r from-orange-500 to-amber-500 flex items-center justify-center text-white text-xl">
                                                {scanningRecipe ? '⏳' : '📷'}
                                            </div>
                                        </button>
                                        <button onClick={captureAndScanRecipe} disabled={scanningRecipe}
                                            className="w-full py-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-xl font-bold text-lg shadow-lg disabled:opacity-50">
                                            {scanningRecipe ? '⏳ מזהה מרכיבים...' : '📸 לחץ לצילום'}
                                        </button>
                                    </div>
                                </>
                            ) : (
                                <>
                                    {/* Results list area */}
                                    <div className="fixed top-16 left-0 right-0 bottom-36 bg-white dark:bg-gray-900 overflow-y-auto p-4">
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">מרכיבים שזוהו ({scannedIngredients.filter(i => i.selected).length}/{scannedIngredients.length})</label>
                                            <div className="space-y-2">
                                                {scannedIngredients.map((ing, idx) => (
                                                    <div key={idx} onClick={() => toggleScannedIngredient(idx)}
                                                        className={`p-3 rounded-xl border-2 cursor-pointer transition-all ${ing.selected ? 'border-orange-400 bg-orange-50 dark:bg-orange-900/30' : 'border-gray-200 dark:border-gray-700 opacity-50'}`}>
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${ing.selected ? 'border-orange-500 bg-orange-500' : 'border-gray-300'}`}>
                                                                {ing.selected && <span className="text-white text-sm">✓</span>}
                                                            </div>
                                                            <div className="flex-1">
                                                                <p className="font-medium text-gray-800 dark:text-white">{ing.name}</p>
                                                                {ing.quantity > 1 && <p className="text-xs text-gray-500">כמות: {ing.quantity}</p>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    {/* Results buttons - fixed at bottom */}
                                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 space-y-2 z-[70]" style={{ paddingBottom: 'calc(1rem + env(safe-area-inset-bottom, 8px))' }}>
                                        <button onClick={addScannedToCart} disabled={scanningRecipe || scannedIngredients.filter(i => i.selected).length === 0}
                                            className="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold disabled:opacity-50">
                                            {scanningRecipe ? '⏳ מוסיף...' : '🛒 הוסף לעגלה'}
                                        </button>
                                        <button onClick={() => { setScannedIngredients([]); startRecipeScan(); }}
                                            className="w-full py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl">
                                            📷 צלם שוב
                                        </button>
                                    </div>
                                </>
                            )}
                            <canvas ref={recipeCanvasRef} className="hidden" />
                        </div>
                    )}

                    {/* Camera Modal */}
                    {showCamera && (
                        <div className="fixed inset-0 bg-black z-[60] flex flex-col">
                            <div className="flex items-center justify-between p-4 bg-black/50">
                                <button onClick={stopCamera} className="text-white text-lg px-4 py-2">ביטול</button>
                                <h2 className="text-white font-bold">צלם מוצר</h2>
                                <div className="w-16"></div>
                            </div>
                            <div className="flex-1 flex items-center justify-center bg-black">
                                <video ref={videoRef} autoPlay playsInline className="max-w-full max-h-full" />
                            </div>
                            <div className="p-6 bg-black/50 flex justify-center" style={{ paddingBottom: 'calc(1.5rem + env(safe-area-inset-bottom, 1.5rem))' }}>
                                <button onClick={capturePhoto} className="w-20 h-20 rounded-full bg-white border-4 border-gray-300 hover:scale-105 transition-transform flex items-center justify-center">
                                    <div className="w-16 h-16 rounded-full bg-white border-2 border-gray-400"></div>
                                </button>
                            </div>
                            <canvas ref={canvasRef} className="hidden" />
                        </div>
                    )}

                    <div className="max-w-4xl mx-auto">
                        <div className="glass rounded-3xl shadow-xl p-6 mb-6 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-4">
                                    <div className="w-14 h-14 rounded-2xl btn-gradient flex items-center justify-center shadow-lg">
                                        <span className="text-3xl">🛒</span>
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gradient">ListNest</h1>
                                        <div className="flex items-center gap-2 mt-1 flex-wrap">
                                            <button onClick={() => setShowFamilySettings(true)} className="px-3 py-1 rounded-full text-sm font-medium bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-700 dark:from-indigo-900/50 dark:to-purple-900/50 dark:text-indigo-300 hover:scale-105 transition-transform cursor-pointer">
                                                👨‍👩‍👧‍👦 {family?.name}
                                            </button>
                                            <span className="px-2 py-1 rounded-full text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                                                👤 {user.displayName || user.email}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={toggleShoppingMode}
                                        className={`w-10 h-10 rounded-xl flex items-center justify-center text-lg hover:scale-110 transition-all touch-target ${
                                            shoppingMode
                                                ? 'bg-green-500 text-white shadow-lg shadow-green-200 dark:shadow-green-900/50 animate-pulse'
                                                : 'bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-400'
                                        }`}
                                        title={shoppingMode ? t('shoppingModeActive') : t('enableShoppingMode')}
                                        aria-label={shoppingMode ? t('shoppingModeActive') : t('enableShoppingMode')}
                                        aria-pressed={shoppingMode}
                                    >
                                        <span aria-hidden="true">{shoppingMode ? '🛒' : '📱'}</span>
                                    </button>
                                    <button
                                        onClick={() => setShowChat(true)}
                                        className="w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center text-lg hover:scale-110 transition-transform relative touch-target"
                                        title={t('familyChat')}
                                        aria-label={chatMessages.some(msg => msg.senderUid !== user.uid && (!msg.readBy || !msg.readBy.includes(user.uid))) ? `${t('familyChat')} - ${t('newMessages')}` : t('familyChat')}
                                    >
                                        <span aria-hidden="true">💬</span>
                                        {chatMessages.some(msg => msg.senderUid !== user.uid && (!msg.readBy || !msg.readBy.includes(user.uid))) && (
                                            <>
                                                <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse" aria-hidden="true"></span>
                                                <span className="sr-only">{t('newMessages')}</span>
                                            </>
                                        )}
                                    </button>
                                    <button
                                        onClick={toggleDarkMode}
                                        className="w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-lg hover:scale-110 transition-transform touch-target"
                                        aria-label={darkMode ? t('lightMode') : t('darkMode')}
                                        aria-pressed={darkMode}
                                    >
                                        <span aria-hidden="true">{darkMode ? '☀️' : '🌙'}</span>
                                    </button>
                                    <button
                                        onClick={handleLogout}
                                        className="w-10 h-10 rounded-xl bg-red-100 dark:bg-red-900/50 flex items-center justify-center text-lg hover:scale-110 transition-transform text-red-600 dark:text-red-400 touch-target"
                                        title={t('logout')}
                                        aria-label={t('logout')}
                                    >
                                        <span aria-hidden="true">🚪</span>
                                    </button>
                                </div>
                            </div>

                            {/* List Selector - Wrapping Grid */}
                            <div className="flex flex-wrap gap-2 mb-4">
                                {lists.map(list => (
                                    <button
                                        key={list.id}
                                        onClick={() => setCurrentList(list)}
                                        className={`flex items-center gap-1.5 px-3 py-2 rounded-xl transition-all text-sm ${
                                            currentList?.id === list.id
                                                ? 'btn-gradient text-white shadow-lg'
                                                : 'bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200'
                                        }`}
                                    >
                                        <span>{list.icon}</span>
                                        <span className="font-medium">{list.name}</span>
                                        {list.isDefault && <span className="text-xs">⭐</span>}
                                    </button>
                                ))}
                                <button
                                    onClick={() => setShowCreateList(true)}
                                    className="flex items-center gap-1.5 px-3 py-2 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-all text-sm"
                                >
                                    <span>➕</span>
                                    <span className="font-medium">{t('newList')}</span>
                                </button>
                            </div>

                            {/* Active Editors & Shopping Mode Indicator */}
                            {(activeEditors.length > 0 || shoppingMode) && (
                                <div className="flex items-center gap-3 mb-4 flex-wrap">
                                    {shoppingMode && (
                                        <div className="flex items-center gap-2 px-3 py-1.5 bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 rounded-full text-sm font-medium">
                                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                            מצב קניות פעיל
                                        </div>
                                    )}
                                    {activeEditors.length > 0 && (
                                        <div className="flex items-center gap-2 px-3 py-1.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-full text-sm">
                                            <span className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                                            {activeEditors.join(', ')} עורך/ת כרגע
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Quick Actions Bar - 4 icons in a row */}
                            <div className="grid grid-cols-4 gap-2 mb-4">
                                <button
                                    onClick={() => setShowImportWhatsApp(true)}
                                    className="flex flex-col items-center justify-center py-3 rounded-xl bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 hover:bg-green-100 dark:hover:bg-green-900/50 transition-all"
                                >
                                    <span className="text-2xl mb-1">📥</span>
                                    <span className="text-xs font-medium">{t('importList')}</span>
                                </button>
                                <button
                                    onClick={() => setShowSavedLists(true)}
                                    className="flex flex-col items-center justify-center py-3 rounded-xl bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 hover:bg-purple-100 dark:hover:bg-purple-900/50 transition-all relative"
                                >
                                    <span className="text-2xl mb-1">📋</span>
                                    <span className="text-xs font-medium">רשימות</span>
                                    {savedLists.length > 0 && <span className="absolute top-1 right-1 bg-purple-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center">{savedLists.length}</span>}
                                </button>
                                <button
                                    onClick={saveListForReuse}
                                    className="flex flex-col items-center justify-center py-3 rounded-xl bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/50 transition-all"
                                >
                                    <span className="text-2xl mb-1">💾</span>
                                    <span className="text-xs font-medium">שמירה</span>
                                </button>
                                <button
                                    onClick={startPriceScanner}
                                    className="flex flex-col items-center justify-center py-3 rounded-xl bg-cyan-50 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300 hover:bg-cyan-100 dark:hover:bg-cyan-900/50 transition-all"
                                >
                                    <span className="text-2xl mb-1">📸</span>
                                    <span className="text-xs font-medium">מחירים</span>
                                </button>
                            </div>

                            {/* AI Assistant Button */}
                            <button
                                onClick={() => { setShowAIAssistant(true); generateAISuggestions(); }}
                                className="w-full mb-4 flex items-center justify-center gap-3 py-3 px-4 rounded-xl bg-gradient-to-r from-violet-500 to-purple-600 text-white font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all"
                            >
                                <span className="text-2xl">🤖</span>
                                <span>עוזר קניות חכם - הצעות AI</span>
                                <span className="text-lg">✨</span>
                            </button>

                            {/* Holiday Recommendations Banner */}
                            {getHolidayRecommendations().length > 0 && (
                                <div className="mb-4 p-4 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/30 dark:to-orange-900/30 rounded-2xl border border-amber-200 dark:border-amber-700">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <span className="text-xl">{getHolidayRecommendations()[0].icon}</span>
                                            <span className="font-bold text-amber-800 dark:text-amber-200">{getHolidayRecommendations()[0].name} מתקרב!</span>
                                        </div>
                                        <button
                                            onClick={() => setShowHolidayRecommendations(!showHolidayRecommendations)}
                                            className="text-sm text-amber-600 dark:text-amber-400 hover:underline"
                                        >
                                            {showHolidayRecommendations ? 'הסתר' : 'הצג המלצות'}
                                        </button>
                                    </div>
                                    {showHolidayRecommendations && (
                                        <div className="flex flex-wrap gap-2 mt-2">
                                            {getHolidayRecommendations()[0].products.map((product, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => addProduct(product)}
                                                    className="px-3 py-1.5 bg-white dark:bg-gray-800 rounded-lg text-sm font-medium text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/50 transition-all border border-amber-200 dark:border-amber-700"
                                                >
                                                    + {product}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="flex items-center justify-between mb-4">
                                <div className="text-sm text-gray-500 dark:text-gray-400">
                                    {currentList?.icon} {currentList?.name}
                                </div>
                                <button
                                    onClick={() => document.getElementById('shopping-list-section')?.scrollIntoView({ behavior: 'smooth' })}
                                    className="flex items-center gap-2 px-4 py-2 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-xl hover:shadow-lg transition-all border border-indigo-200/50 dark:border-indigo-700/50">
                                    <span className="text-xs text-gray-500 dark:text-gray-400 font-medium">פריטים</span>
                                    <span className="text-xl font-bold text-gradient">{totalItems}</span>
                                </button>
                            </div>

                            {totalItems > 0 && (
                                <div className="bg-gradient-to-r from-indigo-500/10 to-purple-500/10 dark:from-indigo-500/20 dark:to-purple-500/20 rounded-2xl p-4 mb-4">
                                    <div className="flex justify-between mb-2 text-sm">
                                        <span className="text-gray-600 dark:text-gray-300 font-medium">{t('shoppingProgress')}</span>
                                        <span className="font-bold text-gradient">{purchasedCount} / {totalItems}</span>
                                    </div>
                                    <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 overflow-hidden">
                                        <div className="progress-animate h-2.5 rounded-full transition-all duration-700 ease-out"
                                            style={{ width: `${totalItems > 0 ? (purchasedCount / totalItems) * 100 : 0}%` }} />
                                    </div>
                                    {purchasedCount === totalItems && totalItems > 0 && (
                                        <div className="text-center mt-2 text-sm text-green-600 dark:text-green-400 font-medium">🎉 {t('allPurchased')}</div>
                                    )}
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => purchasedCount > 0 ? setShowFinishShopping(true) : alert(t('markPurchased'))}
                                    className="relative overflow-hidden bg-gradient-to-br from-emerald-50 to-green-100 dark:from-emerald-900/30 dark:to-green-900/30 p-4 rounded-2xl border border-emerald-200/50 dark:border-emerald-700/50 card-hover group">
                                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                                    <div className="text-sm text-gray-600 dark:text-gray-400 font-medium">{t('finishShopping')}</div>
                                    <div className="text-3xl my-1">✅</div>
                                    {purchasedCount > 0 ? (
                                        <div className="text-xs text-emerald-600 dark:text-emerald-400 font-semibold">{purchasedCount} {t('itemsPurchased')}</div>
                                    ) : (
                                        <div className="text-xs text-gray-400 dark:text-gray-500">{t('markPurchased')}</div>
                                    )}
                                </button>
                                <button onClick={() => setShowHistory(true)}
                                    className="relative overflow-hidden bg-gradient-to-br from-purple-50 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 p-4 rounded-2xl border border-purple-200/50 dark:border-purple-700/50 card-hover group">
                                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                                    <div className="text-sm text-gray-600 dark:text-gray-400 font-medium">{t('history')}</div>
                                    <div className="text-3xl my-1">📊</div>
                                    <div className="text-xs text-purple-600 dark:text-purple-400 font-semibold">{history.length} {t('purchases')}</div>
                                </button>
                            </div>

                            <div className="mt-4 flex gap-3">
                                <button onClick={() => setShowRecipes(true)}
                                    className="flex-1 bg-gradient-to-r from-orange-500 to-amber-500 text-white px-4 py-3 rounded-lg hover:from-orange-600 hover:to-amber-600 transition-all font-semibold shadow-lg hover:shadow-xl hover:scale-105">
                                    🍳 {t('recipes')}
                                </button>
                                {items.filter(item => !item.purchased).length > 0 && (
                                    <button onClick={exportToWhatsApp}
                                        className="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white px-4 py-3 rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all font-semibold shadow-lg hover:shadow-xl hover:scale-105">
                                        📤 {t('exportList')}
                                    </button>
                                )}
                                {items.length > 0 && (
                                    <button onClick={() => setShowDeleteAllConfirm(true)}
                                        className="flex-1 bg-gradient-to-r from-red-500 to-rose-500 text-white px-4 py-3 rounded-lg hover:from-red-600 hover:to-rose-600 transition-all font-semibold shadow-lg hover:shadow-xl hover:scale-105">
                                        🗑️ {t('deleteAll')}
                                    </button>
                                )}
                            </div>

                            <div className="mt-3 flex gap-2">
                                <button onClick={() => setShowForgottenStats(true)}
                                    className="flex-1 bg-gradient-to-r from-rose-400 to-pink-500 text-white px-4 py-3 rounded-lg hover:from-rose-500 hover:to-pink-600 transition-all font-semibold shadow-lg hover:shadow-xl hover:scale-[1.02] flex items-center justify-center gap-2">
                                    <span>🧠</span>
                                    <span>{t('whatForgot')}</span>
                                    {shoppingStreak > 0 && (
                                        <span className="bg-white/20 px-2 py-0.5 rounded-full text-xs">🔥 {shoppingStreak}</span>
                                    )}
                                </button>
                                <button onClick={() => setShowCalendar(true)}
                                    className="w-14 bg-gradient-to-r from-violet-400 to-purple-500 text-white rounded-lg hover:from-violet-500 hover:to-purple-600 transition-all shadow-lg hover:shadow-xl hover:scale-105 flex items-center justify-center"
                                    title={t('calendar')}>
                                    📅
                                </button>
                            </div>

                            {/* Add Regulars Button */}
                            {regularItems.length > 0 && (
                                <div className="mt-3">
                                    <button onClick={() => setShowRegulars(true)}
                                        className="w-full bg-gradient-to-r from-amber-400 to-orange-500 text-white px-4 py-3 rounded-lg hover:from-amber-500 hover:to-orange-600 transition-all font-semibold shadow-lg hover:shadow-xl hover:scale-[1.02] flex items-center justify-center gap-2">
                                        <span>⭐</span>
                                        <span>הוסף את הקבועים שלי</span>
                                        <span className="bg-white/20 px-2 py-0.5 rounded-full text-xs">{regularItems.length}</span>
                                    </button>
                                </div>
                            )}
                        </div>

                        {searchTerm && (
                            <div className="glass rounded-2xl shadow-xl p-6 mb-6 card-hover">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold dark:text-white flex items-center gap-2">
                                        <span className="text-2xl">🔍</span>
                                        <span className="text-gradient">תוצאות חיפוש</span>
                                    </h2>
                                    <button onClick={() => setSearchTerm('')} className="btn-gradient text-white text-sm px-4 py-2 rounded-full font-medium hover:shadow-lg hover:scale-105 transition-all">נקה חיפוש ✕</button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                    {Object.entries(PRODUCTS).flatMap(([category, products]) =>
                                        products
                                            .filter(product => product.includes(searchTerm))
                                            .map((product, idx) => (
                                                <button key={`${category}-${idx}`} onClick={() => { addProduct(product); setSelectedCategory(category); }}
                                                    className="group relative bg-white dark:bg-gray-800 p-4 rounded-2xl border border-gray-100 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-600 hover:shadow-lg hover:shadow-indigo-100/50 dark:hover:shadow-indigo-900/30 transition-all duration-200 text-right"
                                                >
                                                    <div className="flex items-start gap-3">
                                                        <div className="w-10 h-10 rounded-xl bg-gray-50 dark:bg-gray-700 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                                                            {CATEGORIES[category]?.icon}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-semibold text-gray-700 dark:text-gray-200 text-sm leading-tight mb-1">{getProductTranslation(product, language)}</div>
                                                            <div className="text-xs text-gray-400 dark:text-gray-500">{getCategoryName(category)}</div>
                                                        </div>
                                                        <div className="w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center opacity-0 group-hover:opacity-100 group-hover:bg-indigo-500 transition-all duration-200">
                                                            <svg className="w-3.5 h-3.5 text-gray-400 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}>
                                                                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
                                                            </svg>
                                                        </div>
                                                    </div>
                                                </button>
                                            ))
                                    )}
                                </div>
                                {Object.entries(PRODUCTS).flatMap(([_, products]) => products.filter(p => p.includes(searchTerm))).length === 0 && (
                                    <div className="text-center py-8">
                                        <div className="text-6xl mb-4">🔍</div>
                                        <p className="text-gray-500 dark:text-gray-400 text-lg">{t('noProductsFound')} "<span className="font-bold">{searchTerm}</span>"</p>
                                        <p className="text-sm text-gray-400 dark:text-gray-500 mt-2">{t('tryAnotherSearch')}</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {!selectedCategory && !searchTerm ? (
                            <div className="glass rounded-2xl shadow-xl p-6 mb-6">
                                <h2 className="text-2xl font-bold text-center mb-2 dark:text-white flex items-center justify-center gap-2">
                                    <span className="text-3xl">🏷️</span>
                                    <span className="text-gradient">{t('selectCategory')}</span>
                                </h2>
                                <p className="text-center text-gray-500 dark:text-gray-400 text-sm mb-6">{t('addItemsHint')}</p>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                    {Object.entries(CATEGORIES).map(([key, cat]) => {
                                        const count = items.filter(item => item.category === key && !item.purchased).length;
                                        return (
                                            <button
                                                key={key}
                                                onClick={() => setSelectedCategory(key)}
                                                className="group relative bg-white dark:bg-gray-800 p-5 rounded-2xl border border-gray-100 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-600 hover:shadow-xl hover:shadow-indigo-100/50 dark:hover:shadow-indigo-900/30 transition-all duration-200"
                                            >
                                                <div className="flex flex-col items-center text-center">
                                                    <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600 flex items-center justify-center text-3xl mb-3 group-hover:scale-110 group-hover:shadow-lg transition-all duration-200">
                                                        {cat.icon}
                                                    </div>
                                                    <div className="text-sm font-semibold text-gray-700 dark:text-gray-200">{getCategoryName(key)}</div>
                                                </div>
                                                {count > 0 && (
                                                    <div className="absolute -top-1 -left-1 bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center shadow-md">
                                                        {count}
                                                    </div>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        ) : selectedCategory && !searchTerm && (
                            <>
                                {/* Fixed Back Button at Bottom */}
                                <div className="fixed bottom-32 left-4 right-4 z-40 flex justify-center pointer-events-none">
                                    <button onClick={() => setSelectedCategory(null)}
                                        className="pointer-events-auto btn-gradient text-white px-6 py-3 rounded-full font-bold shadow-2xl hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2 text-lg">
                                        <span>←</span>
                                        <span>{t('backToCategories')}</span>
                                    </button>
                                </div>

                                <div className="glass rounded-2xl shadow-xl mb-6">
                                    {/* Category Header */}
                                    <div className="p-4 border-b border-gray-200 dark:border-gray-700">
                                        <h2 className="text-xl font-bold flex items-center justify-center gap-2 dark:text-white">
                                            <span className="text-3xl">{CATEGORIES[selectedCategory].icon}</span>
                                            <span className="text-gradient">{getCategoryName(selectedCategory)}</span>
                                        </h2>
                                    </div>

                                    {/* Products Grid */}
                                    <div className="p-4">
                                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                            {PRODUCTS[selectedCategory]?.map((product, idx) => (
                                                <button key={idx} onClick={() => addProduct(product)}
                                                    className="group relative bg-white dark:bg-gray-800 p-4 rounded-2xl border border-gray-100 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-600 hover:shadow-lg hover:shadow-indigo-100/50 dark:hover:shadow-indigo-900/30 transition-all duration-200 text-right"
                                                    style={{animationDelay: `${idx * 30}ms`}}
                                                >
                                                <div className="flex items-center justify-between gap-2">
                                                    <div className="w-8 h-8 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center group-hover:bg-indigo-500 group-hover:scale-110 transition-all duration-200">
                                                        <svg className="w-4 h-4 text-gray-400 group-hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}>
                                                            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
                                                        </svg>
                                                    </div>
                                                    <span className="flex-1 font-semibold text-gray-700 dark:text-gray-200 text-sm leading-tight">{getProductTranslation(product, language)}</span>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            </>
                        )}

                        {filteredItems.length > 0 && (
                            <div id="shopping-list-section" className="glass rounded-2xl shadow-xl p-6 mb-6">
                                <h2 className="text-2xl font-bold mb-6 dark:text-white flex items-center gap-3">
                                    <span className="text-3xl">📝</span>
                                    <span className="text-gradient">הרשימה שלי</span>
                                    <span className="btn-gradient text-white text-sm px-3 py-1 rounded-full">{filteredItems.length}</span>
                                </h2>
                                {Object.entries(groupedItems).map(([category, categoryItems]) => (
                                    <div key={category} className="mb-6">
                                        <h3 className="text-lg font-bold text-indigo-700 dark:text-indigo-400 mb-3 pb-2 border-b-2 border-indigo-200/50 dark:border-indigo-700/50 flex items-center gap-2">
                                            <span className="text-2xl">{CATEGORIES[category]?.icon}</span>
                                            {CATEGORIES[category]?.name}
                                            <span className="text-xs bg-indigo-100 dark:bg-indigo-900/50 px-2 py-1 rounded-full">{categoryItems.length}</span>
                                        </h3>
                                        {categoryItems.map(item => (
                                            <SwipeableItem
                                                key={item.id}
                                                className="mb-3 fade-slide-in"
                                                purchased={item.purchased}
                                                onSwipeRight={() => !item.purchased && togglePurchasedWithAnimation(item.id, item.purchased)}
                                                onSwipeLeft={() => !item.purchased && postponeItem(item.id)}
                                            >
                                                <div className={`product-card ${animatingItems.has(item.id) ? 'success-glow' : ''} ${item.purchased ? 'purchased' : ''}`}>
                                                    <div className="flex items-center gap-3" role="group" aria-label={`פריט: ${item.name}`}>
                                                        {/* Checkbox - WCAG 4.1.2 Name, Role, Value */}
                                                        <button
                                                            onClick={(e) => togglePurchasedWithAnimation(item.id, item.purchased, e)}
                                                            aria-label={item.purchased ? `בטל סימון נקנה עבור ${item.name}` : `סמן ${item.name} כנקנה`}
                                                            aria-pressed={item.purchased}
                                                            role="checkbox"
                                                            aria-checked={item.purchased}
                                                            className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center flex-shrink-0 transition-all duration-150 touch-target ${
                                                                item.purchased
                                                                    ? 'bg-emerald-500 border-emerald-500'
                                                                    : 'border-gray-300 dark:border-gray-500 hover:border-emerald-400 hover:bg-emerald-50 dark:hover:bg-emerald-900/20'
                                                            }`}
                                                        >
                                                            {item.purchased && (
                                                                <svg className={`w-4 h-4 text-white ${animatingItems.has(item.id) ? 'check-animate' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3} aria-hidden="true">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                                                                </svg>
                                                            )}
                                                        </button>

                                                        {/* Item Info */}
                                                        <div className="flex-1 min-w-0">
                                                            {editingItemId === item.id ? (
                                                                <input
                                                                    type="text"
                                                                    value={editingItemName}
                                                                    onChange={(e) => setEditingItemName(e.target.value)}
                                                                    onBlur={saveItemName}
                                                                    onKeyDown={(e) => e.key === 'Enter' && saveItemName()}
                                                                    className="inline-edit-input text-base font-medium text-gray-800 dark:text-white"
                                                                    aria-label={`עריכת שם המוצר ${item.name}`}
                                                                    autoFocus
                                                                />
                                                            ) : (
                                                                <div
                                                                    onClick={() => !item.purchased && startEditingItem(item)}
                                                                    className={`text-base font-medium cursor-pointer ${
                                                                        item.purchased
                                                                            ? 'text-gray-400 dark:text-gray-500 line-through'
                                                                            : 'text-gray-800 dark:text-white'
                                                                    }`}
                                                                >
                                                                    {getProductTranslation(item.name, language)}
                                                                </div>
                                                            )}
                                                            <div className="flex items-center gap-1.5 mt-1 flex-wrap">
                                                                {item.note && (
                                                                    <button
                                                                        onClick={() => setEditingNote(item)}
                                                                        className="text-xs bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300 px-2 py-0.5 rounded-md hover:bg-amber-200 dark:hover:bg-amber-900/60 transition-colors"
                                                                    >
                                                                        📝 {item.note.length > 12 ? item.note.substring(0, 12) + '...' : item.note}
                                                                    </button>
                                                                )}
                                                                {item.purchased && item.purchasedBy && (
                                                                    <span className="text-xs text-emerald-600 dark:text-emerald-400 font-medium">
                                                                        ✓ {item.purchasedBy}
                                                                    </span>
                                                                )}
                                                                {item.postponedBy && !item.purchased && (
                                                                    <span className="text-xs text-orange-500 dark:text-orange-400">נדחה</span>
                                                                )}
                                                            </div>
                                                        </div>

                                                        {/* Quantity Stepper - WCAG compliant */}
                                                        <div className="qty-stepper flex-shrink-0" role="group" aria-label={`כמות ${item.name}`}>
                                                            <button
                                                                onClick={() => updateQuantity(item.id, (typeof item.quantity === 'number' ? item.quantity : 1) - 1)}
                                                                aria-label={`הפחת כמות של ${item.name}`}
                                                                className="qty-btn text-gray-500 dark:text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 touch-target"
                                                            >
                                                                <span aria-hidden="true">−</span>
                                                            </button>
                                                            <span className="qty-value text-gray-800 dark:text-white" aria-live="polite" aria-atomic="true">
                                                                {typeof item.quantity === 'string' ? item.quantity : item.quantity}
                                                            </span>
                                                            <button
                                                                onClick={() => updateQuantity(item.id, (typeof item.quantity === 'number' ? item.quantity : 1) + 1)}
                                                                aria-label={`הוסף כמות של ${item.name}`}
                                                                className="qty-btn text-gray-500 dark:text-gray-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 touch-target"
                                                            >
                                                                <span aria-hidden="true">+</span>
                                                            </button>
                                                        </div>

                                                        {/* Actions */}
                                                        <div className="flex items-center gap-1 flex-shrink-0">
                                                            {!item.note && (
                                                                <button
                                                                    onClick={() => setEditingNote(item)}
                                                                    className="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/30 transition-all"
                                                                    title="הוסף הערה"
                                                                >
                                                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                                        <path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                    </svg>
                                                                </button>
                                                            )}
                                                            {/* WCAG 2.5.1 - Postpone button as alternative to swipe gesture */}
                                                            {!item.purchased && (
                                                                <button
                                                                    onClick={() => postponeItem(item.id)}
                                                                    aria-label={`דחה את ${item.name} לסוף הרשימה`}
                                                                    className="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/30 transition-all touch-target"
                                                                    title="דחה לסוף"
                                                                >
                                                                    <span className="text-sm" aria-hidden="true">⏭</span>
                                                                </button>
                                                            )}
                                                            {!item.purchased && !item.outOfStock && shoppingMode && (
                                                                <button
                                                                    onClick={() => markOutOfStock(item)}
                                                                    aria-label={`סמן ${item.name} כאזל מהמלאי`}
                                                                    className="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-orange-500 hover:bg-orange-50 dark:hover:bg-orange-900/30 transition-all touch-target"
                                                                    title="אזל מהמלאי"
                                                                >
                                                                    <span className="text-sm" aria-hidden="true">🚫</span>
                                                                </button>
                                                            )}
                                                            {item.outOfStock && (
                                                                <span className="px-2 py-1 bg-orange-100 dark:bg-orange-900/50 text-orange-600 dark:text-orange-400 text-xs rounded-lg font-medium" role="status">
                                                                    אזל
                                                                </span>
                                                            )}
                                                            <button
                                                                onClick={() => setShowDeleteConfirm(item.id)}
                                                                aria-label={`מחק את ${item.name} מהרשימה`}
                                                                className="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 transition-all touch-target"
                                                                title="מחק"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} aria-hidden="true">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </SwipeableItem>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        )}

                        {filteredItems.length === 0 && !searchTerm && (
                            <div className="glass rounded-2xl shadow-xl p-12 text-center">
                                <div className="text-7xl mb-6 float">🛒</div>
                                <p className="text-2xl text-gradient font-bold mb-2">{t('emptyList')}</p>
                                <p className="text-gray-500 dark:text-gray-400 mt-2">{t('addProductsBelow')}</p>
                            </div>
                        )}

                        {/* Bottom spacing for sticky bar */}
                        <div className="h-24"></div>
                    </div>

                    {/* Sticky Add Bar */}
                    <div className="sticky-add-bar">
                        <div className="max-w-2xl mx-auto flex gap-2 items-center">
                            <div className="relative flex-1">
                                <label htmlFor="product-search" className="sr-only">{t('searchProduct')}</label>
                                <input
                                    id="product-search"
                                    ref={addBarInputRef}
                                    type="text"
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    placeholder={`🔍 ${t('addProductPlaceholder')}`}
                                    aria-label={t('searchProduct')}
                                    aria-autocomplete="list"
                                    className="w-full px-4 py-3 pr-4 pl-12 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-800 dark:text-white focus:border-indigo-500 dark:focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 dark:focus:ring-indigo-900/30 transition-all text-base font-medium placeholder:text-gray-400"
                                />
                                {searchTerm && (
                                    <button
                                        onClick={() => setSearchTerm('')}
                                        className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 text-xl touch-target"
                                        aria-label="נקה שדה חיפוש"
                                    >
                                        <span aria-hidden="true">✕</span>
                                    </button>
                                )}
                            </div>
                            {voiceSupported && (
                                <button
                                    onClick={isListening ? stopListening : startListening}
                                    className={`w-12 h-12 rounded-xl flex items-center justify-center text-xl transition-all touch-target ${
                                        isListening
                                            ? 'bg-red-500 text-white animate-pulse'
                                            : 'bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-200'
                                    }`}
                                    aria-label={isListening ? 'הפסק הקלטה קולית' : 'התחל הקלטה קולית להוספת מוצרים'}
                                    aria-pressed={isListening}
                                >
                                    <span aria-hidden="true">{isListening ? '⏹️' : '🎤'}</span>
                                </button>
                            )}
                        </div>

                        {/* Voice listening indicator - Enhanced */}
                        {isListening && (
                            <div className="max-w-2xl mx-auto mt-2 expand-in">
                                <div className="bg-gradient-to-r from-purple-100 to-indigo-100 dark:from-purple-900/50 dark:to-indigo-900/50 rounded-xl p-4 border-2 border-purple-300 dark:border-purple-700">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <div className="flex items-center h-4">
                                                <span className="sound-wave"></span>
                                                <span className="sound-wave"></span>
                                                <span className="sound-wave"></span>
                                            </div>
                                            <span className="text-sm font-bold text-purple-700 dark:text-purple-300">
                                                {voiceStatus || (voiceLang === 'en-US' ? 'Listening...' : 'מקשיב...')}
                                            </span>
                                        </div>
                                        <button onClick={toggleVoiceLang} className="text-xs px-3 py-1 bg-white dark:bg-gray-800 rounded-full shadow-sm font-medium">
                                            {voiceLang === 'en-US' ? '🇺🇸 English' : '🇮🇱 עברית'}
                                        </button>
                                    </div>
                                    {voiceTranscript && (
                                        <div className="bg-white dark:bg-gray-800 rounded-lg p-3 mt-2">
                                            <p className="text-gray-600 dark:text-gray-300 text-sm">
                                                <span className="text-purple-500">שמעתי:</span> {voiceTranscript}
                                            </p>
                                        </div>
                                    )}
                                    <p className="text-xs text-purple-500 dark:text-purple-400 mt-2 text-center">
                                        💡 טיפ: דבר ברור ואמור "הוסף חלב וביצים"
                                    </p>
                                </div>
                            </div>
                        )}

                        {/* Voice status message (when not listening) */}
                        {!isListening && voiceStatus && voiceStatus !== 'מתחיל...' && (
                            <div className="max-w-2xl mx-auto mt-2 text-center">
                                <p className="text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 rounded-lg py-2 px-4 inline-block">
                                    {voiceStatus}
                                </p>
                            </div>
                        )}

                        {/* Quick add suggestions when searching */}
                        {searchTerm && !isListening && (
                            <div className="max-w-2xl mx-auto mt-2 flex flex-wrap gap-1.5 pb-1">
                                {Object.entries(PRODUCTS)
                                    .flatMap(([cat, prods]) => prods.map(p => ({ name: p, cat })))
                                    .filter(p => p.name.includes(searchTerm))
                                    .slice(0, 6)
                                    .map((p, i) => (
                                        <button
                                            key={i}
                                            onClick={() => addProduct(p.name)}
                                            className="px-2.5 py-1.5 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 rounded-lg text-xs font-medium hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-all expand-in"
                                        >
                                            {CATEGORIES[p.cat]?.icon} {p.name}
                                        </button>
                                    ))}
                                {searchTerm.length >= 2 && !Object.values(PRODUCTS).flat().some(p => p === searchTerm) && (
                                    <button
                                        onClick={() => addProduct(searchTerm)}
                                        className="px-2.5 py-1.5 bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 rounded-lg text-xs font-medium hover:bg-emerald-200 dark:hover:bg-emerald-800 transition-all expand-in"
                                    >
                                        ➕ "{searchTerm}"
                                    </button>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Accessibility Button */}
                    <button
                        onClick={() => setShowAccessibility(true)}
                        className="accessibility-btn"
                        title={t('accessibilitySettings')}
                        aria-label={t('accessibilitySettings')}
                    >
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="4" r="2" fill="white"/>
                            <path d="M19 13v-2c-1.54.02-3.09-.75-4.07-1.83l-1.29-1.43c-.17-.19-.38-.34-.61-.45-.01 0-.01-.01-.02-.01H13c-.35-.2-.75-.3-1.19-.26C10.76 7.11 10 8.04 10 9.09V15c0 1.1.9 2 2 2h5v5h2v-5.5c0-1.1-.9-2-2-2h-3v-3.45c1.29 1.07 3.25 1.94 5 1.95zm-6.17 5c-.41 1.16-1.52 2-2.83 2-1.66 0-3-1.34-3-3 0-1.31.84-2.41 2-2.83V12.1c-2.28.46-4 2.48-4 4.9 0 2.76 2.24 5 5 5 2.42 0 4.44-1.72 4.9-4h-2.07z" fill="white"/>
                        </svg>
                    </button>

                    {/* Help Button */}
                    <button
                        onClick={() => setShowHelp(true)}
                        className="fixed bottom-100 left-4 w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center text-white text-2xl shadow-lg z-[9998] hover:scale-110 transition-transform touch-target"
                        style={{ bottom: '160px' }}
                        title={t('helpAndFeedback')}
                        aria-label={t('helpAndFeedback')}
                    >
                        <span aria-hidden="true">?</span>
                    </button>

                    {/* Accessibility Modal */}
                    {showAccessibility && (
                        <div className="fixed inset-0 bg-black/50 z-[10000] flex items-start justify-center pt-10 overflow-y-auto" onClick={() => setShowAccessibility(false)}>
                            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 mb-10" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                                    <button onClick={() => setShowAccessibility(false)} className="text-2xl text-gray-500 hover:text-gray-700 touch-target" aria-label="סגור תפריט נגישות"><span aria-hidden="true">✕</span></button>
                                    <h2 className="text-xl font-bold text-gray-800 dark:text-white">סרגל נגישות</h2>
                                    <div className="w-8"></div>
                                </div>
                                <div className="p-4 space-y-4">
                                    {/* Skip to content */}
                                    <button onClick={() => { document.querySelector('main, [role="main"], .max-w-4xl')?.scrollIntoView(); setShowAccessibility(false); }}
                                        className="w-full py-3 bg-gray-100 dark:bg-gray-700 rounded-xl font-medium text-gray-800 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                        דלג לתוכן העמוד
                                    </button>

                                    {/* Font Size */}
                                    <div>
                                        <p className="text-sm text-gray-500 dark:text-gray-400 mb-2 text-center">גופן וקישורים</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => updateAccessibility('fontSize', 'large')}
                                                className={`flex-1 py-2 rounded-xl font-medium transition-colors ${accessibilitySettings.fontSize === 'large' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                הגדלת טקסט
                                            </button>
                                            <button onClick={() => updateAccessibility('fontSize', 'small')}
                                                className={`flex-1 py-2 rounded-xl font-medium transition-colors ${accessibilitySettings.fontSize === 'small' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                הקטנת טקסט
                                            </button>
                                            <button onClick={() => updateAccessibility('highlightLinks', !accessibilitySettings.highlightLinks)}
                                                className={`flex-1 py-2 rounded-xl font-medium transition-colors ${accessibilitySettings.highlightLinks ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                הדגש קישורים
                                            </button>
                                        </div>
                                    </div>

                                    {/* Contrast */}
                                    <div>
                                        <p className="text-sm text-gray-500 dark:text-gray-400 mb-2 text-center">צבעים</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => updateAccessibility('contrast', 'low')}
                                                className={`flex-1 py-2 rounded-xl font-medium transition-colors ${accessibilitySettings.contrast === 'low' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                ניגודיות עדינה
                                            </button>
                                            <button onClick={() => updateAccessibility('contrast', 'normal')}
                                                className={`flex-1 py-2 rounded-xl font-medium transition-colors ${accessibilitySettings.contrast === 'normal' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                ניגודיות רגילה
                                            </button>
                                            <button onClick={() => updateAccessibility('contrast', 'high')}
                                                className={`flex-1 py-2 rounded-xl font-medium transition-colors ${accessibilitySettings.contrast === 'high' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                ניגודיות גבוהה
                                            </button>
                                        </div>
                                    </div>

                                    {/* Cursor */}
                                    <div>
                                        <p className="text-sm text-gray-500 dark:text-gray-400 mb-2 text-center">סמן העכבר</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => updateAccessibility('cursorSize', 'large-black')}
                                                className={`flex-1 py-2 rounded-xl font-medium transition-colors ${accessibilitySettings.cursorSize === 'large-black' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                סמן גדול שחור
                                            </button>
                                            <button onClick={() => updateAccessibility('cursorSize', 'normal')}
                                                className={`flex-1 py-2 rounded-xl font-medium transition-colors ${accessibilitySettings.cursorSize === 'normal' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                סמן רגיל
                                            </button>
                                            <button onClick={() => updateAccessibility('cursorSize', 'large-white')}
                                                className={`flex-1 py-2 rounded-xl font-medium transition-colors ${accessibilitySettings.cursorSize === 'large-white' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                סמן גדול לבן
                                            </button>
                                        </div>
                                    </div>

                                    {/* Language Selector */}
                                    <div>
                                        <p className="text-sm text-gray-500 dark:text-gray-400 mb-2 text-center">🌐 שפה / Language</p>
                                        <div className="grid grid-cols-4 gap-2">
                                            <button onClick={() => { if(window.changeAppLanguage) window.changeAppLanguage('he'); }}
                                                className={`py-2 rounded-xl font-medium transition-colors ${localStorage.getItem('appLanguage') === 'he' || !localStorage.getItem('appLanguage') ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                עברית
                                            </button>
                                            <button onClick={() => { if(window.changeAppLanguage) window.changeAppLanguage('en'); }}
                                                className={`py-2 rounded-xl font-medium transition-colors ${localStorage.getItem('appLanguage') === 'en' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                English
                                            </button>
                                            <button onClick={() => { if(window.changeAppLanguage) window.changeAppLanguage('ru'); }}
                                                className={`py-2 rounded-xl font-medium transition-colors ${localStorage.getItem('appLanguage') === 'ru' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                Русский
                                            </button>
                                            <button onClick={() => { if(window.changeAppLanguage) window.changeAppLanguage('ar'); }}
                                                className={`py-2 rounded-xl font-medium transition-colors ${localStorage.getItem('appLanguage') === 'ar' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'}`}>
                                                العربية
                                            </button>
                                        </div>
                                    </div>

                                    {/* Reset */}
                                    <button onClick={resetAccessibility}
                                        className="w-full py-3 bg-gray-200 dark:bg-gray-600 rounded-xl font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                                        איפוס כל ההגדרות
                                    </button>

                                    {/* Footer links */}
                                    <div className="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700">
                                        <button onClick={() => setShowFeedback(true)} className="text-blue-500 hover:underline text-sm">צור קשר</button>
                                        <button onClick={() => alert('אפליקציית ListNest מחויבת לנגישות מלאה לכל המשתמשים.\n\nהאפליקציה תוכננה בהתאם לתקן הישראלי ת"י 5568 ולהנחיות WCAG 2.1 ברמה AA.\n\nלשאלות בנושא נגישות ניתן לפנות אלינו.')} className="text-blue-500 hover:underline text-sm">הצהרת נגישות</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Help Modal */}
                    {showHelp && (
                        <div className="fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center p-4" onClick={() => setShowHelp(false)}>
                            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800">
                                    <button onClick={() => setShowHelp(false)} className="text-2xl text-gray-500 hover:text-gray-700 touch-target" aria-label="סגור חלון עזרה"><span aria-hidden="true">✕</span></button>
                                    <h2 className="text-xl font-bold text-gray-800 dark:text-white">עזרה</h2>
                                    <div className="w-8"></div>
                                </div>
                                <div className="p-4 space-y-4">
                                    <div className="bg-indigo-50 dark:bg-indigo-900/30 rounded-xl p-4">
                                        <h3 className="font-bold text-indigo-800 dark:text-indigo-200 mb-2">🛒 איך להשתמש באפליקציה</h3>
                                        <ul className="text-sm text-indigo-700 dark:text-indigo-300 space-y-2 list-disc list-inside">
                                            <li>בחר קטגוריה ולחץ על מוצר להוספה לרשימה</li>
                                            <li>החלק שמאלה על מוצר לסימון "נקנה"</li>
                                            <li>החלק ימינה או לחץ על ⏭ לדחייה לסוף הרשימה</li>
                                            <li>השתמש בחיפוש או הקלטה קולית להוספה מהירה</li>
                                            <li>שמור רשימות לשימוש חוזר</li>
                                        </ul>
                                    </div>
                                    <div className="bg-purple-50 dark:bg-purple-900/30 rounded-xl p-4">
                                        <h3 className="font-bold text-purple-800 dark:text-purple-200 mb-2">👨‍👩‍👧‍👦 שיתוף עם המשפחה</h3>
                                        <ul className="text-sm text-purple-700 dark:text-purple-300 space-y-2 list-disc list-inside">
                                            <li>שתף קוד, QR, קישור או WhatsApp</li>
                                            <li><strong>הורים (אבא/אמא)</strong> - הרשאות מנהל מלאות</li>
                                            <li><strong>ילדים</strong> - יכולים להוסיף ולסמן מוצרים בלבד</li>
                                            <li>קבל התראות כשמישהו מוסיף מוצר</li>
                                            <li>צ'אט מובנה לתיאום הקניות</li>
                                        </ul>
                                    </div>
                                    <div className="bg-amber-50 dark:bg-amber-900/30 rounded-xl p-4">
                                        <h3 className="font-bold text-amber-800 dark:text-amber-200 mb-2">📷 סריקה חכמה</h3>
                                        <ul className="text-sm text-amber-700 dark:text-amber-300 space-y-2 list-disc list-inside">
                                            <li>סרוק מתכון להוספת מרכיבים אוטומטית</li>
                                            <li>צלם מוצר לזיהוי והשוואת מחירים</li>
                                        </ul>
                                    </div>
                                    <div className="bg-green-50 dark:bg-green-900/30 rounded-xl p-4">
                                        <h3 className="font-bold text-green-800 dark:text-green-200 mb-2">🌐 שפות ונגישות</h3>
                                        <ul className="text-sm text-green-700 dark:text-green-300 space-y-2 list-disc list-inside">
                                            <li>תמיכה בעברית, אנגלית, רוסית וערבית</li>
                                            <li>החלף שפה בכפתור הנגישות (♿)</li>
                                            <li>מצב כהה/בהיר, הגדלת טקסט ועוד</li>
                                        </ul>
                                    </div>
                                    <button onClick={() => { setShowHelp(false); setShowFeedback(true); }}
                                        className="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold hover:opacity-90 transition-opacity">
                                        📧 שלח משוב או דיווח על בעיה
                                    </button>
                                    <button onClick={() => { localStorage.removeItem('hasSeenOnboarding'); setShowHelp(false); setShowOnboarding(true); setOnboardingStep(0); }}
                                        className="w-full py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                        🎓 הצג הדרכה מחדש
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Feedback Modal */}
                    {showFeedback && (
                        <div className="fixed inset-0 bg-black/50 z-[10001] flex items-center justify-center p-4" onClick={() => setShowFeedback(false)}>
                            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                                    <button onClick={() => setShowFeedback(false)} className="text-2xl text-gray-500 hover:text-gray-700">✕</button>
                                    <h2 className="text-xl font-bold text-gray-800 dark:text-white">שלח משוב</h2>
                                    <div className="w-8"></div>
                                </div>
                                {feedbackSent ? (
                                    <div className="p-8 text-center">
                                        <div className="text-5xl mb-4">✅</div>
                                        <p className="text-lg font-medium text-gray-800 dark:text-white">תודה על המשוב!</p>
                                        <p className="text-gray-500 dark:text-gray-400">נחזור אליך בהקדם</p>
                                    </div>
                                ) : (
                                    <div className="p-4 space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">סוג הפנייה</label>
                                            <div className="flex gap-2">
                                                <button onClick={() => setFeedbackType('bug')}
                                                    className={`flex-1 py-2 rounded-xl font-medium transition-colors ${feedbackType === 'bug' ? 'bg-red-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>
                                                    🐛 באג
                                                </button>
                                                <button onClick={() => setFeedbackType('feature')}
                                                    className={`flex-1 py-2 rounded-xl font-medium transition-colors ${feedbackType === 'feature' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>
                                                    💡 בקשה
                                                </button>
                                                <button onClick={() => setFeedbackType('other')}
                                                    className={`flex-1 py-2 rounded-xl font-medium transition-colors ${feedbackType === 'other' ? 'bg-purple-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>
                                                    💬 אחר
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">תיאור</label>
                                            <textarea
                                                value={feedbackText}
                                                onChange={(e) => setFeedbackText(e.target.value)}
                                                placeholder="ספר לנו מה קרה או מה תרצה לראות..."
                                                className="w-full h-32 p-3 border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-800 dark:text-white resize-none focus:ring-2 focus:ring-indigo-500"
                                            />
                                        </div>
                                        <button onClick={sendFeedback} disabled={!feedbackText.trim() || feedbackSending}
                                            className="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-bold disabled:opacity-50 hover:opacity-90 transition-opacity">
                                            {feedbackSending ? '⏳ שולח...' : '📤 שלח'}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Onboarding Modal */}
                    {showOnboarding && (
                        <div className="fixed inset-0 bg-black/70 z-[10002] flex items-center justify-center p-4">
                            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                                {onboardingStep === 0 && (
                                    <div className="p-6 text-center">
                                        <div className="text-6xl mb-4">🛒</div>
                                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-2">ברוכים הבאים ל-ListNest!</h2>
                                        <p className="text-gray-600 dark:text-gray-300 mb-6">רשימת קניות חכמה לכל המשפחה</p>
                                        <button onClick={() => setOnboardingStep(1)} className="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-bold">
                                            בואו נתחיל! →
                                        </button>
                                    </div>
                                )}
                                {onboardingStep === 1 && (
                                    <div className="p-6">
                                        <div className="text-4xl mb-3 text-center">📱</div>
                                        <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2 text-center">הוספת מוצרים</h3>
                                        <div className="bg-indigo-50 dark:bg-indigo-900/30 rounded-xl p-4 mb-4">
                                            <ul className="text-sm text-gray-700 dark:text-gray-300 space-y-2">
                                                <li>📂 <strong>קטגוריות:</strong> בחר קטגוריה ולחץ על מוצר</li>
                                                <li>🔍 <strong>חיפוש:</strong> הקלד שם מוצר בשורת החיפוש</li>
                                                <li>🎤 <strong>קולי:</strong> לחץ על המיקרופון ואמור את המוצר</li>
                                            </ul>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setOnboardingStep(0)} className="flex-1 py-2 bg-gray-100 dark:bg-gray-700 rounded-xl">← הקודם</button>
                                            <button onClick={() => setOnboardingStep(2)} className="flex-1 py-2 bg-indigo-500 text-white rounded-xl">הבא →</button>
                                        </div>
                                    </div>
                                )}
                                {onboardingStep === 2 && (
                                    <div className="p-6">
                                        <div className="text-4xl mb-3 text-center">👆</div>
                                        <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2 text-center">ניהול הרשימה</h3>
                                        <div className="bg-green-50 dark:bg-green-900/30 rounded-xl p-4 mb-4">
                                            <ul className="text-sm text-gray-700 dark:text-gray-300 space-y-2">
                                                <li>👈 <strong>החלקה שמאלה:</strong> סימון "נקנה" ✓</li>
                                                <li>👉 <strong>החלקה ימינה:</strong> דחייה לסוף הרשימה</li>
                                                <li>🔢 <strong>לחיצה על כמות:</strong> שינוי כמות</li>
                                                <li>📝 <strong>לחיצה ארוכה:</strong> עריכת הערה</li>
                                            </ul>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setOnboardingStep(1)} className="flex-1 py-2 bg-gray-100 dark:bg-gray-700 rounded-xl">← הקודם</button>
                                            <button onClick={() => setOnboardingStep(3)} className="flex-1 py-2 bg-indigo-500 text-white rounded-xl">הבא →</button>
                                        </div>
                                    </div>
                                )}
                                {onboardingStep === 3 && (
                                    <div className="p-6">
                                        <div className="text-4xl mb-3 text-center">👨‍👩‍👧‍👦</div>
                                        <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2 text-center">שיתוף משפחתי</h3>
                                        <div className="bg-purple-50 dark:bg-purple-900/30 rounded-xl p-4 mb-4">
                                            <ul className="text-sm text-gray-700 dark:text-gray-300 space-y-2">
                                                <li>📤 <strong>שיתוף:</strong> קוד, QR, WhatsApp או קישור</li>
                                                <li>👨👩 <strong>הורים:</strong> אבא/אמא - הרשאות מנהל מלאות</li>
                                                <li>👦 <strong>ילדים:</strong> יכולים להוסיף ולסמן מוצרים בלבד</li>
                                                <li>🔔 <strong>התראות:</strong> קבל הודעה כשמישהו מוסיף מוצר</li>
                                                <li>💬 <strong>צ'אט:</strong> תקשורת משפחתית בזמן אמת</li>
                                            </ul>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setOnboardingStep(2)} className="flex-1 py-2 bg-gray-100 dark:bg-gray-700 rounded-xl">← הקודם</button>
                                            <button onClick={() => setOnboardingStep(4)} className="flex-1 py-2 bg-indigo-500 text-white rounded-xl">הבא →</button>
                                        </div>
                                    </div>
                                )}
                                {onboardingStep === 4 && (
                                    <div className="p-6 text-center">
                                        <div className="text-6xl mb-4">🎉</div>
                                        <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">מוכנים לקניות!</h3>
                                        <p className="text-gray-600 dark:text-gray-300 mb-4">תמיד אפשר לחזור להדרכה מכפתור העזרה</p>
                                        <div className="flex flex-wrap gap-2 text-xs text-gray-500 dark:text-gray-400 justify-center mb-4">
                                            <span>🌐 עברית | English | Русский | العربية</span>
                                        </div>
                                        <div className="flex gap-2 text-xs text-gray-500 dark:text-gray-400 justify-center mb-4">
                                            <span>♿ נגישות</span>
                                            <span>•</span>
                                            <span>❓ עזרה</span>
                                            <span>•</span>
                                            <span>🌙 מצב כהה</span>
                                        </div>
                                        <button onClick={completeOnboarding} className="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold">
                                            ✨ בואו נתחיל!
                                        </button>
                                    </div>
                                )}
                                {/* Progress dots */}
                                <div className="flex justify-center gap-2 pb-4">
                                    {[0, 1, 2, 3, 4].map(step => (
                                        <div key={step} className={`w-2 h-2 rounded-full transition-colors ${onboardingStep === step ? 'bg-indigo-500' : 'bg-gray-300 dark:bg-gray-600'}`} />
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    </main>
                </div>
            );
        }

        // Main App Content (inside FamilyProvider)
        function AppContent() {
            const { family, loading: familyLoading } = useFamily();

            if (familyLoading) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-6xl mb-4 float">👨‍👩‍👧‍👦</div>
                            <div className="text-xl text-white font-medium">טוען משפחה...</div>
                            <div className="mt-4 w-32 h-1 bg-white/20 rounded-full overflow-hidden mx-auto">
                                <div className="h-full w-1/2 progress-animate rounded-full"></div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!family) {
                return <NoFamilyScreen />;
            }

            return <ShoppingList />;
        }

        // Main App Component
        function App() {
            const { user, loading } = useAuth();

            if (loading) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-6xl mb-4 float">🛒</div>
                            <div className="text-xl text-white font-medium">טוען...</div>
                            <div className="mt-4 w-32 h-1 bg-white/20 rounded-full overflow-hidden mx-auto">
                                <div className="h-full w-1/2 progress-animate rounded-full"></div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <AuthScreen />;
            }

            return (
                <FamilyProvider>
                    <AppContent />
                </FamilyProvider>
            );
        }

        ReactDOM.render(
            <LanguageProvider>
                <AuthProvider>
                    <App />
                </AuthProvider>
            </LanguageProvider>,
            document.getElementById('root')
        );
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
